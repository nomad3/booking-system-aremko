{% extends "admin/change_form.html" %}
{% load static %}

{% block extrastyle %}
    {{ block.super }}
    <style>
        /* ===== ESTILOS RESPONSIVOS PARA FORMULARIO DE RESERVAS ===== */

        /* Variables para breakpoints */
        :root {
            --mobile-breakpoint: 768px;
            --tablet-breakpoint: 1024px;
        }

        /* ===== OPTIMIZACIONES GENERALES ===== */

        /* Hacer que los fieldsets sean m치s compactos en m칩vil */
        @media (max-width: 768px) {
            .module {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            /* Hacer formulario principal m치s compacto */
            .form-row {
                display: flex;
                flex-direction: column;
                margin-bottom: 15px;
            }

            .form-row > div {
                width: 100% !important;
                padding: 0 !important;
            }

            /* Labels m치s visibles */
            .form-row label {
                font-weight: 600;
                font-size: 14px;
                margin-bottom: 5px;
                display: block;
            }

            /* Inputs m치s grandes para t치ctil */
            input[type="text"],
            input[type="number"],
            input[type="date"],
            input[type="time"],
            select,
            textarea {
                font-size: 16px !important; /* Evita zoom autom치tico en iOS */
                padding: 10px !important;
                width: 100% !important;
                box-sizing: border-box;
            }

            /* Autocomplete m치s usable */
            .select2-container {
                width: 100% !important;
            }

            .select2-selection {
                min-height: 44px !important; /* Tama침o m칤nimo t치ctil */
                padding: 8px !important;
            }
        }

        /* ===== INLINES RESPONSIVOS - FORMATO TARJETA ===== */

        @media (max-width: 768px) {
            /* Contenedor de inlines */
            .inline-group {
                margin-bottom: 25px;
            }

            /* T칤tulo de inline m치s visible */
            .inline-group h2 {
                font-size: 18px;
                font-weight: 700;
                padding: 12px;
                background: #417690;
                color: white;
                border-radius: 6px 6px 0 0;
                margin-bottom: 0;
            }

            /* Convertir tabla en layout de tarjetas */
            .inline-group table,
            .inline-group thead,
            .inline-group tbody,
            .inline-group tr,
            .inline-group th,
            .inline-group td {
                display: block;
            }

            /* Ocultar encabezados de tabla */
            .inline-group thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }

            /* Cada fila es una tarjeta */
            .inline-group tbody tr {
                background: white;
                border: 1px solid #ddd;
                border-radius: 8px;
                padding: 15px;
                margin-bottom: 15px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }

            /* Cada celda muestra su label */
            .inline-group td {
                border: none !important;
                padding: 10px 0 !important;
                position: relative;
                padding-left: 0 !important;
            }

            /* Agregar label antes de cada campo usando el texto del th */
            .inline-group td::before {
                content: attr(data-label);
                font-weight: 600;
                font-size: 13px;
                color: #666;
                display: block;
                margin-bottom: 5px;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            /* Inputs en inlines - ancho completo */
            .inline-group input[type="text"],
            .inline-group input[type="number"],
            .inline-group input[type="date"],
            .inline-group input[type="time"],
            .inline-group select,
            .inline-group textarea {
                width: 100% !important;
                font-size: 16px !important;
                padding: 10px !important;
                box-sizing: border-box;
                border: 1px solid #ccc;
                border-radius: 4px;
            }

            /* Select con select2 */
            .inline-group .select2-container {
                width: 100% !important;
            }

            /* Campos readonly */
            .inline-group .readonly {
                background: #f5f5f5;
                padding: 10px;
                border-radius: 4px;
                font-size: 15px;
            }

            /* Ocultar columna de orden (drag handle) */
            .inline-group td.original {
                display: none;
            }

            /* Campo DELETE al final de cada tarjeta */
            .inline-group td:has(input[id*="DELETE"]) {
                border-top: 1px solid #eee;
                padding-top: 15px !important;
                margin-top: 10px;
            }

            .inline-group td:has(input[id*="DELETE"])::before {
                content: 'Eliminar';
                color: #dc3545;
            }

            /* Checkbox de DELETE m치s grande */
            .inline-group input[type="checkbox"][id*="DELETE"] {
                width: 24px;
                height: 24px;
            }

            /* Botones de agregar/eliminar m치s grandes */
            .add-row a,
            .delete-row,
            .inline-deletelink {
                font-size: 14px !important;
                padding: 12px 20px !important;
                min-height: 48px;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                border-radius: 6px;
            }

            /* Bot칩n "Agregar otro" m치s visible */
            .add-row {
                margin: 15px 0;
            }

            .add-row a {
                background: #28a745 !important;
                color: white !important;
                border: none;
                text-decoration: none;
                width: 100%;
                text-align: center;
                font-weight: 600;
                box-shadow: 0 2px 4px rgba(40, 167, 69, 0.3);
            }

            .add-row a:hover {
                background: #218838 !important;
            }

            /* Separador visual entre items */
            .inline-group .dynamic-ventas_reservaservicio_set,
            .inline-group .dynamic-ventas_reservaproducto_set,
            .inline-group .dynamic-ventas_pago_set,
            .inline-group .dynamic-ventas_giftcard_set {
                margin-bottom: 20px;
            }

            /* Header de cada item con n칰mero */
            .inline-group tbody tr h3 {
                font-size: 16px;
                font-weight: 700;
                color: #417690;
                margin-bottom: 15px;
                padding-bottom: 10px;
                border-bottom: 2px solid #e0e0e0;
            }
        }

        /* ===== BOTONES DE ACCI칍N ===== */

        @media (max-width: 768px) {
            /* Botones de submit m치s grandes */
            .submit-row {
                padding: 15px 10px;
                overflow-x: auto;
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
            }

            .submit-row input[type="submit"],
            .submit-row .button,
            .submit-row a {
                font-size: 16px !important;
                padding: 12px 20px !important;
                min-height: 48px;
                flex: 1 1 auto;
                min-width: 140px;
            }

            /* Bot칩n "Guardar" m치s prominente */
            .submit-row input[name="_save"] {
                background: #28a745 !important;
                border-color: #28a745 !important;
                order: -1; /* Aparece primero */
            }
        }

        /* ===== MEJORAS DE USABILIDAD ===== */

        @media (max-width: 768px) {
            /* 츼rea de contenido m치s ancha */
            #content {
                padding: 10px !important;
            }

            /* Breadcrumbs m치s compactos */
            .breadcrumbs {
                font-size: 12px;
                padding: 8px 10px;
                overflow-x: auto;
                white-space: nowrap;
            }

            /* Mensajes de error m치s visibles */
            .errornote,
            .errorlist {
                font-size: 14px !important;
                padding: 12px !important;
                margin-bottom: 15px !important;
            }

            /* Campos readonly m치s compactos */
            .readonly {
                padding: 8px;
                background: #f5f5f5;
                border-radius: 4px;
                margin-bottom: 10px;
            }
        }

        /* ===== OPTIMIZACIONES PARA TABLET ===== */

        @media (min-width: 769px) and (max-width: 1024px) {
            /* En tablets, mantener 2 columnas cuando sea posible */
            .form-row.field-box {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }

            /* Inlines con scroll suave */
            .inline-group {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
        }

        /* ===== INDICADOR VISUAL DE SCROLL ===== */

        @media (max-width: 768px) {
            /* Sombra para indicar que hay contenido scrolleable */
            .inline-group {
                position: relative;
            }

            .inline-group::after {
                content: '';
                position: sticky;
                right: 0;
                top: 0;
                bottom: 0;
                width: 30px;
                background: linear-gradient(to left, rgba(0,0,0,0.1), transparent);
                pointer-events: none;
            }

            /* Ocultar sombra cuando no hay scroll */
            .inline-group.no-scroll::after {
                display: none;
            }
        }

        /* ===== ACCESIBILIDAD T츼CTIL ===== */

        @media (max-width: 768px) {
            /* Aumentar 치rea t치ctil de checkboxes y radios */
            input[type="checkbox"],
            input[type="radio"] {
                width: 20px;
                height: 20px;
                margin: 5px;
            }

            /* Labels de checkbox/radio m치s f치ciles de tocar */
            .vCheckboxLabel {
                padding: 10px;
                display: inline-block;
            }

            /* Espaciado entre elementos t치ctiles */
            .form-row .vCheckboxLabel + .vCheckboxLabel {
                margin-left: 15px;
            }
        }

        /* ===== MODO LANDSCAPE EN M칍VIL ===== */

        @media (max-width: 768px) and (orientation: landscape) {
            /* Optimizar altura en landscape */
            .module {
                max-height: 70vh;
                overflow-y: auto;
            }

            .inline-group h2 {
                position: sticky;
                top: 0;
                z-index: 10;
                background: #f8f9fa;
            }
        }

        /* ===== ESTILOS PARA BOT칍N DE CALENDARIO ===== */
        .calendario-button {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin: 10px 0;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .calendario-button:hover {
            background: #0056b3;
            color: white;
        }

        /* Modal para calendario */
        .calendario-modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
        }

        .calendario-modal-content {
            position: relative;
            background-color: white;
            margin: 2% auto;
            width: 95%;
            height: 90%;
            border-radius: 8px;
            overflow: hidden;
        }

        .calendario-modal-close {
            position: absolute;
            right: 20px;
            top: 15px;
            color: white;
            background: #dc3545;
            border: none;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            z-index: 10000;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        .calendario-modal-close:hover {
            background: #c82333;
        }

        .calendario-modal iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
    </style>
{% endblock %}

{% block content %}
    {{ block.super }}

    <!-- Bot칩n para agregar servicio desde calendario -->
    <div style="margin: 20px 0;">
        <button type="button" class="calendario-button" onclick="abrirCalendarioModal()">
            游늰 Agregar servicio desde calendario
        </button>
    </div>
{% endblock %}

{% block footer %}
    {{ block.super }}

    <!-- Modal para calendario -->
    <div id="calendarioModal" class="calendario-modal">
        <div class="calendario-modal-content">
            <button class="calendario-modal-close" onclick="cerrarCalendarioModal()">&times;</button>
            <iframe id="calendarioFrame" src=""></iframe>
        </div>
    </div>

    <script>
        // Funciones para controlar el modal del calendario
        function abrirCalendarioModal() {
            const modal = document.getElementById('calendarioModal');
            const iframe = document.getElementById('calendarioFrame');

            // URL del calendario con par치metro para modo selecci칩n
            const reservaId = '{{ original.pk|default:"" }}';
            iframe.src = '/ventas/calendario-seleccion/' + (reservaId ? '?reserva_id=' + reservaId : '');

            modal.style.display = 'block';
        }

        function cerrarCalendarioModal() {
            const modal = document.getElementById('calendarioModal');
            const iframe = document.getElementById('calendarioFrame');

            modal.style.display = 'none';
            iframe.src = '';
        }

        // Funci칩n llamada desde el iframe cuando se selecciona un servicio
        function servicioAgregado(success, message) {
            if (success) {
                cerrarCalendarioModal();
                // Recargar la p치gina para mostrar el servicio agregado
                window.location.reload();
            } else {
                alert('Error al agregar servicio: ' + message);
            }
        }

        // Cerrar modal si se hace click fuera de 칠l
        window.onclick = function(event) {
            const modal = document.getElementById('calendarioModal');
            if (event.target == modal) {
                cerrarCalendarioModal();
            }
        }

        // Script para agregar data-labels a las celdas de los inlines (para m칩vil)
        document.addEventListener('DOMContentLoaded', function() {
            if (window.innerWidth <= 768) {
                // Para cada tabla inline
                document.querySelectorAll('.inline-group table').forEach(function(table) {
                    // Obtener los encabezados
                    const headers = Array.from(table.querySelectorAll('thead th')).map(function(th) {
                        return th.textContent.trim();
                    });

                    // Aplicar data-label a cada celda
                    table.querySelectorAll('tbody tr').forEach(function(row) {
                        Array.from(row.querySelectorAll('td')).forEach(function(cell, index) {
                            if (headers[index]) {
                                cell.setAttribute('data-label', headers[index]);
                            }
                        });
                    });
                });

                // Observar cambios din치micos (cuando se agregan nuevas filas)
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        mutation.addedNodes.forEach(function(node) {
                            if (node.nodeType === 1 && node.tagName === 'TR') {
                                const table = node.closest('table');
                                if (table) {
                                    const headers = Array.from(table.querySelectorAll('thead th')).map(function(th) {
                                        return th.textContent.trim();
                                    });

                                    Array.from(node.querySelectorAll('td')).forEach(function(cell, index) {
                                        if (headers[index]) {
                                            cell.setAttribute('data-label', headers[index]);
                                        }
                                    });
                                }
                            }
                        });
                    });
                });

                // Observar cada tbody de inline
                document.querySelectorAll('.inline-group tbody').forEach(function(tbody) {
                    observer.observe(tbody, { childList: true, subtree: true });
                });
            }
        });
    </script>
{% endblock %}