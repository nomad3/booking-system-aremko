{% load humanize %}
{% load static %}
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de GiftCards - Aremko</title>

    <style>
        .stats-container {
            padding: 20px;
            background: #f5f5f5;
        }

        .stats-header {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .stats-header h1 {
            margin: 0 0 10px 0;
            font-size: 2.5rem;
            font-weight: 700;
        }

        .stats-header p {
            margin: 0;
            font-size: 1.1rem;
            opacity: 0.9;
        }

        /* Filtros */
        .filter-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .filter-card h3 {
            margin-top: 0;
            color: #333;
            font-size: 1.3rem;
            margin-bottom: 20px;
        }

        .filter-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: end;
        }

        .filter-group {
            flex: 1;
            min-width: 150px;
        }

        .filter-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
            font-size: 0.9rem;
        }

        .filter-group select,
        .filter-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }

        .btn-filter {
            padding: 10px 25px;
            background: #f5576c;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-filter:hover {
            background: #e0485d;
            transform: translateY(-2px);
        }

        .btn-nav {
            padding: 10px 25px;
            background: #6b7280;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-nav.active {
            background: #f5576c;
            cursor: default;
        }

        .btn-nav:hover:not(.active) {
            background: #556070;
        }

        /* Resumen Cards */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border-left: 4px solid #f5576c;
        }

        .summary-card h4 {
            margin: 0 0 10px 0;
            color: #666;
            font-size: 0.9rem;
            text-transform: uppercase;
            font-weight: 600;
        }

        .summary-card .value {
            font-size: 2rem;
            font-weight: 700;
            color: #333;
        }

        .summary-card .subtitle {
            font-size: 0.85rem;
            color: #999;
            margin-top: 5px;
        }

        /* Chart Cards */
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .chart-card.full-width {
            grid-column: 1 / -1;
        }

        .chart-card h3 {
            margin: 0 0 20px 0;
            color: #333;
            font-size: 1.2rem;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .chart-container {
            position: relative;
            height: 400px;
        }

        .chart-container.small {
            height: 300px;
        }

        /* Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .data-table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #555;
            border-bottom: 2px solid #e9ecef;
        }

        .data-table td {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .chart-grid {
                grid-template-columns: 1fr;
            }

            .filter-row {
                flex-direction: column;
            }

            .filter-group {
                width: 100%;
            }
        }
    </style>
</head>

<body>

    <!-- CONTENT -->
    <div class="stats-container">
        <!-- Header -->
        <div class="stats-header">
            <h1>üéÅ Dashboard de GiftCards</h1>
            <p>{{ periodo_texto }} ‚Ä¢ An√°lisis de ventas y canje de GiftCards</p>
        </div>

        <!-- Navegador de Dashboards -->
        <div class="filter-card" style="margin-bottom: 20px;">
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <a href="{% url 'ventas:analytics_dashboard_ventas' %}?year={{ year }}{% if month %}&month={{ month }}{% endif %}"
                    class="btn-nav">
                    üí∞ Dashboard de Ventas
                </a>
                <a href="{% url 'ventas:analytics_dashboard_operativo' %}?year={{ year }}{% if month %}&month={{ month }}{% endif %}"
                    class="btn-nav">
                    ‚öôÔ∏è Dashboard Operativo
                </a>
                <a href="#" class="btn-nav active">
                    üéÅ Dashboard GiftCards (Actual)
                </a>
            </div>
        </div>

        <!-- Filtros -->
        <div class="filter-card">
            <h3>üîç Filtros</h3>
            <form method="GET" action="{% url 'ventas:analytics_dashboard_giftcards' %}">
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="year">A√±o</label>
                        <select name="year" id="year">
                            {% for y in years_disponibles %}
                            <option value="{{ y }}" {% if y==year %}selected{% endif %}>{{ y }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="filter-group">
                        <label for="month">Mes (opcional)</label>
                        <select name="month" id="month">
                            <option value="">Todos los meses</option>
                            {% for mes in meses %}
                            <option value="{{ mes.numero }}" {% if mes.numero==month %}selected{% endif %}>
                                {{ mes.nombre }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="filter-group">
                        <label for="start_date">Fecha inicio (opcional)</label>
                        <input type="date" name="start_date" id="start_date" value="{{ start_date|default:'' }}">
                    </div>

                    <div class="filter-group">
                        <label for="end_date">Fecha fin (opcional)</label>
                        <input type="date" name="end_date" id="end_date" value="{{ end_date|default:'' }}">
                    </div>

                    <div class="filter-group">
                        <button type="submit" class="btn-filter">Aplicar Filtros</button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Resumen General -->
        <div class="summary-cards">
            <div class="summary-card">
                <h4>üí∞ Ventas Totales</h4>
                <div class="value">${{ resumen.total_ventas|floatformat:0|intcomma }}</div>
                <div class="subtitle">{{ periodo_texto }}</div>
            </div>

            <div class="summary-card">
                <h4>üéüÔ∏è Cantidad Vendida</h4>
                <div class="value">{{ resumen.cantidad_vendida|intcomma }}</div>
                <div class="subtitle">GiftCards emitidas</div>
            </div>

            <div class="summary-card">
                <h4>üéØ Ticket Promedio</h4>
                <div class="value">${{ resumen.ticket_promedio|floatformat:0|intcomma }}</div>
                <div class="subtitle">Promedio por GiftCard</div>
            </div>

            <div class="summary-card" style="border-left-color: #f093fb;">
                <h4>‚è≥ Saldo Por Cobrar</h4>
                <div class="value">${{ resumen.monto_por_cobrar|floatformat:0|intcomma }}</div>
                <div class="subtitle">Monto pendiente de uso</div>
            </div>
        </div>

        <!-- Gr√°ficos -->
        <div class="chart-grid">
            <!-- Ventas por Tipo -->
            <div class="chart-card">
                <h3>üè∑Ô∏è Ventas por Tipo de GiftCard</h3>
                <div class="chart-container small">
                    <canvas id="chartTipo"></canvas>
                </div>
            </div>

            <!-- Estado de Canje -->
            <div class="chart-card">
                <h3>üìä Estado de Canje</h3>
                <div class="chart-container small">
                    <canvas id="chartEstado"></canvas>
                </div>
            </div>

            {% if ventas_mes %}
            <!-- Evoluci√≥n Mensual -->
            <div class="chart-card full-width">
                <h3>üìà Evoluci√≥n Mensual de Ventas</h3>
                <div class="chart-container">
                    <canvas id="chartMensual"></canvas>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Tablas Detalladas -->
        <div class="chart-card">
            <h3>üìã Detalle por Tipo de GiftCard</h3>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Tipo / Servicio</th>
                        <th>Cantidad Vendida</th>
                        <th>Total Ventas</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in ventas_por_tipo %}
                    <tr>
                        <td>{{ item.tipo }}</td>
                        <td>{{ item.cantidad }}</td>
                        <td>${{ item.total|floatformat:0|intcomma }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        // Datos desde Django
        const chartData = {{ chart_data_json| safe }};

        // Configuraci√≥n com√∫n de colores
        const colors = {
            primary: ['#f5576c', '#f093fb', '#667eea', '#4facfe', '#fee140'],
            gradient: ['#f5576c', '#fa709a', '#f093fb', '#a18cd1', '#667eea'],
        };

        // Chart 1: Ventas por Tipo
        if (chartData.ventas_tipo.length > 0) {
            new Chart(document.getElementById('chartTipo'), {
                type: 'doughnut',
                data: {
                    labels: chartData.ventas_tipo.map(item => item.tipo),
                    datasets: [{
                        data: chartData.ventas_tipo.map(item => item.total),
                        backgroundColor: colors.gradient,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const label = context.label || '';
                                    const value = new Intl.NumberFormat('es-CL', {
                                        style: 'currency',
                                        currency: 'CLP',
                                        minimumFractionDigits: 0
                                    }).format(context.parsed);
                                    return `${label}: ${value}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Chart 2: Estado de Canje
        if (chartData.estado_canje.length > 0) {
            new Chart(document.getElementById('chartEstado'), {
                type: 'pie',
                data: {
                    labels: chartData.estado_canje.map(item => item.estado),
                    datasets: [{
                        data: chartData.estado_canje.map(item => item.cantidad),
                        backgroundColor: ['#f093fb', '#10b981', '#ef4444'], // Por cobrar, Cobrado, Vencido
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    return `${label}: ${value} GiftCards`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Chart 3: Mensual (solo si hay datos)
        if (chartData.ventas_mes && chartData.ventas_mes.length > 0) {
            new Chart(document.getElementById('chartMensual'), {
                type: 'line',
                data: {
                    labels: chartData.ventas_mes.map(item => item.mes),
                    datasets: [{
                        label: 'Ventas Mensuales',
                        data: chartData.ventas_mes.map(item => item.total),
                        borderColor: '#f5576c',
                        backgroundColor: 'rgba(245, 87, 108, 0.1)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return new Intl.NumberFormat('es-CL', {
                                        style: 'currency',
                                        currency: 'CLP',
                                        minimumFractionDigits: 0
                                    }).format(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function (value) {
                                    return '$' + (value / 1000).toFixed(0) + 'K';
                                }
                            }
                        }
                    }
                }
            });
        }
    </script>

</body>

</html>