{% extends "ventas/base_public.html" %}
{% load static %}
{% load humanize %}

{% block title %}Regala una Experiencia Aremko - GiftCards Personalizadas{% endblock %}

{% block meta_description %}
<meta name="description" content="Regala momentos inolvidables en Aremko. GiftCards personalizadas con mensajes √∫nicos generados por IA. Tinas calientes, masajes y m√°s.">
{% endblock %}

{% block extra_style %}
<style>
    /* GiftCard Wizard Styles */
    .wizard-container {
        max-width: 900px;
        margin: 0 auto;
        padding: 40px 20px;
    }

    .wizard-header {
        text-align: center;
        margin-bottom: 40px;
    }

    .wizard-header h1 {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--dark-gray);
        margin-bottom: 10px;
    }

    .wizard-header p {
        font-size: 1.1rem;
        color: var(--light-gray);
    }

    /* Progress Bar */
    .wizard-progress {
        margin-bottom: 40px;
    }

    .progress-steps {
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
        margin-bottom: 10px;
    }

    .progress-step {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: #e0e0e0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        color: #999;
        z-index: 2;
        position: relative;
    }

    .progress-step.active {
        background-color: var(--primary-color);
        color: white;
    }

    .progress-step.completed {
        background-color: #4CAF50;
        color: white;
    }

    .progress-line {
        position: absolute;
        top: 50%;
        left: 0;
        width: 100%;
        height: 3px;
        background-color: #e0e0e0;
        z-index: 1;
        transform: translateY(-50%);
    }

    .progress-line-fill {
        height: 100%;
        background-color: var(--primary-color);
        transition: width 0.3s ease;
    }

    /* Wizard Content */
    .wizard-content {
        background-color: white;
        border-radius: 12px;
        padding: 40px;
        box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
    }

    .step-title {
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--dark-gray);
        margin-bottom: 20px;
        text-align: center;
    }

    .step-subtitle {
        font-size: 1.1rem;
        color: var(--light-gray);
        margin-bottom: 30px;
        text-align: center;
    }

    /* Experience Cards */
    .experience-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .experience-card {
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        padding: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
    }

    .experience-card:hover {
        border-color: var(--primary-color);
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .experience-card.selected {
        border-color: var(--primary-color);
        background-color: rgba(160, 82, 45, 0.05);
    }

    .experience-card img {
        width: 100%;
        height: 150px;
        object-fit: cover;
        border-radius: 8px;
        margin-bottom: 15px;
    }

    .experience-card h3 {
        font-size: 1.2rem;
        font-weight: 700;
        color: var(--dark-gray);
        margin-bottom: 10px;
    }

    .experience-card p {
        font-size: 0.9rem;
        color: var(--light-gray);
        margin-bottom: 15px;
    }

    /* Amount Selection */
    .amount-options {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 15px;
        margin-top: 20px;
    }

    .amount-btn {
        padding: 15px 20px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        background-color: white;
        cursor: pointer;
        font-weight: 600;
        font-size: 1.1rem;
        transition: all 0.3s ease;
    }

    .amount-btn:hover {
        border-color: var(--primary-color);
        background-color: rgba(160, 82, 45, 0.05);
    }

    .amount-btn.selected {
        border-color: var(--primary-color);
        background-color: var(--primary-color);
        color: white;
    }

    .custom-amount {
        margin-top: 20px;
        padding: 20px;
        background-color: #f9f9f9;
        border-radius: 8px;
    }

    .custom-amount input {
        font-size: 1.2rem;
        padding: 12px;
        border-radius: 8px;
        border: 2px solid #e0e0e0;
    }

    /* Navigation Buttons */
    .wizard-navigation {
        display: flex;
        justify-content: space-between;
        margin-top: 40px;
    }

    .btn-wizard {
        padding: 12px 30px;
        font-weight: 600;
        font-size: 1.1rem;
        border-radius: 8px;
        transition: all 0.3s ease;
    }

    .btn-wizard-next {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
        color: white;
    }

    .btn-wizard-next:hover {
        background-color: #8B4513;
        border-color: #8B4513;
    }

    .btn-wizard-prev {
        background-color: white;
        border: 2px solid var(--primary-color);
        color: var(--primary-color);
    }

    .btn-wizard-prev:hover {
        background-color: rgba(160, 82, 45, 0.05);
    }

    /* Steps Hidden by Default */
    .wizard-step {
        display: none;
    }

    .wizard-step.active {
        display: block;
    }

    /* Icon Styles */
    .experience-card i {
        font-size: 3rem;
        color: var(--primary-color);
        margin-bottom: 15px;
    }

    /* Mensaje Card Styles */
    .mensaje-card {
        border: 1px solid #e0e0e0;
        transition: all 0.3s ease;
        margin-bottom: 15px;
    }

    .mensaje-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }

    .mensaje-card.border-success {
        border-color: #28a745 !important;
        background-color: rgba(40, 167, 69, 0.05);
    }
</style>
{% endblock %}

{% block content %}
<div class="wizard-container">
    <!-- Header -->
    <div class="wizard-header">
        <h1><i class="fas fa-gift me-2"></i>Regala una Experiencia Inolvidable</h1>
        <p>Crea una GiftCard personalizada con un mensaje √∫nico generado por IA</p>
    </div>

    <!-- Progress Bar -->
    <div class="wizard-progress">
        <div class="progress-steps">
            <div class="progress-line">
                <div class="progress-line-fill" id="progressFill" style="width: 16.67%;"></div>
            </div>
            <div class="progress-step active" data-step="1">1</div>
            <div class="progress-step" data-step="2">2</div>
            <div class="progress-step" data-step="3">3</div>
            <div class="progress-step" data-step="4">4</div>
            <div class="progress-step" data-step="5">5</div>
            <div class="progress-step" data-step="6">6</div>
        </div>
        <div class="text-center mt-2">
            <small class="text-muted">Paso <span id="currentStep">1</span> de 6</small>
        </div>
    </div>

    <!-- Wizard Content -->
    <div class="wizard-content">
        <!-- STEP 1: Seleccionar Experiencia y Monto -->
        <div class="wizard-step active" id="step1">
            <h2 class="step-title">Elige la Experiencia</h2>
            <p class="step-subtitle">Selecciona qu√© experiencia quieres regalar</p>

            <div class="experience-grid" id="experienceGrid">
                {% for exp in experiencias %}
                <div class="experience-card" data-experience="{{ exp.id }}" onclick="selectExperience('{{ exp.id }}')">
                    <i class="fas {% if exp.id == 'tinas' %}fa-hot-tub{% elif exp.id == 'masajes' %}fa-spa{% elif exp.id == 'cabanas' %}fa-home{% elif exp.id == 'ritual_rio' %}fa-water{% elif exp.id == 'celebracion' %}fa-champagne-glasses{% else %}fa-gift{% endif %}"></i>
                    <h3>{{ exp.nombre }}</h3>
                    <p>{{ exp.descripcion }}</p>
                </div>
                {% endfor %}
            </div>

            <div id="amountSelection" style="display:none;">
                <h3 class="text-center mb-3">Selecciona el Monto</h3>
                <div class="amount-options" id="amountOptions"></div>

                <div class="custom-amount">
                    <label class="form-label fw-bold">O ingresa un monto personalizado:</label>
                    <div class="input-group">
                        <span class="input-group-text">$</span>
                        <input type="number" class="form-control custom-amount-input" id="customAmount" placeholder="Ej: 85000" min="10000" step="1000">
                    </div>
                    <small class="text-muted">Monto m√≠nimo: $10.000</small>
                </div>
            </div>
        </div>

        <!-- STEP 2: Datos del Destinatario -->
        <div class="wizard-step" id="step2">
            <h2 class="step-title">Datos del Destinatario</h2>
            <p class="step-subtitle">¬øPara qui√©n es este regalo?</p>

            <form id="destinatarioForm">
                <div class="mb-4">
                    <label class="form-label fw-bold">Nombre o Apodo del Destinatario *</label>
                    <input type="text" class="form-control" id="destinatarioNombre" placeholder="Ej: Mar√≠a" required>
                    <small class="text-muted">Este nombre aparecer√° en el mensaje personalizado</small>
                </div>

                <div class="mb-4">
                    <label class="form-label fw-bold">Relaci√≥n Contigo *</label>
                    <input type="text" class="form-control" id="destinatarioRelacion" placeholder="Ej: esposa, mejor amiga, madre" required>
                    <small class="text-muted">Ayuda a la IA a crear un mensaje m√°s personal</small>
                </div>

                <div class="mb-4">
                    <label class="form-label fw-bold">Email del Destinatario (Opcional)</label>
                    <input type="email" class="form-control" id="destinatarioEmail" placeholder="maria@ejemplo.com">
                    <small class="text-muted">Para enviar la giftcard directamente</small>
                </div>

                <div class="mb-4">
                    <label class="form-label fw-bold">Tel√©fono del Destinatario (Opcional)</label>
                    <input type="tel" class="form-control" id="destinatarioTelefono" placeholder="+56 9 1234 5678">
                </div>
            </form>
        </div>

        <!-- STEP 3: Tipo de Mensaje -->
        <div class="wizard-step" id="step3">
            <h2 class="step-title">Elige el Tipo de Mensaje</h2>
            <p class="step-subtitle">¬øPara qu√© ocasi√≥n es este regalo?</p>

            <div class="experience-grid">
                {% for tipo in tipos_mensaje %}
                <div class="experience-card" data-tipo="{{ tipo.id }}" onclick="selectTipoMensaje('{{ tipo.id }}')">
                    <i class="fas {{ tipo.icono }}"></i>
                    <h3>{{ tipo.nombre }}</h3>
                    <p>{{ tipo.descripcion }}</p>
                </div>
                {% endfor %}
            </div>

            <div class="mt-4">
                <label class="form-label fw-bold">Detalle Especial (Opcional)</label>
                <textarea class="form-control" id="detalleEspecial" rows="3" placeholder="Ej: Celebrando 10 a√±os juntos, siempre me apoya en momentos dif√≠ciles..."></textarea>
                <small class="text-muted">Este detalle har√° el mensaje a√∫n m√°s personal y √∫nico</small>
            </div>
        </div>

        <!-- STEP 4: Generar Mensajes con IA -->
        <div class="wizard-step" id="step4">
            <h2 class="step-title">Mensaje Personalizado</h2>
            <p class="step-subtitle">Elige el mensaje que m√°s te guste generado por IA</p>

            <!-- Loading State -->
            <div id="mensajesLoading" class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <p class="mt-3 text-muted">Generando mensajes personalizados con IA...</p>
            </div>

            <!-- Mensajes Generados -->
            <div id="mensajesContainer" style="display:none;">
                <div id="mensajesList" class="row g-3 mb-4">
                    <!-- Los mensajes se insertar√°n aqu√≠ din√°micamente -->
                </div>

                <!-- Bot√≥n Regenerar -->
                <div class="text-center mb-3">
                    <button type="button" class="btn btn-outline-secondary" onclick="regenerarMensaje()">
                        <i class="fas fa-sync-alt me-2"></i>Generar Otro Mensaje
                    </button>
                </div>

                <!-- Mensaje Seleccionado -->
                <div id="mensajeSeleccionadoDiv" style="display:none;" class="alert alert-success">
                    <strong>Mensaje seleccionado:</strong>
                    <p id="mensajeSeleccionadoText" class="mb-0 mt-2"></p>
                </div>
            </div>

            <!-- Error State -->
            <div id="mensajesError" style="display:none;" class="alert alert-danger">
                <strong>Error al generar mensajes</strong>
                <p id="mensajesErrorText" class="mb-0 mt-2"></p>
                <button type="button" class="btn btn-sm btn-danger mt-2" onclick="generarMensajesIA()">
                    <i class="fas fa-redo me-2"></i>Reintentar
                </button>
            </div>
        </div>

        <!-- STEP 5: Preview (Se implementar√° despu√©s) -->
        <div class="wizard-step" id="step5">
            <h2 class="step-title">Vista Previa</h2>
            <p class="step-subtitle">As√≠ se ver√° tu GiftCard</p>
            <div class="text-center py-5">
                <p class="text-muted">Preview se implementar√° en la siguiente fase</p>
            </div>
        </div>

        <!-- STEP 6: Agregar al Carrito -->
        <div class="wizard-step" id="step6">
            <h2 class="step-title">¬°Tu GiftCard est√° Lista!</h2>
            <p class="step-subtitle">Agr√©gala al carrito para continuar con tu compra</p>

            <div class="text-center py-4">
                <!-- Resumen de la GiftCard -->
                <div class="card mx-auto" style="max-width: 500px;">
                    <div class="card-body">
                        <h5 class="card-title mb-4">
                            <i class="fas fa-gift text-warning me-2"></i>
                            Resumen de tu GiftCard
                        </h5>

                        <div class="text-start">
                            <p class="mb-2">
                                <strong>Experiencia:</strong>
                                <span id="resumen-experiencia"></span>
                            </p>
                            <p class="mb-2">
                                <strong>Para:</strong>
                                <span id="resumen-destinatario"></span>
                            </p>
                            <p class="mb-2">
                                <strong>Email:</strong>
                                <span id="resumen-email"></span>
                            </p>
                            <p class="mb-2">
                                <strong>Mensaje:</strong>
                            </p>
                            <p class="fst-italic text-muted small" id="resumen-mensaje" style="max-height: 100px; overflow-y: auto;">
                            </p>
                            <hr>
                            <p class="mb-0">
                                <strong>Precio:</strong>
                                <span class="text-success fs-4" id="resumen-precio"></span>
                            </p>
                        </div>

                        <div class="mt-4">
                            <button type="button" class="btn btn-warning btn-lg w-100 text-white fw-bold" id="btnAgregarAlCarrito">
                                <i class="fas fa-shopping-cart me-2"></i>
                                Agregar al Carrito
                            </button>
                            <p class="text-muted small mt-3 mb-0">
                                Despu√©s puedes seguir comprando o finalizar tu compra
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Loading state -->
                <div id="loadingCarrito" class="d-none mt-4">
                    <div class="spinner-border text-warning" role="status">
                        <span class="visually-hidden">Agregando al carrito...</span>
                    </div>
                    <p class="mt-2">Agregando al carrito...</p>
                </div>
            </div>
        </div>

        <!-- Navigation Buttons -->
        <div class="wizard-navigation">
            <button type="button" class="btn btn-wizard-prev" id="prevBtn" onclick="previousStep()" style="display:none;">
                <i class="fas fa-arrow-left me-2"></i>Anterior
            </button>
            <div></div> <!-- Spacer -->
            <button type="button" class="btn btn-wizard-next" id="nextBtn" onclick="nextStep()">
                Siguiente<i class="fas fa-arrow-right ms-2"></i>
            </button>
        </div>
    </div>
</div>

<script>
// Wizard State
let wizardData = {
    paso: 1,
    experiencia: null,
    monto: null,
    destinatario: {},
    tipoMensaje: null,
    detalleEspecial: '',
    mensajeSeleccionado: null
};

// Datos de experiencias (desde el backend)
const experiencias = {{ experiencias|safe }};

// Seleccionar Experiencia
function selectExperience(expId) {
    // Remover selecci√≥n anterior
    document.querySelectorAll('.experience-card').forEach(card => {
        card.classList.remove('selected');
    });

    // Seleccionar nueva experiencia
    const card = document.querySelector(`[data-experience="${expId}"]`);
    card.classList.add('selected');

    wizardData.experiencia = expId;

    // Mostrar selector de monto
    const exp = experiencias.find(e => e.id === expId);
    showAmountOptions(exp.montos_sugeridos);

    // Habilitar bot√≥n siguiente
    updateNextButton();
}

// Mostrar opciones de monto
function showAmountOptions(montos) {
    const amountSelection = document.getElementById('amountSelection');
    const amountOptions = document.getElementById('amountOptions');

    amountSelection.style.display = 'block';
    amountOptions.innerHTML = '';

    montos.forEach(monto => {
        const btn = document.createElement('button');
        btn.className = 'amount-btn';
        btn.textContent = `$${monto.toLocaleString('es-CL')}`;
        btn.onclick = () => selectAmount(monto);
        amountOptions.appendChild(btn);
    });
}

// Seleccionar Monto
function selectAmount(amount) {
    // Remover selecci√≥n anterior
    document.querySelectorAll('.amount-btn').forEach(btn => {
        btn.classList.remove('selected');
    });

    // Seleccionar nuevo monto
    event.target.classList.add('selected');
    wizardData.monto = amount;

    // Limpiar custom amount
    document.getElementById('customAmount').value = '';

    updateNextButton();
}

// Monto personalizado
document.getElementById('customAmount')?.addEventListener('input', function() {
    const amount = parseInt(this.value);
    if (amount >= 10000) {
        wizardData.monto = amount;

        // Deseleccionar botones de monto
        document.querySelectorAll('.amount-btn').forEach(btn => {
            btn.classList.remove('selected');
        });

        updateNextButton();
    }
});

// Seleccionar Tipo de Mensaje
function selectTipoMensaje(tipoId) {
    // Remover selecci√≥n anterior
    document.querySelectorAll('[data-tipo]').forEach(card => {
        card.classList.remove('selected');
    });

    // Seleccionar nuevo tipo
    const card = document.querySelector(`[data-tipo="${tipoId}"]`);
    card.classList.add('selected');

    wizardData.tipoMensaje = tipoId;

    updateNextButton();
}

// Actualizar bot√≥n siguiente
function updateNextButton() {
    const nextBtn = document.getElementById('nextBtn');
    const currentStep = wizardData.paso;

    let canProceed = false;

    if (currentStep === 1) {
        canProceed = wizardData.experiencia && wizardData.monto;
    } else if (currentStep === 2) {
        const nombre = document.getElementById('destinatarioNombre')?.value;
        const relacion = document.getElementById('destinatarioRelacion')?.value;
        canProceed = nombre && relacion;
    } else if (currentStep === 3) {
        canProceed = wizardData.tipoMensaje;
    } else if (currentStep === 4) {
        canProceed = wizardData.mensajeSeleccionado !== null;
    } else {
        canProceed = true; // Otros pasos siempre pueden avanzar por ahora
    }

    nextBtn.disabled = !canProceed;
}

// Siguiente Paso
function nextStep() {
    const currentStep = wizardData.paso;

    // Guardar datos del paso actual
    if (currentStep === 2) {
        wizardData.destinatario = {
            nombre: document.getElementById('destinatarioNombre').value,
            relacion: document.getElementById('destinatarioRelacion').value,
            email: document.getElementById('destinatarioEmail').value,
            telefono: document.getElementById('destinatarioTelefono').value
        };
    } else if (currentStep === 3) {
        wizardData.detalleEspecial = document.getElementById('detalleEspecial').value;
    }

    // Avanzar paso
    if (currentStep < 6) {
        wizardData.paso++;
        updateWizardUI();

        // Auto-generar mensajes al llegar a Step 4
        if (wizardData.paso === 4) {
            generarMensajesIA();
        }
    }
}

// Paso Anterior
function previousStep() {
    if (wizardData.paso > 1) {
        wizardData.paso--;
        updateWizardUI();
    }
}

// Actualizar UI del Wizard
function updateWizardUI() {
    const currentStep = wizardData.paso;

    // Ocultar todos los pasos
    document.querySelectorAll('.wizard-step').forEach(step => {
        step.classList.remove('active');
    });

    // Mostrar paso actual
    document.getElementById(`step${currentStep}`).classList.add('active');

    // Actualizar progress bar
    document.querySelectorAll('.progress-step').forEach((step, index) => {
        step.classList.remove('active', 'completed');
        if (index + 1 < currentStep) {
            step.classList.add('completed');
        } else if (index + 1 === currentStep) {
            step.classList.add('active');
        }
    });

    const progressPercentage = ((currentStep - 1) / 5) * 100;
    document.getElementById('progressFill').style.width = `${progressPercentage}%`;
    document.getElementById('currentStep').textContent = currentStep;

    // Mostrar/ocultar bot√≥n anterior
    document.getElementById('prevBtn').style.display = currentStep > 1 ? 'block' : 'none';

    // Actualizar estado del bot√≥n siguiente
    updateNextButton();
}

// Validar inputs en tiempo real
document.getElementById('destinatarioNombre')?.addEventListener('input', updateNextButton);
document.getElementById('destinatarioRelacion')?.addEventListener('input', updateNextButton);

// ============================================
// STEP 4: GENERAR MENSAJES CON IA
// ============================================

// Generar mensajes personalizados con DeepSeek AI
async function generarMensajesIA() {
    console.log('ü§ñ Generando mensajes con IA...');

    // Mostrar loading, ocultar mensajes y errores
    document.getElementById('mensajesLoading').style.display = 'block';
    document.getElementById('mensajesContainer').style.display = 'none';
    document.getElementById('mensajesError').style.display = 'none';

    try {
        const response = await fetch('/ventas/api/giftcard/generar-mensajes/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                tipo_mensaje: wizardData.tipoMensaje,
                nombre: wizardData.destinatario.nombre,
                relacion: wizardData.destinatario.relacion,
                detalle: wizardData.detalleEspecial || '',
                cantidad: 3
            })
        });

        const data = await response.json();

        if (data.success) {
            console.log(`‚úÖ ${data.cantidad_generada} mensajes generados`);
            displayMensajes(data.mensajes);
        } else {
            throw new Error(data.error || 'Error al generar mensajes');
        }
    } catch (error) {
        console.error('‚ùå Error:', error);

        // Mostrar error
        document.getElementById('mensajesLoading').style.display = 'none';
        document.getElementById('mensajesError').style.display = 'block';
        document.getElementById('mensajesErrorText').textContent = error.message;
    }
}

// Mostrar mensajes generados como cards seleccionables
function displayMensajes(mensajes) {
    const container = document.getElementById('mensajesList');
    container.innerHTML = '';

    mensajes.forEach((mensaje, index) => {
        const col = document.createElement('div');
        col.className = 'col-12';

        const card = document.createElement('div');
        card.className = 'card mensaje-card';
        card.style.cursor = 'pointer';
        card.onclick = () => selectMensaje(index, mensaje);

        card.innerHTML = `
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <h6 class="card-subtitle text-muted mb-0">
                        <i class="fas fa-message me-2"></i>Opci√≥n ${index + 1}
                    </h6>
                    <i class="fas fa-check-circle text-success" style="display:none;" id="check-${index}"></i>
                </div>
                <p class="card-text mt-3" style="white-space: pre-wrap;">${mensaje}</p>
            </div>
        `;

        col.appendChild(card);
        container.appendChild(col);
    });

    // Ocultar loading, mostrar mensajes
    document.getElementById('mensajesLoading').style.display = 'none';
    document.getElementById('mensajesContainer').style.display = 'block';
}

// Seleccionar un mensaje
function selectMensaje(index, texto) {
    console.log(`‚úÖ Mensaje ${index + 1} seleccionado`);

    // Guardar en wizardData
    wizardData.mensajeSeleccionado = texto;

    // Actualizar UI - remover selecci√≥n previa
    document.querySelectorAll('.mensaje-card').forEach(card => {
        card.classList.remove('border-success');
        card.style.borderWidth = '1px';
    });

    document.querySelectorAll('[id^="check-"]').forEach(check => {
        check.style.display = 'none';
    });

    // Marcar card seleccionada
    const cards = document.querySelectorAll('.mensaje-card');
    cards[index].classList.add('border-success');
    cards[index].style.borderWidth = '2px';
    document.getElementById(`check-${index}`).style.display = 'block';

    // Mostrar mensaje seleccionado
    document.getElementById('mensajeSeleccionadoText').textContent = texto;
    document.getElementById('mensajeSeleccionadoDiv').style.display = 'block';

    // Habilitar bot√≥n siguiente
    updateNextButton();
}

// Regenerar mensaje (genera 1 mensaje adicional)
async function regenerarMensaje() {
    console.log('üîÑ Regenerando mensaje...');

    try {
        const response = await fetch('/ventas/api/giftcard/regenerar-mensaje/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                tipo_mensaje: wizardData.tipoMensaje,
                nombre: wizardData.destinatario.nombre,
                relacion: wizardData.destinatario.relacion,
                detalle: wizardData.detalleEspecial || ''
            })
        });

        const data = await response.json();

        if (data.success) {
            console.log('‚úÖ Nuevo mensaje generado');

            // Agregar nuevo mensaje al array existente
            const container = document.getElementById('mensajesList');
            const currentMessages = container.children.length;

            const col = document.createElement('div');
            col.className = 'col-12';

            const card = document.createElement('div');
            card.className = 'card mensaje-card';
            card.style.cursor = 'pointer';
            card.onclick = () => selectMensaje(currentMessages, data.mensaje);

            card.innerHTML = `
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="card-subtitle text-muted mb-0">
                            <i class="fas fa-message me-2"></i>Opci√≥n ${currentMessages + 1} <span class="badge bg-info">Nuevo</span>
                        </h6>
                        <i class="fas fa-check-circle text-success" style="display:none;" id="check-${currentMessages}"></i>
                    </div>
                    <p class="card-text mt-3" style="white-space: pre-wrap;">${data.mensaje}</p>
                </div>
            `;

            col.appendChild(card);
            container.appendChild(col);

            // Scroll al nuevo mensaje
            col.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        } else {
            throw new Error(data.error || 'Error al regenerar mensaje');
        }
    } catch (error) {
        console.error('‚ùå Error:', error);
        alert('Error al generar nuevo mensaje: ' + error.message);
    }
}

// Funci√≥n para actualizar el resumen en Step 6
function actualizarResumenStep6() {
    // Obtener el nombre de la experiencia seleccionada
    const expCard = document.querySelector(`.exp-card[data-exp-id="${wizardData.experiencia}"]`);
    const expNombre = expCard ? expCard.querySelector('h5').textContent : '';

    document.getElementById('resumen-experiencia').textContent = expNombre;
    document.getElementById('resumen-destinatario').textContent = wizardData.destinatario.nombre;
    document.getElementById('resumen-email').textContent = wizardData.destinatario.email;
    document.getElementById('resumen-mensaje').textContent = wizardData.mensajeSeleccionado;
    document.getElementById('resumen-precio').textContent = '$' + parseInt(wizardData.monto).toLocaleString('es-CL');
}

// Event listener para el bot√≥n "Agregar al Carrito"
document.getElementById('btnAgregarAlCarrito').addEventListener('click', async function() {
    const btn = this;
    const loadingDiv = document.getElementById('loadingCarrito');

    try {
        // Mostrar loading
        btn.disabled = true;
        loadingDiv.classList.remove('d-none');

        // Obtener el nombre de la experiencia seleccionada
        const expCard = document.querySelector(`.exp-card[data-exp-id="${wizardData.experiencia}"]`);
        const expNombre = expCard ? expCard.querySelector('h5').textContent : 'Experiencia Aremko';

        // Preparar datos para enviar
        const giftcardData = {
            experiencia_id: wizardData.experiencia,
            experiencia_nombre: expNombre,
            precio: wizardData.monto,
            destinatario_nombre: wizardData.destinatario.nombre,
            destinatario_email: wizardData.destinatario.email,
            destinatario_telefono: wizardData.destinatario.telefono || '',
            tipo_mensaje: wizardData.tipoMensaje,
            mensaje_seleccionado: wizardData.mensajeSeleccionado
        };

        console.log('üì§ Enviando GiftCard al carrito:', giftcardData);

        // Enviar al backend
        const response = await fetch('/ventas/api/giftcard/agregar-al-carrito/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(giftcardData)
        });

        const data = await response.json();

        if (data.success) {
            console.log('‚úÖ GiftCard agregada al carrito:', data);

            // Actualizar contador del carrito en navbar (si existe)
            const cartCount = document.getElementById('cartCount');
            if (cartCount) {
                cartCount.textContent = data.cart_count;
            }

            // Mostrar mensaje de √©xito
            alert(`üéâ ¬°GiftCard agregada al carrito!\n\nC√≥digo: ${data.codigo}\n\n¬øDeseas ir al carrito o seguir comprando?`);

            // Redirigir al carrito
            window.location.href = data.redirect_url;
        } else {
            throw new Error(data.error || 'Error al agregar al carrito');
        }

    } catch (error) {
        console.error('‚ùå Error:', error);
        alert('Error al agregar la GiftCard al carrito: ' + error.message);

        // Restaurar bot√≥n
        btn.disabled = false;
        loadingDiv.classList.add('d-none');
    }
});

// Modificar nextStep() para actualizar resumen cuando llega a step 6
const originalNextStep = nextStep;
nextStep = function() {
    const currentStep = wizardData.paso;

    // Llamar funci√≥n original
    originalNextStep();

    // Si llegamos a step 6, actualizar resumen
    if (wizardData.paso === 6) {
        actualizarResumenStep6();
    }
};

// Inicializar
updateNextButton();
</script>
{% endblock %}
