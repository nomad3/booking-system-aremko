{% extends "ventas/base_public.html" %}
{% load static %}
{% load humanize %}

{% block title %}Regala una Experiencia Aremko - GiftCards Personalizadas{% endblock %}

{% block meta_description %}
<meta name="description" content="Regala momentos inolvidables en Aremko. GiftCards personalizadas con mensajes √∫nicos generados por IA. Tinas calientes, masajes y m√°s.">
{% endblock %}

{% block extra_style %}
<style>
    /* GiftCard Wizard Styles */
    .wizard-container {
        max-width: 900px;
        margin: 0 auto;
        padding: 40px 20px;
    }

    .wizard-header {
        text-align: center;
        margin-bottom: 40px;
    }

    .wizard-header h1 {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--dark-gray);
        margin-bottom: 10px;
    }

    .wizard-header p {
        font-size: 1.1rem;
        color: var(--light-gray);
    }

    /* Progress Bar */
    .wizard-progress {
        margin-bottom: 40px;
    }

    .progress-steps {
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
        margin-bottom: 10px;
    }

    .progress-step {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: #e0e0e0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        color: #999;
        z-index: 2;
        position: relative;
    }

    .progress-step.active {
        background-color: var(--primary-color);
        color: white;
    }

    .progress-step.completed {
        background-color: #4CAF50;
        color: white;
    }

    .progress-line {
        position: absolute;
        top: 50%;
        left: 0;
        width: 100%;
        height: 3px;
        background-color: #e0e0e0;
        z-index: 1;
        transform: translateY(-50%);
    }

    .progress-line-fill {
        height: 100%;
        background-color: var(--primary-color);
        transition: width 0.3s ease;
    }

    /* Wizard Content */
    .wizard-content {
        background-color: #ffffff;
        background-image:
            radial-gradient(circle at 1px 1px, rgba(160, 82, 45, 0.02) 1px, transparent 1px);
        background-size: 40px 40px;
        border-radius: 20px;
        padding: 50px 40px;
        box-shadow: 0 4px 25px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(160, 82, 45, 0.08);
    }

    .step-title {
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--dark-gray);
        margin-bottom: 20px;
        text-align: center;
    }

    .step-subtitle {
        font-size: 1.1rem;
        color: var(--light-gray);
        margin-bottom: 30px;
        text-align: center;
    }

    /* Experience Cards */
    .experience-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 25px;
        margin-bottom: 30px;
    }

    .experience-card {
        background: linear-gradient(145deg, #ffffff 0%, #f9f9f9 100%);
        border: 1px solid rgba(160, 82, 45, 0.15);
        border-radius: 16px;
        padding: 25px;
        cursor: pointer;
        transition: all 0.4s ease;
        text-align: center;
        position: relative;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
    }

    .experience-card::before {
        content: '';
        position: absolute;
        top: -2px;
        left: -2px;
        right: -2px;
        bottom: -2px;
        background: linear-gradient(45deg, #A0522D, #D2691E, #CD853F);
        border-radius: 16px;
        opacity: 0;
        transition: opacity 0.4s ease;
        z-index: -1;
    }

    .experience-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 12px 30px rgba(160, 82, 45, 0.15);
    }

    .experience-card:hover::before {
        opacity: 0.15;
    }

    .experience-card.selected {
        background: linear-gradient(145deg, #fff8f0 0%, #ffe8d6 100%);
        border-color: var(--primary-color);
        box-shadow: 0 8px 25px rgba(160, 82, 45, 0.2);
    }

    .experience-card.selected::before {
        opacity: 0.2;
    }

    .experience-card img {
        width: 100%;
        height: 150px;
        object-fit: cover;
        border-radius: 8px;
        margin-bottom: 15px;
    }

    .experience-card h5 {
        font-size: 1.3rem;
        font-weight: 700;
        color: #5C4033;
        margin-bottom: 10px;
        margin-top: 15px;
    }

    .experience-card p {
        font-size: 0.95rem;
        color: #7a6a5a;
        margin-bottom: 15px;
        line-height: 1.5;
    }

    /* Precio con estilo elegante */
    .experience-card .price-tag {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        font-size: 1.6rem !important;
        font-weight: 800 !important;
        margin-top: 15px;
        padding: 8px 20px;
        border-radius: 30px;
        display: inline-block;
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .experience-card .price-tag::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        transition: left 0.5s ease;
    }

    .experience-card:hover .price-tag::before {
        left: 100%;
    }

    .experience-card:hover .price-tag {
        transform: scale(1.05);
        box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
    }

    /* Amount Selection */
    .amount-options {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 15px;
        margin-top: 20px;
    }

    .amount-btn {
        padding: 15px 20px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        background-color: white;
        cursor: pointer;
        font-weight: 600;
        font-size: 1.1rem;
        transition: all 0.3s ease;
    }

    .amount-btn:hover {
        border-color: var(--primary-color);
        background-color: rgba(160, 82, 45, 0.05);
    }

    .amount-btn.selected {
        border-color: var(--primary-color);
        background-color: var(--primary-color);
        color: white;
    }

    .custom-amount {
        margin-top: 20px;
        padding: 20px;
        background-color: #f9f9f9;
        border-radius: 8px;
    }

    .custom-amount input {
        font-size: 1.2rem;
        padding: 12px;
        border-radius: 8px;
        border: 2px solid #e0e0e0;
    }

    /* Navigation Buttons */
    .wizard-navigation {
        display: flex;
        justify-content: space-between;
        margin-top: 40px;
    }

    .btn-wizard {
        padding: 12px 30px;
        font-weight: 600;
        font-size: 1.1rem;
        border-radius: 8px;
        transition: all 0.3s ease;
    }

    .btn-wizard-next {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
        color: white;
    }

    .btn-wizard-next:hover {
        background-color: #8B4513;
        border-color: #8B4513;
    }

    .btn-wizard-prev {
        background-color: white;
        border: 2px solid var(--primary-color);
        color: var(--primary-color);
    }

    .btn-wizard-prev:hover {
        background-color: rgba(160, 82, 45, 0.05);
    }

    /* Steps Hidden by Default */
    .wizard-step {
        display: none;
    }

    .wizard-step.active {
        display: block;
    }

    /* Icon Styles */
    .experience-card i {
        font-size: 3.5rem;
        margin-bottom: 20px;
        display: inline-block;
        background: linear-gradient(135deg, #A0522D 0%, #D2691E 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        filter: drop-shadow(0 4px 8px rgba(160, 82, 45, 0.3));
        transition: all 0.3s ease;
    }

    .experience-card:hover i {
        transform: scale(1.1) rotate(5deg);
        filter: drop-shadow(0 6px 12px rgba(160, 82, 45, 0.4));
    }

    /* Animaci√≥n de entrada */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .experience-card {
        animation: fadeInUp 0.6s ease-out;
        animation-fill-mode: both;
    }

    /* Retraso escalonado para animaci√≥n */
    .category-group:nth-child(1) .experience-card:nth-child(1) { animation-delay: 0.1s; }
    .category-group:nth-child(1) .experience-card:nth-child(2) { animation-delay: 0.2s; }
    .category-group:nth-child(1) .experience-card:nth-child(3) { animation-delay: 0.3s; }

    /* Colores espec√≠ficos por categor√≠a */
    .experience-card[data-experience*="tina"] i {
        background: linear-gradient(135deg, #2E86AB 0%, #4ECDC4 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .experience-card[data-experience*="masaje"] i {
        background: linear-gradient(135deg, #B8336A 0%, #E63946 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .experience-card[data-experience*="alojamiento"] i {
        background: linear-gradient(135deg, #2A9D8F 0%, #264653 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .experience-card[data-experience*="celebracion"] i,
    .experience-card[data-experience*="cumpleanos"] i {
        background: linear-gradient(135deg, #F77F00 0%, #FCBF49 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    /* Mensaje Card Styles */
    .mensaje-card {
        border: 1px solid #e0e0e0;
        transition: all 0.3s ease;
        margin-bottom: 15px;
    }

    .mensaje-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }

    .mensaje-card.border-success {
        border-color: #28a745 !important;
        background-color: rgba(40, 167, 69, 0.05);
    }

    /* Category Group Styles */
    .category-group {
        padding: 30px 0;
        position: relative;
    }

    .category-group::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 80%;
        height: 1px;
        background: linear-gradient(90deg, transparent 0%, rgba(160, 82, 45, 0.2) 50%, transparent 100%);
    }

    .category-group:last-child::after {
        display: none;
    }

    .category-title {
        font-size: 1.8rem;
        font-weight: 800;
        margin-bottom: 35px;
        text-transform: uppercase;
        letter-spacing: 2px;
        position: relative;
        display: inline-block;
        width: 100%;
        background: linear-gradient(135deg, #5C4033 0%, #A0522D 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .category-title i {
        font-size: 1.6rem;
        margin-right: 12px;
        opacity: 0.9;
    }

    /* Estilos espec√≠ficos por categor√≠a */
    .category-group:nth-child(1) .category-title {
        background: linear-gradient(135deg, #2E86AB 0%, #4ECDC4 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .category-group:nth-child(2) .category-title {
        background: linear-gradient(135deg, #B8336A 0%, #E63946 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .category-group:nth-child(3) .category-title {
        background: linear-gradient(135deg, #2A9D8F 0%, #264653 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .category-group:nth-child(4) .category-title {
        background: linear-gradient(135deg, #F77F00 0%, #FCBF49 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    /* Mobile responsiveness for categories */
    @media (max-width: 768px) {
        .category-title {
            font-size: 1.3rem;
        }

        .experience-grid {
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .experience-card {
            padding: 15px;
        }

        .experience-card h3 {
            font-size: 1rem;
        }

        .experience-card i {
            font-size: 2.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="wizard-container">
    <!-- Header -->
    <div class="wizard-header">
        <h1><i class="fas fa-gift me-2"></i>Regala una Experiencia Inolvidable</h1>
        <p>Crea una GiftCard personalizada con un mensaje √∫nico</p>
    </div>

    <!-- Progress Bar -->
    <div class="wizard-progress">
        <div class="progress-steps">
            <div class="progress-line">
                <div class="progress-line-fill" id="progressFill" style="width: 14.28%;"></div>
            </div>
            <div class="progress-step active" data-step="1">1</div>
            <div class="progress-step" data-step="2">2</div>
            <div class="progress-step" data-step="3">3</div>
            <div class="progress-step" data-step="4">4</div>
            <div class="progress-step" data-step="5">5</div>
            <div class="progress-step" data-step="6">6</div>
            <div class="progress-step" data-step="7">7</div>
        </div>
        <div class="text-center mt-2">
            <small class="text-muted">Paso <span id="currentStep">1</span> de 7</small>
        </div>
    </div>

    <!-- Wizard Content -->
    <div class="wizard-content">
        <!-- STEP 1: Seleccionar Experiencia y Monto -->
        <div class="wizard-step active" id="step1">
            <h2 class="step-title">Elige la Experiencia</h2>
            <p class="step-subtitle">Selecciona qu√© experiencia quieres regalar</p>

            <!-- Grupo TINAS -->
            <div class="category-group mb-4">
                <h3 class="category-title text-center mb-3">
                    <i class="fas fa-hot-tub me-2"></i>TINAS
                </h3>
                <div class="experience-grid" id="experienceGrid">
                    {% for exp in experiencias %}
                    {% if exp.categoria == 'tinas' %}
                    <div class="experience-card exp-card" data-experience="{{ exp.id }}" data-exp-id="{{ exp.id }}" onclick="selectExperience('{{ exp.id }}')">
                        <i class="fas fa-hot-tub"></i>
                        <h5>{{ exp.nombre }}</h5>
                        <p>{{ exp.descripcion }}</p>
                        {% if exp.monto_fijo %}
                        <div class="price-tag">${{ exp.monto_fijo|floatformat:0|intcomma }}</div>
                        {% endif %}
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>

            <!-- Grupo MASAJES -->
            <div class="category-group mb-4">
                <h3 class="category-title text-center mb-3">
                    <i class="fas fa-spa me-2"></i>MASAJES
                </h3>
                <div class="experience-grid">
                    {% for exp in experiencias %}
                    {% if exp.categoria == 'masajes' %}
                    <div class="experience-card exp-card" data-experience="{{ exp.id }}" data-exp-id="{{ exp.id }}" onclick="selectExperience('{{ exp.id }}')">
                        <i class="fas fa-spa"></i>
                        <h5>{{ exp.nombre }}</h5>
                        <p>{{ exp.descripcion }}</p>
                        {% if exp.monto_fijo %}
                        <div class="price-tag">${{ exp.monto_fijo|floatformat:0|intcomma }}</div>
                        {% endif %}
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>

            <!-- Grupo ALOJAMIENTOS -->
            <div class="category-group mb-4">
                <h3 class="category-title text-center mb-3">
                    <i class="fas fa-bed me-2"></i>ALOJAMIENTOS
                </h3>
                <div class="experience-grid">
                    {% for exp in experiencias %}
                    {% if exp.categoria == 'alojamientos' %}
                    <div class="experience-card exp-card" data-experience="{{ exp.id }}" data-exp-id="{{ exp.id }}" onclick="selectExperience('{{ exp.id }}')">
                        <i class="fas fa-bed"></i>
                        <h5>{{ exp.nombre }}</h5>
                        <p>{{ exp.descripcion }}</p>
                        {% if exp.monto_fijo %}
                        <div class="price-tag">${{ exp.monto_fijo|floatformat:0|intcomma }}</div>
                        {% endif %}
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>

            <!-- Grupo CELEBRACIONES -->
            <div class="category-group mb-4">
                <h3 class="category-title text-center mb-3">
                    <i class="fas fa-champagne-glasses me-2"></i>CELEBRACIONES
                </h3>
                <div class="experience-grid">
                    {% for exp in experiencias %}
                    {% if exp.categoria == 'celebraciones' %}
                    <div class="experience-card exp-card" data-experience="{{ exp.id }}" data-exp-id="{{ exp.id }}" onclick="selectExperience('{{ exp.id }}')">
                        <i class="fas fa-champagne-glasses"></i>
                        <h5>{{ exp.nombre }}</h5>
                        <p>{{ exp.descripcion }}</p>
                        {% if exp.monto_fijo %}
                        <div class="price-tag">${{ exp.monto_fijo|floatformat:0|intcomma }}</div>
                        {% endif %}
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>

            <div id="amountSelection" style="display:none;">
                <h3 class="text-center mb-3">Selecciona el Monto</h3>
                <div class="amount-options" id="amountOptions"></div>

                <div class="custom-amount">
                    <label class="form-label fw-bold">O ingresa un monto personalizado:</label>
                    <div class="input-group">
                        <span class="input-group-text">$</span>
                        <input type="number" class="form-control custom-amount-input" id="customAmount" placeholder="Ej: 85000" min="10000" step="1000">
                    </div>
                    <small class="text-muted">Monto m√≠nimo: $10.000</small>
                </div>
            </div>
        </div>

        <!-- STEP 2: Datos del Destinatario -->
        <div class="wizard-step" id="step2">
            <h2 class="step-title">Datos del Destinatario</h2>
            <p class="step-subtitle">¬øPara qui√©n es este regalo?</p>

            <form id="destinatarioForm">
                <div class="mb-4">
                    <label class="form-label fw-bold">Nombre o Apodo del Destinatario *</label>
                    <input type="text" class="form-control" id="destinatarioNombre" placeholder="Ej: Mar√≠a" required>
                    <small class="text-muted">Este nombre aparecer√° en el mensaje personalizado</small>
                </div>

                <div class="mb-4">
                    <label class="form-label fw-bold">Relaci√≥n Contigo *</label>
                    <input type="text" class="form-control" id="destinatarioRelacion" placeholder="Ej: esposa, mejor amiga, madre" required>
                    <small class="text-muted">Ayuda a la IA a crear un mensaje m√°s personal</small>
                </div>

                <div class="mb-4">
                    <label class="form-label fw-bold">Email del Destinatario *</label>
                    <input type="email" class="form-control" id="destinatarioEmail" placeholder="maria@ejemplo.com" required>
                    <small class="text-muted">Necesario para crear el perfil del destinatario como cliente</small>
                </div>

                <div class="mb-4">
                    <label class="form-label fw-bold">Tel√©fono del Destinatario *</label>
                    <input type="tel" class="form-control" id="destinatarioTelefono" placeholder="+56 9 1234 5678" required>
                    <small class="text-muted">Necesario para crear el perfil del destinatario como cliente</small>
                </div>
            </form>
        </div>

        <!-- STEP 3: Tipo de Mensaje -->
        <div class="wizard-step" id="step3">
            <h2 class="step-title">Elige el Tipo de Mensaje</h2>
            <p class="step-subtitle">¬øPara qu√© ocasi√≥n es este regalo?</p>

            <div class="experience-grid">
                {% for tipo in tipos_mensaje %}
                <div class="experience-card" data-tipo="{{ tipo.id }}" onclick="selectTipoMensaje('{{ tipo.id }}')">
                    <i class="fas {{ tipo.icono }}"></i>
                    <h3>{{ tipo.nombre }}</h3>
                    <p>{{ tipo.descripcion }}</p>
                </div>
                {% endfor %}
            </div>

            <!-- Campo para detalle especial (usado con IA) -->
            <div class="mt-4" id="detalleEspecialContainer">
                <label class="form-label fw-bold">Detalle Especial (Opcional)</label>
                <textarea class="form-control" id="detalleEspecial" rows="3" placeholder="Ej: Celebrando 10 a√±os juntos, siempre me apoya en momentos dif√≠ciles..."></textarea>
                <small class="text-muted">Este detalle har√° el mensaje a√∫n m√°s personal y √∫nico</small>
            </div>

            <!-- Campo para mensaje personalizado (solo cuando se elige "Escribir Mi Mensaje") -->
            <div class="mt-4" id="mensajePersonalizadoContainer" style="display: none;">
                <label class="form-label fw-bold">Tu Mensaje Personalizado *</label>
                <textarea class="form-control" id="mensajePersonalizado" rows="5" maxlength="500" placeholder="Escribe aqu√≠ tu mensaje personalizado para el destinatario de la Gift Card..."></textarea>
                <div class="d-flex justify-content-between mt-2">
                    <small class="text-muted">M√≠nimo 10 caracteres, m√°ximo 500</small>
                    <small class="text-muted"><span id="charCounter">0</span>/500</small>
                </div>
            </div>
        </div>

        <!-- STEP 4: Generar Mensajes con IA -->
        <div class="wizard-step" id="step4">
            <h2 class="step-title">Mensaje Personalizado</h2>
            <p class="step-subtitle">Elige el mensaje que m√°s te guste</p>

            <!-- Loading State -->
            <div id="mensajesLoading" class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <p class="mt-3 text-muted">Generando mensajes personalizados con IA...</p>
            </div>

            <!-- Mensajes Generados -->
            <div id="mensajesContainer" style="display:none;">
                <div id="mensajesList" class="row g-3 mb-4">
                    <!-- Los mensajes se insertar√°n aqu√≠ din√°micamente -->
                </div>

                <!-- Bot√≥n Regenerar -->
                <div class="text-center mb-3">
                    <button type="button" class="btn btn-outline-secondary" onclick="regenerarMensaje()">
                        <i class="fas fa-sync-alt me-2"></i>Generar Otro Mensaje
                    </button>
                </div>

                <!-- Mensaje Seleccionado -->
                <div id="mensajeSeleccionadoDiv" style="display:none;" class="alert alert-success">
                    <strong>Mensaje seleccionado:</strong>
                    <p id="mensajeSeleccionadoText" class="mb-0 mt-2"></p>
                </div>
            </div>

            <!-- Error State -->
            <div id="mensajesError" style="display:none;" class="alert alert-danger">
                <strong>Error al generar mensajes</strong>
                <p id="mensajesErrorText" class="mb-0 mt-2"></p>
                <button type="button" class="btn btn-sm btn-danger mt-2" onclick="generarMensajesIA()">
                    <i class="fas fa-redo me-2"></i>Reintentar
                </button>
            </div>
        </div>

        <!-- STEP 5: Preview -->
        <div class="wizard-step" id="step5">
            <h2 class="step-title">Vista Previa</h2>
            <p class="step-subtitle">As√≠ se ver√° tu GiftCard</p>

            <div class="d-flex justify-content-center py-4">
                <!-- GiftCard Preview Card -->
                <div class="card shadow-lg" style="max-width: 600px; width: 100%; border: 3px solid #ffc107;">
                    <div class="card-body p-4" style="background: linear-gradient(135deg, #fff8e1 0%, #ffffff 100%);">

                        <!-- Header -->
                        <div class="text-center mb-4">
                            <h3 class="mb-2" style="color: #A0522D; font-weight: 700;">
                                AREMKO AGUAS CALIENTES & SPA
                            </h3>
                            <h4 class="mb-3" style="color: #D2B48C;">
                                <i class="fas fa-gift me-2"></i>
                                Certificado de Regalo
                                <i class="fas fa-gift ms-2"></i>
                            </h4>
                            <hr style="border-color: #ffc107; border-width: 2px;">
                        </div>

                        <!-- Para -->
                        <div class="mb-4 text-center">
                            <p class="mb-2" style="color: #A0522D; font-size: 0.9rem;">Para:</p>
                            <h4 id="preview-destinatario" style="color: #5C4033; font-weight: 600;"></h4>
                        </div>

                        <!-- Mensaje Personalizado -->
                        <div class="mb-4 p-3" style="background-color: white; border-left: 4px solid #ffc107; border-radius: 8px;">
                            <p id="preview-mensaje" class="mb-0 fst-italic" style="color: #5C4033; line-height: 1.6;"></p>
                        </div>

                        <hr style="border-color: #D2B48C;">

                        <!-- Experiencia (descripci√≥n detallada sin precio) -->
                        <div class="text-center mb-3">
                            <p class="mb-2" style="color: #A0522D; font-size: 0.85rem; font-weight: 600;">EXPERIENCIA</p>
                            <p id="preview-experiencia" style="color: #5C4033; font-size: 0.95rem; font-weight: 500; line-height: 1.5; padding: 0 15px;"></p>
                        </div>

                        <!-- C√≥digo (simulado) -->
                        <div class="text-center mb-3">
                            <p class="mb-1" style="color: #A0522D; font-size: 0.85rem;">C√ìDIGO</p>
                            <p class="mb-0" style="color: #5C4033; font-family: 'Courier New', monospace; font-size: 1.2rem; font-weight: 700; letter-spacing: 2px;">
                                GC-XXXXXXXX
                            </p>
                        </div>

                        <!-- Validez -->
                        <div class="text-center mb-3">
                            <p class="mb-1" style="color: #A0522D; font-size: 0.85rem;">V√ÅLIDO HASTA</p>
                            <p id="preview-validez" class="mb-0" style="color: #5C4033; font-weight: 600;"></p>
                        </div>

                        <hr style="border-color: #D2B48C;">

                        <!-- C√≥mo usar -->
                        <div class="text-center">
                            <p class="mb-2" style="color: #A0522D; font-size: 0.85rem; font-weight: 600;">C√ìMO USAR</p>
                            <p class="mb-1" style="color: #5C4033; font-size: 0.9rem;">
                                <i class="fab fa-whatsapp text-success me-1"></i>
                                WhatsApp: <strong>+56 9 5790 2525</strong>
                            </p>
                            <p class="mb-0 text-muted small">
                                Menciona tu c√≥digo para reservar tu experiencia
                            </p>
                        </div>

                        <!-- Footer -->
                        <div class="text-center mt-4 pt-3" style="border-top: 1px solid #D2B48C;">
                            <p class="mb-0 small text-muted">www.aremko.cl | Puerto Varas</p>
                        </div>

                    </div>
                </div>
            </div>

            <!-- Nota informativa -->
            <div class="alert alert-info mx-auto" style="max-width: 600px;">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Nota:</strong> Esta es una vista previa. El c√≥digo definitivo y el PDF se generar√°n despu√©s del pago.
            </div>

            <!-- Bot√≥n Agregar al Carrito -->
            <div class="text-center mt-4">
                <button type="button" class="btn btn-warning btn-lg px-5 text-white fw-bold" id="btnAgregarAlCarritoStep5">
                    <i class="fas fa-shopping-cart me-2"></i>
                    Agregar al Carrito
                </button>
                <p class="text-muted small mt-3 mb-0">
                    Despu√©s podr√°s ingresar tus datos de comprador en el checkout
                </p>

                <!-- Loading state -->
                <div id="loadingCarritoStep5" class="d-none mt-4">
                    <div class="spinner-border text-warning" role="status">
                        <span class="visually-hidden">Agregando al carrito...</span>
                    </div>
                    <p class="mt-2">Agregando al carrito...</p>
                </div>
            </div>
        </div>

        <!-- STEP 6: Datos del Comprador (ELIMINADO - ahora se pide en checkout) -->
        <div class="wizard-step d-none" id="step6">
            <h2 class="step-title">Tus Datos</h2>
            <p class="step-subtitle">Necesitamos tus datos para completar la compra</p>

            <form id="compradorForm" class="mx-auto" style="max-width: 600px;">
                <div class="mb-4">
                    <label class="form-label fw-bold">Tel√©fono del Comprador *</label>
                    <input type="tel" class="form-control" id="compradorTelefono" placeholder="+56 9 1234 5678" required>
                    <small class="text-muted">Ingresa tu celular. Si ya eres cliente, autocompletaremos tus datos</small>
                    <div id="compradorBuscando" class="d-none mt-2">
                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                            <span class="visually-hidden">Buscando...</span>
                        </div>
                        <span class="ms-2 text-muted">Buscando tus datos...</span>
                    </div>
                    <div id="compradorEncontrado" class="d-none mt-2 alert alert-success py-2">
                        <i class="fas fa-check-circle me-2"></i>¬°Cliente encontrado! Datos autocompletados
                    </div>
                </div>

                <div class="mb-4">
                    <label class="form-label fw-bold">Nombre Completo *</label>
                    <input type="text" class="form-control" id="compradorNombre" placeholder="Ej: Juan P√©rez" required>
                </div>

                <div class="mb-4">
                    <label class="form-label fw-bold">Email *</label>
                    <input type="email" class="form-control" id="compradorEmail" placeholder="tu@email.com" required>
                    <small class="text-muted">Enviaremos la GiftCard a este correo</small>
                </div>
            </form>

            <!-- Bot√≥n Agregar al Carrito -->
            <div class="text-center mt-4">
                <button type="button" class="btn btn-warning btn-lg px-5 text-white fw-bold" id="btnAgregarAlCarritoStep6" disabled>
                    <i class="fas fa-shopping-cart me-2"></i>
                    Agregar al Carrito
                </button>
                <p class="text-muted small mt-3 mb-0">
                    Despu√©s puedes seguir comprando o finalizar tu compra
                </p>

                <!-- Loading state -->
                <div id="loadingCarritoStep6" class="d-none mt-4">
                    <div class="spinner-border text-warning" role="status">
                        <span class="visually-hidden">Agregando al carrito...</span>
                    </div>
                    <p class="mt-2">Agregando al carrito...</p>
                </div>
            </div>
        </div>

        <!-- STEP 8: Agregar al Carrito (antes era step 6) -->
        <div class="wizard-step" id="step8">
            <h2 class="step-title">¬°Tu GiftCard est√° Lista!</h2>
            <p class="step-subtitle">Agr√©gala al carrito para continuar con tu compra</p>

            <div class="text-center py-4">
                <!-- Resumen de la GiftCard -->
                <div class="card mx-auto" style="max-width: 500px;">
                    <div class="card-body">
                        <h5 class="card-title mb-4">
                            <i class="fas fa-gift text-warning me-2"></i>
                            Resumen de tu GiftCard
                        </h5>

                        <div class="text-start">
                            <p class="mb-2">
                                <strong>Experiencia:</strong>
                                <span id="resumen-experiencia"></span>
                            </p>
                            <p class="mb-2">
                                <strong>Para:</strong>
                                <span id="resumen-destinatario"></span>
                            </p>
                            <p class="mb-2">
                                <strong>Email destinatario:</strong>
                                <span id="resumen-email"></span>
                            </p>
                            <p class="mb-2">
                                <strong>Mensaje:</strong>
                            </p>
                            <p class="fst-italic text-muted small" id="resumen-mensaje" style="max-height: 100px; overflow-y: auto;">
                            </p>
                            <hr>
                            <p class="mb-2">
                                <strong>Comprador:</strong>
                                <span id="resumen-comprador"></span>
                            </p>
                            <p class="mb-2">
                                <strong>Email comprador:</strong>
                                <span id="resumen-comprador-email"></span>
                            </p>
                        </div>

                        <div class="mt-4">
                            <button type="button" class="btn btn-warning btn-lg w-100 text-white fw-bold" id="btnAgregarAlCarrito">
                                <i class="fas fa-shopping-cart me-2"></i>
                                Agregar al Carrito
                            </button>
                            <p class="text-muted small mt-3 mb-0">
                                Despu√©s puedes seguir comprando o finalizar tu compra
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Loading state -->
                <div id="loadingCarrito" class="d-none mt-4">
                    <div class="spinner-border text-warning" role="status">
                        <span class="visually-hidden">Agregando al carrito...</span>
                    </div>
                    <p class="mt-2">Agregando al carrito...</p>
                </div>
            </div>
        </div>

        <!-- Navigation Buttons -->
        <div class="wizard-navigation">
            <button type="button" class="btn btn-wizard-prev" id="prevBtn" onclick="previousStep()" style="display:none;">
                <i class="fas fa-arrow-left me-2"></i>Anterior
            </button>
            <div></div> <!-- Spacer -->
            <button type="button" class="btn btn-wizard-next" id="nextBtn" onclick="nextStep()">
                Siguiente<i class="fas fa-arrow-right ms-2"></i>
            </button>
        </div>
    </div>
</div>

<script>
// Funci√≥n helper para obtener CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Wizard State
let wizardData = {
    paso: 1,
    experiencia: null,
    monto: null,
    destinatario: {},
    tipoMensaje: null,
    detalleEspecial: '',
    mensajeSeleccionado: null,
    comprador: {}  // Nuevo: datos del comprador
};

// Datos de experiencias (desde el backend)
const experiencias = {{ experiencias|safe }};

// Seleccionar Experiencia
function selectExperience(expId) {
    // Remover selecci√≥n anterior
    document.querySelectorAll('.experience-card').forEach(card => {
        card.classList.remove('selected');
    });

    // Seleccionar nueva experiencia
    const card = document.querySelector(`[data-experience="${expId}"]`);
    card.classList.add('selected');

    wizardData.experiencia = expId;

    // Obtener experiencia seleccionada
    const exp = experiencias.find(e => e.id === expId);

    // Si tiene monto fijo (> 0), asignarlo directamente y ocultar selector
    if (exp.monto_fijo && exp.monto_fijo > 0) {
        wizardData.monto = exp.monto_fijo;
        document.getElementById('amountSelection').style.display = 'none';
        console.log(`‚úÖ Experiencia "${exp.nombre}" seleccionada con monto fijo: $${exp.monto_fijo.toLocaleString('es-CL')}`);
    } else {
        // Mostrar selector de monto para "Monto Libre" (monto_fijo = 0)
        showAmountOptions(exp.montos_sugeridos);
    }

    // Habilitar bot√≥n siguiente
    updateNextButton();
}

// Mostrar opciones de monto (solo para "Monto Libre")
function showAmountOptions(montos) {
    const amountSelection = document.getElementById('amountSelection');
    const amountOptions = document.getElementById('amountOptions');

    amountSelection.style.display = 'block';
    amountOptions.innerHTML = '';

    montos.forEach(monto => {
        const btn = document.createElement('button');
        btn.className = 'amount-btn';
        btn.textContent = `$${monto.toLocaleString('es-CL')}`;
        btn.onclick = () => selectAmount(monto);
        amountOptions.appendChild(btn);
    });
}

// Seleccionar Monto
function selectAmount(amount) {
    // Remover selecci√≥n anterior
    document.querySelectorAll('.amount-btn').forEach(btn => {
        btn.classList.remove('selected');
    });

    // Seleccionar nuevo monto
    event.target.classList.add('selected');
    wizardData.monto = amount;

    // Limpiar custom amount
    document.getElementById('customAmount').value = '';

    updateNextButton();
}

// Monto personalizado
document.getElementById('customAmount')?.addEventListener('input', function() {
    const amount = parseInt(this.value);
    if (amount >= 10000) {
        wizardData.monto = amount;

        // Deseleccionar botones de monto
        document.querySelectorAll('.amount-btn').forEach(btn => {
            btn.classList.remove('selected');
        });

        updateNextButton();
    }
});

// Seleccionar Tipo de Mensaje
function selectTipoMensaje(tipoId) {
    // Remover selecci√≥n anterior
    document.querySelectorAll('[data-tipo]').forEach(card => {
        card.classList.remove('selected');
    });

    // Seleccionar nuevo tipo
    const card = document.querySelector(`[data-tipo="${tipoId}"]`);
    card.classList.add('selected');

    wizardData.tipoMensaje = tipoId;

    // Mostrar/ocultar campos seg√∫n el tipo de mensaje seleccionado
    const detalleEspecialContainer = document.getElementById('detalleEspecialContainer');
    const mensajePersonalizadoContainer = document.getElementById('mensajePersonalizadoContainer');
    const mensajePersonalizado = document.getElementById('mensajePersonalizado');
    const charCounter = document.getElementById('charCounter');

    if (tipoId === 'personalizado') {
        // Ocultar detalle especial (no se usa con mensaje personalizado)
        detalleEspecialContainer.style.display = 'none';
        // Mostrar campo de mensaje personalizado
        mensajePersonalizadoContainer.style.display = 'block';

        // Agregar contador de caracteres y validaci√≥n
        mensajePersonalizado.addEventListener('input', function() {
            charCounter.textContent = this.value.length;
            updateNextButton(); // Re-validar el bot√≥n siguiente
        });
    } else {
        // Mostrar detalle especial (usado con IA)
        detalleEspecialContainer.style.display = 'block';
        // Ocultar campo de mensaje personalizado
        mensajePersonalizadoContainer.style.display = 'none';
        // Limpiar mensaje personalizado
        mensajePersonalizado.value = '';
    }

    updateNextButton();
}

// Actualizar bot√≥n siguiente
function updateNextButton() {
    const nextBtn = document.getElementById('nextBtn');
    const currentStep = wizardData.paso;

    let canProceed = false;

    if (currentStep === 1) {
        canProceed = wizardData.experiencia && wizardData.monto;
    } else if (currentStep === 2) {
        const nombre = document.getElementById('destinatarioNombre')?.value?.trim();
        const relacion = document.getElementById('destinatarioRelacion')?.value?.trim();
        const email = document.getElementById('destinatarioEmail')?.value?.trim();
        const telefono = document.getElementById('destinatarioTelefono')?.value?.trim();
        console.log('üîç Step 2 Validation:', { nombre, relacion, email, telefono });
        canProceed = !!(nombre && relacion && email && telefono);
        console.log('‚úÖ Can proceed?', canProceed, 'Nombre length:', nombre?.length, 'Relacion length:', relacion?.length);
    } else if (currentStep === 3) {
        // Validar que haya tipo de mensaje seleccionado
        if (!wizardData.tipoMensaje) {
            canProceed = false;
        } else if (wizardData.tipoMensaje === 'personalizado') {
            // Si es mensaje personalizado, validar que tenga al menos 10 caracteres
            const mensajePersonalizado = document.getElementById('mensajePersonalizado')?.value || '';
            canProceed = mensajePersonalizado.length >= 10;
        } else {
            // Si es IA, solo validar que haya tipo seleccionado
            canProceed = true;
        }
    } else if (currentStep === 4) {
        canProceed = wizardData.mensajeSeleccionado !== null;
    } else {
        canProceed = true; // Otros pasos siempre pueden avanzar por ahora
    }

    nextBtn.disabled = !canProceed;
}

// Siguiente Paso
function nextStep() {
    const currentStep = wizardData.paso;

    // Guardar datos del paso actual
    if (currentStep === 2) {
        wizardData.destinatario = {
            nombre: document.getElementById('destinatarioNombre').value,
            relacion: document.getElementById('destinatarioRelacion').value,
            email: document.getElementById('destinatarioEmail').value,
            telefono: document.getElementById('destinatarioTelefono').value
        };
        console.log('‚úÖ Datos destinatario guardados:', wizardData.destinatario);
    } else if (currentStep === 3) {
        // Guardar el detalle especial o mensaje personalizado seg√∫n corresponda
        if (wizardData.tipoMensaje === 'personalizado') {
            // Si es mensaje personalizado, guardarlo directamente
            wizardData.mensajePersonalizado = document.getElementById('mensajePersonalizado').value;
            wizardData.mensajeSeleccionado = wizardData.mensajePersonalizado; // IMPORTANTE: asignar tambi√©n a mensajeSeleccionado
            wizardData.detalleEspecial = ''; // No hay detalle especial
            console.log('‚úÖ Mensaje personalizado guardado:', wizardData.mensajePersonalizado);
        } else {
            // Si es IA, guardar el detalle especial
            wizardData.detalleEspecial = document.getElementById('detalleEspecial').value;
            wizardData.mensajePersonalizado = ''; // No hay mensaje personalizado
            console.log('‚úÖ Detalle especial guardado:', wizardData.detalleEspecial);
        }
    } else if (currentStep === 4) {
        // Guardar mensaje seleccionado al avanzar desde Step 4
        console.log('üìù Avanzando desde Step 4. Mensaje seleccionado:', wizardData.mensajeSeleccionado);
        if (!wizardData.mensajeSeleccionado) {
            console.warn('‚ö†Ô∏è No hay mensaje seleccionado en Step 4');
        }
    }

    // Avanzar paso (m√°ximo 5 pasos ahora)
    if (currentStep < 5) {
        // Si estamos en Step 3 y se eligi√≥ mensaje personalizado, saltar al Step 5 (preview)
        if (currentStep === 3 && wizardData.tipoMensaje === 'personalizado') {
            wizardData.paso = 5; // Saltar directo a preview
            console.log('‚è≠Ô∏è Saltando de Step 3 a Step 5 (mensaje personalizado)');
        } else {
            wizardData.paso++;
        }

        updateWizardUI();

        // Auto-generar mensajes al llegar a Step 4 (solo si NO es personalizado)
        if (wizardData.paso === 4 && wizardData.tipoMensaje !== 'personalizado') {
            generarMensajesIA();
        }

        // Actualizar preview al llegar a Step 5
        if (wizardData.paso === 5) {
            console.log('üé® Llegando a Step 5, actualizando preview...');
            actualizarPreviewStep5();
        }
    }
}

// Paso Anterior
function previousStep() {
    if (wizardData.paso > 1) {
        // Si estamos en Step 5 y hab√≠amos usado mensaje personalizado, volver a Step 3
        if (wizardData.paso === 5 && wizardData.tipoMensaje === 'personalizado') {
            wizardData.paso = 3; // Volver directo a Step 3
        } else {
            wizardData.paso--;
        }
        updateWizardUI();
    }
}

// Actualizar UI del Wizard
function updateWizardUI() {
    const currentStep = wizardData.paso;

    // Ocultar todos los pasos
    document.querySelectorAll('.wizard-step').forEach(step => {
        step.classList.remove('active');
    });

    // Mostrar paso actual
    document.getElementById(`step${currentStep}`).classList.add('active');

    // Actualizar progress bar
    document.querySelectorAll('.progress-step').forEach((step, index) => {
        step.classList.remove('active', 'completed');
        if (index + 1 < currentStep) {
            step.classList.add('completed');
        } else if (index + 1 === currentStep) {
            step.classList.add('active');
        }
    });

    const progressPercentage = ((currentStep - 1) / 4) * 100;  // 5 pasos - 1 = 4
    document.getElementById('progressFill').style.width = `${progressPercentage}%`;
    document.getElementById('currentStep').textContent = currentStep;

    // Mostrar/ocultar bot√≥n anterior
    document.getElementById('prevBtn').style.display = currentStep > 1 ? 'block' : 'none';

    // Ocultar bot√≥n "Siguiente" en Step 5 (tiene su propio bot√≥n "Agregar al Carrito")
    const nextBtn = document.getElementById('nextBtn');
    if (currentStep === 5) {
        nextBtn.style.display = 'none';
    } else {
        nextBtn.style.display = 'block';
    }

    // NUEVO: Re-registrar event listeners cuando entramos al Step 2
    if (currentStep === 2) {
        console.log('üìù Re-registrando event listeners para Step 2 en updateWizardUI...');
        setTimeout(() => {
            const nombreInput = document.getElementById('destinatarioNombre');
            const relacionInput = document.getElementById('destinatarioRelacion');
            const emailInput = document.getElementById('destinatarioEmail');
            const telefonoInput = document.getElementById('destinatarioTelefono');

            console.log('Inputs encontrados:', {
                nombreInput: !!nombreInput,
                relacionInput: !!relacionInput,
                emailInput: !!emailInput,
                telefonoInput: !!telefonoInput,
                valores: {
                    nombre: nombreInput?.value,
                    relacion: relacionInput?.value,
                    email: emailInput?.value,
                    telefono: telefonoInput?.value
                }
            });

            if (nombreInput) nombreInput.addEventListener('input', updateNextButton);
            if (relacionInput) relacionInput.addEventListener('input', updateNextButton);
            if (emailInput) emailInput.addEventListener('input', updateNextButton);
            if (telefonoInput) telefonoInput.addEventListener('input', updateNextButton);

            // Forzar actualizaci√≥n inmediata
            updateNextButton();
        }, 100);
    }

    // NUEVO: Re-registrar event listener del bot√≥n "Agregar al Carrito" cuando entramos al Step 5
    if (currentStep === 5) {
        console.log('üõí Re-registrando event listener para bot√≥n Agregar al Carrito Step 5...');
        setTimeout(() => {
            const btnAgregarCarrito = document.getElementById('btnAgregarAlCarritoStep5');
            console.log('Bot√≥n encontrado:', !!btnAgregarCarrito);

            if (btnAgregarCarrito) {
                // Remover listener anterior si existe para evitar duplicados
                const newBtn = btnAgregarCarrito.cloneNode(true);
                btnAgregarCarrito.parentNode.replaceChild(newBtn, btnAgregarCarrito);

                // Agregar nuevo listener
                newBtn.addEventListener('click', async function(e) {
                    console.log('üîò CLICK en bot√≥n Agregar al Carrito Step 5 (listener directo)');
                    e.preventDefault();

                    const btn = this;
                    const loadingDiv = document.getElementById('loadingCarritoStep5');

                    try {
                        // Mostrar loading
                        btn.disabled = true;
                        loadingDiv.classList.remove('d-none');

                        // Validar wizardData antes de enviar
                        console.log('üìä wizardData completo antes de enviar:', JSON.stringify(wizardData, null, 2));

                        // Validar campos requeridos
                        if (!wizardData.experiencia) {
                            throw new Error('No se seleccion√≥ ninguna experiencia');
                        }
                        if (!wizardData.monto) {
                            throw new Error('No se seleccion√≥ un monto para la GiftCard');
                        }
                        if (!wizardData.destinatario?.nombre) {
                            throw new Error('Falta el nombre del destinatario');
                        }
                        if (!wizardData.destinatario?.email) {
                            throw new Error('Falta el email del destinatario');
                        }
                        if (!wizardData.tipoMensaje) {
                            throw new Error('No se seleccion√≥ un tipo de mensaje');
                        }
                        if (!wizardData.mensajeSeleccionado) {
                            throw new Error('No se seleccion√≥ un mensaje');
                        }

                        // Obtener el nombre de la experiencia seleccionada
                        const expCard = document.querySelector(`.exp-card[data-exp-id="${wizardData.experiencia}"]`);
                        const expNombre = expCard ? expCard.querySelector('h5').textContent.trim() : 'Experiencia Aremko';

                        // Preparar datos para enviar
                        const giftcardData = {
                            experiencia_id: wizardData.experiencia,
                            experiencia_nombre: expNombre,
                            precio: parseFloat(wizardData.monto),  // Asegurar que sea n√∫mero
                            destinatario_nombre: wizardData.destinatario.nombre,
                            destinatario_email: wizardData.destinatario.email,
                            destinatario_telefono: wizardData.destinatario.telefono || '',
                            tipo_mensaje: wizardData.tipoMensaje,
                            mensaje_seleccionado: wizardData.mensajeSeleccionado
                        };

                        console.log('üì§ Enviando GiftCard al carrito desde Step 5:', JSON.stringify(giftcardData, null, 2));

                        // Enviar al backend
                        const response = await fetch('/ventas/api/giftcard/agregar-al-carrito/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': getCookie('csrftoken')
                            },
                            body: JSON.stringify(giftcardData)
                        });

                        if (!response.ok) {
                            const errorText = await response.text();
                            throw new Error(`Error del servidor (${response.status}): ${errorText}`);
                        }

                        const data = await response.json();

                        if (data.success) {
                            console.log('‚úÖ GiftCard agregada al carrito, redirigiendo...');
                            window.location.href = data.redirect_url;
                        } else {
                            throw new Error(data.error || 'Error al agregar al carrito');
                        }

                    } catch (error) {
                        console.error('‚ùå Error completo:', error);
                        alert('Error al agregar la GiftCard al carrito: ' + error.message);
                        btn.disabled = false;
                        loadingDiv.classList.add('d-none');
                    }
                });

                console.log('‚úÖ Event listener registrado para Step 5');
            } else {
                console.error('‚ùå No se encontr√≥ el bot√≥n btnAgregarAlCarritoStep5');
            }
        }, 100);
    }

    // Actualizar estado del bot√≥n siguiente
    updateNextButton();
}

// Validar inputs en tiempo real (Step 2)
console.log('üìù Registrando event listeners para Step 2...');
const nombreInput = document.getElementById('destinatarioNombre');
const relacionInput = document.getElementById('destinatarioRelacion');
const emailInput = document.getElementById('destinatarioEmail');
const telefonoInput = document.getElementById('destinatarioTelefono');

console.log('Elementos encontrados:', {
    nombreInput: !!nombreInput,
    relacionInput: !!relacionInput,
    emailInput: !!emailInput,
    telefonoInput: !!telefonoInput
});

if (nombreInput) nombreInput.addEventListener('input', updateNextButton);
if (relacionInput) relacionInput.addEventListener('input', updateNextButton);
if (emailInput) emailInput.addEventListener('input', updateNextButton);
if (telefonoInput) telefonoInput.addEventListener('input', updateNextButton);

// ============================================
// STEP 4: GENERAR MENSAJES CON IA
// ============================================

// Generar mensajes personalizados con DeepSeek AI
async function generarMensajesIA() {
    console.log('ü§ñ Generando mensajes con IA...');

    // Mostrar loading, ocultar mensajes y errores
    document.getElementById('mensajesLoading').style.display = 'block';
    document.getElementById('mensajesContainer').style.display = 'none';
    document.getElementById('mensajesError').style.display = 'none';

    try {
        const response = await fetch('/ventas/api/giftcard/generar-mensajes/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                tipo_mensaje: wizardData.tipoMensaje,
                nombre: wizardData.destinatario.nombre,
                relacion: wizardData.destinatario.relacion,
                detalle: wizardData.detalleEspecial || '',
                cantidad: 3
            })
        });

        const data = await response.json();

        if (data.success) {
            console.log(`‚úÖ ${data.cantidad_generada} mensajes generados`);
            displayMensajes(data.mensajes);
        } else {
            throw new Error(data.error || 'Error al generar mensajes');
        }
    } catch (error) {
        console.error('‚ùå Error:', error);

        // Mostrar error
        document.getElementById('mensajesLoading').style.display = 'none';
        document.getElementById('mensajesError').style.display = 'block';
        document.getElementById('mensajesErrorText').textContent = error.message;
    }
}

// Mostrar mensajes generados como cards seleccionables
function displayMensajes(mensajes) {
    const container = document.getElementById('mensajesList');
    container.innerHTML = '';

    mensajes.forEach((mensaje, index) => {
        const col = document.createElement('div');
        col.className = 'col-12';

        const card = document.createElement('div');
        card.className = 'card mensaje-card';
        card.style.cursor = 'pointer';
        card.onclick = () => selectMensaje(index, mensaje);

        card.innerHTML = `
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <h6 class="card-subtitle text-muted mb-0">
                        <i class="fas fa-message me-2"></i>Opci√≥n ${index + 1}
                    </h6>
                    <i class="fas fa-check-circle text-success" style="display:none;" id="check-${index}"></i>
                </div>
                <p class="card-text mt-3" style="white-space: pre-wrap;">${mensaje}</p>
            </div>
        `;

        col.appendChild(card);
        container.appendChild(col);
    });

    // Ocultar loading, mostrar mensajes
    document.getElementById('mensajesLoading').style.display = 'none';
    document.getElementById('mensajesContainer').style.display = 'block';
}

// Seleccionar un mensaje
function selectMensaje(index, texto) {
    console.log(`‚úÖ Mensaje ${index + 1} seleccionado: "${texto}"`);

    // Guardar en wizardData
    wizardData.mensajeSeleccionado = texto;
    console.log('üìù wizardData.mensajeSeleccionado actualizado:', wizardData.mensajeSeleccionado);

    // Actualizar UI - remover selecci√≥n previa
    document.querySelectorAll('.mensaje-card').forEach(card => {
        card.classList.remove('border-success');
        card.style.borderWidth = '1px';
    });

    document.querySelectorAll('[id^="check-"]').forEach(check => {
        check.style.display = 'none';
    });

    // Marcar card seleccionada
    const cards = document.querySelectorAll('.mensaje-card');
    cards[index].classList.add('border-success');
    cards[index].style.borderWidth = '2px';
    document.getElementById(`check-${index}`).style.display = 'block';

    // Mostrar mensaje seleccionado
    document.getElementById('mensajeSeleccionadoText').textContent = texto;
    document.getElementById('mensajeSeleccionadoDiv').style.display = 'block';

    // Habilitar bot√≥n siguiente
    updateNextButton();
}

// Regenerar mensaje (genera 1 mensaje adicional)
async function regenerarMensaje() {
    console.log('üîÑ Regenerando mensaje...');

    try {
        const response = await fetch('/ventas/api/giftcard/regenerar-mensaje/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                tipo_mensaje: wizardData.tipoMensaje,
                nombre: wizardData.destinatario.nombre,
                relacion: wizardData.destinatario.relacion,
                detalle: wizardData.detalleEspecial || ''
            })
        });

        const data = await response.json();

        if (data.success) {
            console.log('‚úÖ Nuevo mensaje generado');

            // Agregar nuevo mensaje al array existente
            const container = document.getElementById('mensajesList');
            const currentMessages = container.children.length;

            const col = document.createElement('div');
            col.className = 'col-12';

            const card = document.createElement('div');
            card.className = 'card mensaje-card';
            card.style.cursor = 'pointer';
            card.onclick = () => selectMensaje(currentMessages, data.mensaje);

            card.innerHTML = `
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="card-subtitle text-muted mb-0">
                            <i class="fas fa-message me-2"></i>Opci√≥n ${currentMessages + 1} <span class="badge bg-info">Nuevo</span>
                        </h6>
                        <i class="fas fa-check-circle text-success" style="display:none;" id="check-${currentMessages}"></i>
                    </div>
                    <p class="card-text mt-3" style="white-space: pre-wrap;">${data.mensaje}</p>
                </div>
            `;

            col.appendChild(card);
            container.appendChild(col);

            // Scroll al nuevo mensaje
            col.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        } else {
            throw new Error(data.error || 'Error al regenerar mensaje');
        }
    } catch (error) {
        console.error('‚ùå Error:', error);
        alert('Error al generar nuevo mensaje: ' + error.message);
    }
}

// Funci√≥n para actualizar el preview en Step 5
function actualizarPreviewStep5() {
    console.log('üîç Actualizando preview Step 5...');
    console.log('wizardData completo:', wizardData);

    // Obtener la descripci√≥n detallada de la experiencia desde el array de experiencias
    let expDescripcion = 'Experiencia Aremko Spa';
    try {
        const exp = experiencias.find(e => e.id === wizardData.experiencia);
        expDescripcion = exp ? exp.descripcion_giftcard : 'Experiencia Aremko Spa';
    } catch (error) {
        console.error('Error al buscar experiencia:', error);
    }

    // Calcular fecha de validez (1 a√±o desde hoy)
    const hoy = new Date();
    const validezFecha = new Date(hoy.getFullYear() + 1, hoy.getMonth(), hoy.getDate());
    const validezStr = validezFecha.toLocaleDateString('es-CL', {
        day: '2-digit',
        month: 'long',
        year: 'numeric'
    });

    // Obtener el mensaje seleccionado
    const mensajeFinal = wizardData.mensajeSeleccionado || wizardData.mensajePersonalizado || 'Un regalo especial para ti';

    console.log('Mensaje a mostrar en preview:', mensajeFinal);

    // Llenar preview (sin mostrar el precio)
    document.getElementById('preview-destinatario').textContent = wizardData.destinatario.nombre || 'Destinatario';
    document.getElementById('preview-mensaje').textContent = mensajeFinal;
    document.getElementById('preview-experiencia').textContent = expDescripcion;
    document.getElementById('preview-validez').textContent = validezStr;

    console.log('‚úÖ Preview actualizado');
}

// Funci√≥n para actualizar el resumen en Step 6
function actualizarResumenStep6() {
    // Obtener la descripci√≥n detallada de la experiencia
    let expDescripcion = 'Experiencia Aremko Spa';
    try {
        const exp = experiencias.find(e => e.id === wizardData.experiencia);
        expDescripcion = exp ? exp.descripcion_giftcard : 'Experiencia Aremko Spa';
    } catch (error) {
        console.error('Error al buscar experiencia:', error);
    }

    document.getElementById('resumen-experiencia').textContent = expDescripcion;
    document.getElementById('resumen-destinatario').textContent = wizardData.destinatario.nombre;
    document.getElementById('resumen-email').textContent = wizardData.destinatario.email;
    document.getElementById('resumen-mensaje').textContent = wizardData.mensajeSeleccionado;
}

// Funci√≥n para actualizar el resumen en Step 8 (resumen final con comprador)
function actualizarResumenStep8() {
    // Obtener la descripci√≥n detallada de la experiencia
    let expDescripcion = 'Experiencia Aremko Spa';
    try {
        const exp = experiencias.find(e => e.id === wizardData.experiencia);
        expDescripcion = exp ? exp.descripcion_giftcard : 'Experiencia Aremko Spa';
    } catch (error) {
        console.error('Error al buscar experiencia:', error);
    }

    document.getElementById('resumen-experiencia').textContent = expDescripcion;
    document.getElementById('resumen-destinatario').textContent = wizardData.destinatario.nombre;
    document.getElementById('resumen-email').textContent = wizardData.destinatario.email;
    document.getElementById('resumen-mensaje').textContent = wizardData.mensajeSeleccionado;
    document.getElementById('resumen-comprador').textContent = wizardData.comprador.nombre;
    document.getElementById('resumen-comprador-email').textContent = wizardData.comprador.email;
}

// Event listener para el bot√≥n "Agregar al Carrito"
document.getElementById('btnAgregarAlCarrito').addEventListener('click', async function() {
    const btn = this;
    const loadingDiv = document.getElementById('loadingCarrito');

    try {
        // Mostrar loading
        btn.disabled = true;
        loadingDiv.classList.remove('d-none');

        // Obtener el nombre de la experiencia seleccionada
        console.log('üîç Buscando experiencia con ID:', wizardData.experiencia);
        const expCard = document.querySelector(`.exp-card[data-exp-id="${wizardData.experiencia}"]`);
        console.log('üìã Elemento encontrado:', expCard);
        const expNombre = expCard ? expCard.querySelector('h5').textContent.trim() : 'Experiencia Aremko';
        console.log('üè∑Ô∏è Nombre de experiencia extra√≠do:', expNombre);

        // Preparar datos para enviar
        const giftcardData = {
            experiencia_id: wizardData.experiencia,
            experiencia_nombre: expNombre,
            precio: wizardData.monto,
            destinatario_nombre: wizardData.destinatario.nombre,
            destinatario_email: wizardData.destinatario.email,
            destinatario_telefono: wizardData.destinatario.telefono || '',
            tipo_mensaje: wizardData.tipoMensaje,
            mensaje_seleccionado: wizardData.mensajeSeleccionado
        };

        console.log('üì§ Enviando GiftCard al carrito:', giftcardData);

        // Enviar al backend
        const response = await fetch('/ventas/api/giftcard/agregar-al-carrito/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(giftcardData)
        });

        console.log('üì° Response status:', response.status);

        // Verificar si la respuesta fue exitosa
        if (!response.ok) {
            const errorText = await response.text();
            console.error('‚ùå Error del servidor:', errorText);
            throw new Error(`Error del servidor (${response.status}): ${errorText}`);
        }

        const data = await response.json();
        console.log('üì• Response data:', data);

        if (data.success) {
            console.log('‚úÖ GiftCard agregada al carrito:', data);

            // Actualizar contador del carrito en navbar (si existe)
            const cartCount = document.getElementById('cartCount');
            if (cartCount) {
                cartCount.textContent = data.cart_count;
            }

            // Mostrar mensaje de √©xito
            alert(`üéâ ¬°GiftCard agregada al carrito!\n\nC√≥digo: ${data.codigo}\n\n¬øDeseas ir al carrito o seguir comprando?`);

            // Redirigir al carrito
            window.location.href = data.redirect_url;
        } else {
            throw new Error(data.error || 'Error al agregar al carrito');
        }

    } catch (error) {
        console.error('‚ùå Error completo:', error);
        alert('Error al agregar la GiftCard al carrito: ' + error.message);

        // Restaurar bot√≥n
        btn.disabled = false;
        loadingDiv.classList.add('d-none');
    }
});

// Event listener para el bot√≥n "Agregar al Carrito" en Step 5
// NOTA: Este listener se registra din√°micamente en updateWizardUI() cuando currentStep === 5
// Ver l√≠neas ~1290-1369 para la implementaci√≥n

// Modificar nextStep() para actualizar preview/resumen cuando llega a step 5, 6, o 8
const originalNextStep = nextStep;
nextStep = function() {
    const currentStep = wizardData.paso;

    // Llamar funci√≥n original
    originalNextStep();

    // Si llegamos a step 5, actualizar preview
    if (wizardData.paso === 5) {
        actualizarPreviewStep5();
    }

    // Si llegamos a step 6 (preview de GiftCard), actualizar preview
    if (wizardData.paso === 6) {
        actualizarPreviewStep5(); // Reutilizar la misma funci√≥n de preview
    }

    // Si llegamos a step 8 (resumen final), actualizar resumen completo
    if (wizardData.paso === 8) {
        actualizarResumenStep8();
    }
};

// ============================================
// STEP 6 ELIMINADO - Datos del comprador ahora se piden en checkout
// ============================================

// Inicializar
updateNextButton();
</script>
{% endblock %}
