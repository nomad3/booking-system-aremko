{% extends "ventas/base_public.html" %}
{% load static %}
{% load humanize %}

{% block title %}Regala una Experiencia Aremko - GiftCards Personalizadas{% endblock %}

{% block meta_description %}
<meta name="description" content="Regala momentos inolvidables en Aremko. GiftCards personalizadas con mensajes √∫nicos generados por IA. Tinas calientes, masajes y m√°s.">
{% endblock %}

{% block extra_style %}
<style>
    /* GiftCard Wizard Styles */
    .wizard-container {
        max-width: 900px;
        margin: 0 auto;
        padding: 40px 20px;
    }

    .wizard-header {
        text-align: center;
        margin-bottom: 40px;
    }

    .wizard-header h1 {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--dark-gray);
        margin-bottom: 10px;
    }

    .wizard-header p {
        font-size: 1.1rem;
        color: var(--light-gray);
    }

    /* Progress Bar */
    .wizard-progress {
        margin-bottom: 40px;
    }

    .progress-steps {
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
        margin-bottom: 10px;
    }

    .progress-step {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: #e0e0e0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        color: #999;
        z-index: 2;
        position: relative;
    }

    .progress-step.active {
        background-color: var(--primary-color);
        color: white;
    }

    .progress-step.completed {
        background-color: #4CAF50;
        color: white;
    }

    .progress-line {
        position: absolute;
        top: 50%;
        left: 0;
        width: 100%;
        height: 3px;
        background-color: #e0e0e0;
        z-index: 1;
        transform: translateY(-50%);
    }

    .progress-line-fill {
        height: 100%;
        background-color: var(--primary-color);
        transition: width 0.3s ease;
    }

    /* Wizard Content */
    .wizard-content {
        background-color: white;
        border-radius: 12px;
        padding: 40px;
        box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
    }

    .step-title {
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--dark-gray);
        margin-bottom: 20px;
        text-align: center;
    }

    .step-subtitle {
        font-size: 1.1rem;
        color: var(--light-gray);
        margin-bottom: 30px;
        text-align: center;
    }

    /* Experience Cards */
    .experience-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .experience-card {
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        padding: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
    }

    .experience-card:hover {
        border-color: var(--primary-color);
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .experience-card.selected {
        border-color: var(--primary-color);
        background-color: rgba(160, 82, 45, 0.05);
    }

    .experience-card img {
        width: 100%;
        height: 150px;
        object-fit: cover;
        border-radius: 8px;
        margin-bottom: 15px;
    }

    .experience-card h3 {
        font-size: 1.2rem;
        font-weight: 700;
        color: var(--dark-gray);
        margin-bottom: 10px;
    }

    .experience-card p {
        font-size: 0.9rem;
        color: var(--light-gray);
        margin-bottom: 15px;
    }

    /* Amount Selection */
    .amount-options {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 15px;
        margin-top: 20px;
    }

    .amount-btn {
        padding: 15px 20px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        background-color: white;
        cursor: pointer;
        font-weight: 600;
        font-size: 1.1rem;
        transition: all 0.3s ease;
    }

    .amount-btn:hover {
        border-color: var(--primary-color);
        background-color: rgba(160, 82, 45, 0.05);
    }

    .amount-btn.selected {
        border-color: var(--primary-color);
        background-color: var(--primary-color);
        color: white;
    }

    .custom-amount {
        margin-top: 20px;
        padding: 20px;
        background-color: #f9f9f9;
        border-radius: 8px;
    }

    .custom-amount input {
        font-size: 1.2rem;
        padding: 12px;
        border-radius: 8px;
        border: 2px solid #e0e0e0;
    }

    /* Navigation Buttons */
    .wizard-navigation {
        display: flex;
        justify-content: space-between;
        margin-top: 40px;
    }

    .btn-wizard {
        padding: 12px 30px;
        font-weight: 600;
        font-size: 1.1rem;
        border-radius: 8px;
        transition: all 0.3s ease;
    }

    .btn-wizard-next {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
        color: white;
    }

    .btn-wizard-next:hover {
        background-color: #8B4513;
        border-color: #8B4513;
    }

    .btn-wizard-prev {
        background-color: white;
        border: 2px solid var(--primary-color);
        color: var(--primary-color);
    }

    .btn-wizard-prev:hover {
        background-color: rgba(160, 82, 45, 0.05);
    }

    /* Steps Hidden by Default */
    .wizard-step {
        display: none;
    }

    .wizard-step.active {
        display: block;
    }

    /* Icon Styles */
    .experience-card i {
        font-size: 3rem;
        color: var(--primary-color);
        margin-bottom: 15px;
    }

    /* Mensaje Card Styles */
    .mensaje-card {
        border: 1px solid #e0e0e0;
        transition: all 0.3s ease;
        margin-bottom: 15px;
    }

    .mensaje-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }

    .mensaje-card.border-success {
        border-color: #28a745 !important;
        background-color: rgba(40, 167, 69, 0.05);
    }
</style>
{% endblock %}

{% block content %}
<div class="wizard-container">
    <!-- Header -->
    <div class="wizard-header">
        <h1><i class="fas fa-gift me-2"></i>Regala una Experiencia Inolvidable</h1>
        <p>Crea una GiftCard personalizada con un mensaje √∫nico generado por IA</p>
    </div>

    <!-- Progress Bar -->
    <div class="wizard-progress">
        <div class="progress-steps">
            <div class="progress-line">
                <div class="progress-line-fill" id="progressFill" style="width: 14.28%;"></div>
            </div>
            <div class="progress-step active" data-step="1">1</div>
            <div class="progress-step" data-step="2">2</div>
            <div class="progress-step" data-step="3">3</div>
            <div class="progress-step" data-step="4">4</div>
            <div class="progress-step" data-step="5">5</div>
            <div class="progress-step" data-step="6">6</div>
            <div class="progress-step" data-step="7">7</div>
        </div>
        <div class="text-center mt-2">
            <small class="text-muted">Paso <span id="currentStep">1</span> de 7</small>
        </div>
    </div>

    <!-- Wizard Content -->
    <div class="wizard-content">
        <!-- STEP 1: Seleccionar Experiencia y Monto -->
        <div class="wizard-step active" id="step1">
            <h2 class="step-title">Elige la Experiencia</h2>
            <p class="step-subtitle">Selecciona qu√© experiencia quieres regalar</p>

            <div class="experience-grid" id="experienceGrid">
                {% for exp in experiencias %}
                <div class="experience-card exp-card" data-experience="{{ exp.id }}" data-exp-id="{{ exp.id }}" onclick="selectExperience('{{ exp.id }}')">
                    <i class="fas {% if exp.id == 'tinas' %}fa-hot-tub{% elif exp.id == 'masajes' %}fa-spa{% elif exp.id == 'cabanas' %}fa-home{% elif exp.id == 'alojamiento_tinas' %}fa-bed{% elif exp.id == 'celebracion' %}fa-champagne-glasses{% else %}fa-gift{% endif %}"></i>
                    <h5>{{ exp.nombre }}</h5>
                    <p>{{ exp.descripcion }}</p>
                    {% if exp.monto_fijo %}
                    <p class="text-success fw-bold fs-5 mt-2">${{ exp.monto_fijo|floatformat:0|intcomma }}</p>
                    {% endif %}
                </div>
                {% endfor %}
            </div>

            <div id="amountSelection" style="display:none;">
                <h3 class="text-center mb-3">Selecciona el Monto</h3>
                <div class="amount-options" id="amountOptions"></div>

                <div class="custom-amount">
                    <label class="form-label fw-bold">O ingresa un monto personalizado:</label>
                    <div class="input-group">
                        <span class="input-group-text">$</span>
                        <input type="number" class="form-control custom-amount-input" id="customAmount" placeholder="Ej: 85000" min="10000" step="1000">
                    </div>
                    <small class="text-muted">Monto m√≠nimo: $10.000</small>
                </div>
            </div>
        </div>

        <!-- STEP 2: Datos del Destinatario -->
        <div class="wizard-step" id="step2">
            <h2 class="step-title">Datos del Destinatario</h2>
            <p class="step-subtitle">¬øPara qui√©n es este regalo?</p>

            <form id="destinatarioForm">
                <div class="mb-4">
                    <label class="form-label fw-bold">Nombre o Apodo del Destinatario *</label>
                    <input type="text" class="form-control" id="destinatarioNombre" placeholder="Ej: Mar√≠a" required>
                    <small class="text-muted">Este nombre aparecer√° en el mensaje personalizado</small>
                </div>

                <div class="mb-4">
                    <label class="form-label fw-bold">Relaci√≥n Contigo *</label>
                    <input type="text" class="form-control" id="destinatarioRelacion" placeholder="Ej: esposa, mejor amiga, madre" required>
                    <small class="text-muted">Ayuda a la IA a crear un mensaje m√°s personal</small>
                </div>

                <div class="mb-4">
                    <label class="form-label fw-bold">Email del Destinatario *</label>
                    <input type="email" class="form-control" id="destinatarioEmail" placeholder="maria@ejemplo.com" required>
                    <small class="text-muted">Necesario para crear el perfil del destinatario como cliente</small>
                </div>

                <div class="mb-4">
                    <label class="form-label fw-bold">Tel√©fono del Destinatario *</label>
                    <input type="tel" class="form-control" id="destinatarioTelefono" placeholder="+56 9 1234 5678" required>
                    <small class="text-muted">Necesario para crear el perfil del destinatario como cliente</small>
                </div>
            </form>
        </div>

        <!-- STEP 3: Tipo de Mensaje -->
        <div class="wizard-step" id="step3">
            <h2 class="step-title">Elige el Tipo de Mensaje</h2>
            <p class="step-subtitle">¬øPara qu√© ocasi√≥n es este regalo?</p>

            <div class="experience-grid">
                {% for tipo in tipos_mensaje %}
                <div class="experience-card" data-tipo="{{ tipo.id }}" onclick="selectTipoMensaje('{{ tipo.id }}')">
                    <i class="fas {{ tipo.icono }}"></i>
                    <h3>{{ tipo.nombre }}</h3>
                    <p>{{ tipo.descripcion }}</p>
                </div>
                {% endfor %}
            </div>

            <div class="mt-4">
                <label class="form-label fw-bold">Detalle Especial (Opcional)</label>
                <textarea class="form-control" id="detalleEspecial" rows="3" placeholder="Ej: Celebrando 10 a√±os juntos, siempre me apoya en momentos dif√≠ciles..."></textarea>
                <small class="text-muted">Este detalle har√° el mensaje a√∫n m√°s personal y √∫nico</small>
            </div>
        </div>

        <!-- STEP 4: Generar Mensajes con IA -->
        <div class="wizard-step" id="step4">
            <h2 class="step-title">Mensaje Personalizado</h2>
            <p class="step-subtitle">Elige el mensaje que m√°s te guste generado por IA</p>

            <!-- Loading State -->
            <div id="mensajesLoading" class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <p class="mt-3 text-muted">Generando mensajes personalizados con IA...</p>
            </div>

            <!-- Mensajes Generados -->
            <div id="mensajesContainer" style="display:none;">
                <div id="mensajesList" class="row g-3 mb-4">
                    <!-- Los mensajes se insertar√°n aqu√≠ din√°micamente -->
                </div>

                <!-- Bot√≥n Regenerar -->
                <div class="text-center mb-3">
                    <button type="button" class="btn btn-outline-secondary" onclick="regenerarMensaje()">
                        <i class="fas fa-sync-alt me-2"></i>Generar Otro Mensaje
                    </button>
                </div>

                <!-- Mensaje Seleccionado -->
                <div id="mensajeSeleccionadoDiv" style="display:none;" class="alert alert-success">
                    <strong>Mensaje seleccionado:</strong>
                    <p id="mensajeSeleccionadoText" class="mb-0 mt-2"></p>
                </div>
            </div>

            <!-- Error State -->
            <div id="mensajesError" style="display:none;" class="alert alert-danger">
                <strong>Error al generar mensajes</strong>
                <p id="mensajesErrorText" class="mb-0 mt-2"></p>
                <button type="button" class="btn btn-sm btn-danger mt-2" onclick="generarMensajesIA()">
                    <i class="fas fa-redo me-2"></i>Reintentar
                </button>
            </div>
        </div>

        <!-- STEP 5: Preview -->
        <div class="wizard-step" id="step5">
            <h2 class="step-title">Vista Previa</h2>
            <p class="step-subtitle">As√≠ se ver√° tu GiftCard</p>

            <div class="d-flex justify-content-center py-4">
                <!-- GiftCard Preview Card -->
                <div class="card shadow-lg" style="max-width: 600px; width: 100%; border: 3px solid #ffc107;">
                    <div class="card-body p-4" style="background: linear-gradient(135deg, #fff8e1 0%, #ffffff 100%);">

                        <!-- Header -->
                        <div class="text-center mb-4">
                            <h3 class="mb-2" style="color: #A0522D; font-weight: 700;">
                                AREMKO SPA
                            </h3>
                            <h4 class="mb-3" style="color: #D2B48C;">
                                <i class="fas fa-gift me-2"></i>
                                Certificado de Regalo
                                <i class="fas fa-gift ms-2"></i>
                            </h4>
                            <hr style="border-color: #ffc107; border-width: 2px;">
                        </div>

                        <!-- Para -->
                        <div class="mb-4 text-center">
                            <p class="mb-2" style="color: #A0522D; font-size: 0.9rem;">Para:</p>
                            <h4 id="preview-destinatario" style="color: #5C4033; font-weight: 600;"></h4>
                        </div>

                        <!-- Mensaje Personalizado -->
                        <div class="mb-4 p-3" style="background-color: white; border-left: 4px solid #ffc107; border-radius: 8px;">
                            <p id="preview-mensaje" class="mb-0 fst-italic" style="color: #5C4033; line-height: 1.6;"></p>
                        </div>

                        <hr style="border-color: #D2B48C;">

                        <!-- Experiencia -->
                        <div class="row mb-3">
                            <div class="col-6 text-center">
                                <p class="mb-1" style="color: #A0522D; font-size: 0.85rem; font-weight: 600;">EXPERIENCIA</p>
                                <p id="preview-experiencia" style="color: #5C4033; font-size: 1.1rem; font-weight: 600;"></p>
                            </div>
                            <div class="col-6 text-center">
                                <p class="mb-1" style="color: #A0522D; font-size: 0.85rem; font-weight: 600;">VALOR</p>
                                <p id="preview-precio" style="color: #16a085; font-size: 1.3rem; font-weight: 700;"></p>
                            </div>
                        </div>

                        <!-- C√≥digo (simulado) -->
                        <div class="text-center mb-3">
                            <p class="mb-1" style="color: #A0522D; font-size: 0.85rem;">C√ìDIGO</p>
                            <p class="mb-0" style="color: #5C4033; font-family: 'Courier New', monospace; font-size: 1.2rem; font-weight: 700; letter-spacing: 2px;">
                                GC-XXXXXXXX
                            </p>
                        </div>

                        <!-- Validez -->
                        <div class="text-center mb-3">
                            <p class="mb-1" style="color: #A0522D; font-size: 0.85rem;">V√ÅLIDO HASTA</p>
                            <p id="preview-validez" class="mb-0" style="color: #5C4033; font-weight: 600;"></p>
                        </div>

                        <hr style="border-color: #D2B48C;">

                        <!-- C√≥mo usar -->
                        <div class="text-center">
                            <p class="mb-2" style="color: #A0522D; font-size: 0.85rem; font-weight: 600;">C√ìMO USAR</p>
                            <p class="mb-1" style="color: #5C4033; font-size: 0.9rem;">
                                <i class="fab fa-whatsapp text-success me-1"></i>
                                WhatsApp: <strong>+56 9 5790 2525</strong>
                            </p>
                            <p class="mb-0 text-muted small">
                                Menciona tu c√≥digo para reservar tu experiencia
                            </p>
                        </div>

                        <!-- Footer -->
                        <div class="text-center mt-4 pt-3" style="border-top: 1px solid #D2B48C;">
                            <p class="mb-0 small text-muted">www.aremko.cl | Puerto Varas</p>
                        </div>

                    </div>
                </div>
            </div>

            <!-- Nota informativa -->
            <div class="alert alert-info mx-auto" style="max-width: 600px;">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Nota:</strong> Esta es una vista previa. El c√≥digo definitivo y el PDF se generar√°n despu√©s del pago.
            </div>
        </div>

        <!-- STEP 6: Preview -->
        <!-- Ya existe arriba como step5 -->

        <!-- STEP 7: Datos del Comprador -->
        <div class="wizard-step" id="step7">
            <h2 class="step-title">Tus Datos</h2>
            <p class="step-subtitle">Necesitamos tus datos para completar la compra</p>

            <form id="compradorForm" class="mx-auto" style="max-width: 600px;">
                <div class="mb-4">
                    <label class="form-label fw-bold">Tel√©fono del Comprador *</label>
                    <input type="tel" class="form-control" id="compradorTelefono" placeholder="+56 9 1234 5678" required>
                    <small class="text-muted">Ingresa tu celular. Si ya eres cliente, autocompletaremos tus datos</small>
                    <div id="compradorBuscando" class="d-none mt-2">
                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                            <span class="visually-hidden">Buscando...</span>
                        </div>
                        <span class="ms-2 text-muted">Buscando tus datos...</span>
                    </div>
                    <div id="compradorEncontrado" class="d-none mt-2 alert alert-success py-2">
                        <i class="fas fa-check-circle me-2"></i>¬°Cliente encontrado! Datos autocompletados
                    </div>
                </div>

                <div class="mb-4">
                    <label class="form-label fw-bold">Nombre Completo *</label>
                    <input type="text" class="form-control" id="compradorNombre" placeholder="Ej: Juan P√©rez" required>
                </div>

                <div class="mb-4">
                    <label class="form-label fw-bold">Email *</label>
                    <input type="email" class="form-control" id="compradorEmail" placeholder="tu@email.com" required>
                    <small class="text-muted">Enviaremos la GiftCard a este correo</small>
                </div>

                <div class="mb-4">
                    <label class="form-label fw-bold">Regi√≥n *</label>
                    <select class="form-select" id="compradorRegion" required>
                        <option value="">Seleccione una regi√≥n</option>
                    </select>
                </div>

                <div class="mb-4">
                    <label class="form-label fw-bold">Comuna *</label>
                    <select class="form-select" id="compradorComuna" required disabled>
                        <option value="">Primero seleccione una regi√≥n</option>
                    </select>
                </div>
            </form>
        </div>

        <!-- STEP 8: Agregar al Carrito (antes era step 6) -->
        <div class="wizard-step" id="step8">
            <h2 class="step-title">¬°Tu GiftCard est√° Lista!</h2>
            <p class="step-subtitle">Agr√©gala al carrito para continuar con tu compra</p>

            <div class="text-center py-4">
                <!-- Resumen de la GiftCard -->
                <div class="card mx-auto" style="max-width: 500px;">
                    <div class="card-body">
                        <h5 class="card-title mb-4">
                            <i class="fas fa-gift text-warning me-2"></i>
                            Resumen de tu GiftCard
                        </h5>

                        <div class="text-start">
                            <p class="mb-2">
                                <strong>Experiencia:</strong>
                                <span id="resumen-experiencia"></span>
                            </p>
                            <p class="mb-2">
                                <strong>Para:</strong>
                                <span id="resumen-destinatario"></span>
                            </p>
                            <p class="mb-2">
                                <strong>Email destinatario:</strong>
                                <span id="resumen-email"></span>
                            </p>
                            <p class="mb-2">
                                <strong>Mensaje:</strong>
                            </p>
                            <p class="fst-italic text-muted small" id="resumen-mensaje" style="max-height: 100px; overflow-y: auto;">
                            </p>
                            <hr>
                            <p class="mb-2">
                                <strong>Comprador:</strong>
                                <span id="resumen-comprador"></span>
                            </p>
                            <p class="mb-2">
                                <strong>Email comprador:</strong>
                                <span id="resumen-comprador-email"></span>
                            </p>
                            <hr>
                            <p class="mb-0">
                                <strong>Precio:</strong>
                                <span class="text-success fs-4" id="resumen-precio"></span>
                            </p>
                        </div>

                        <div class="mt-4">
                            <button type="button" class="btn btn-warning btn-lg w-100 text-white fw-bold" id="btnAgregarAlCarrito">
                                <i class="fas fa-shopping-cart me-2"></i>
                                Agregar al Carrito
                            </button>
                            <p class="text-muted small mt-3 mb-0">
                                Despu√©s puedes seguir comprando o finalizar tu compra
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Loading state -->
                <div id="loadingCarrito" class="d-none mt-4">
                    <div class="spinner-border text-warning" role="status">
                        <span class="visually-hidden">Agregando al carrito...</span>
                    </div>
                    <p class="mt-2">Agregando al carrito...</p>
                </div>
            </div>
        </div>

        <!-- Navigation Buttons -->
        <div class="wizard-navigation">
            <button type="button" class="btn btn-wizard-prev" id="prevBtn" onclick="previousStep()" style="display:none;">
                <i class="fas fa-arrow-left me-2"></i>Anterior
            </button>
            <div></div> <!-- Spacer -->
            <button type="button" class="btn btn-wizard-next" id="nextBtn" onclick="nextStep()">
                Siguiente<i class="fas fa-arrow-right ms-2"></i>
            </button>
        </div>
    </div>
</div>

<script>
// Wizard State
let wizardData = {
    paso: 1,
    experiencia: null,
    monto: null,
    destinatario: {},
    tipoMensaje: null,
    detalleEspecial: '',
    mensajeSeleccionado: null,
    comprador: {}  // Nuevo: datos del comprador
};

// Datos de experiencias (desde el backend)
const experiencias = {{ experiencias|safe }};

// Seleccionar Experiencia
function selectExperience(expId) {
    // Remover selecci√≥n anterior
    document.querySelectorAll('.experience-card').forEach(card => {
        card.classList.remove('selected');
    });

    // Seleccionar nueva experiencia
    const card = document.querySelector(`[data-experience="${expId}"]`);
    card.classList.add('selected');

    wizardData.experiencia = expId;

    // Obtener experiencia seleccionada
    const exp = experiencias.find(e => e.id === expId);

    // Si tiene monto fijo, asignarlo directamente y ocultar selector
    if (exp.monto_fijo) {
        wizardData.monto = exp.monto_fijo;
        document.getElementById('amountSelection').style.display = 'none';
        console.log(`‚úÖ Experiencia "${exp.nombre}" seleccionada con monto fijo: $${exp.monto_fijo.toLocaleString('es-CL')}`);
    } else {
        // Mostrar selector de monto para "Monto Libre"
        showAmountOptions(exp.montos_sugeridos);
    }

    // Habilitar bot√≥n siguiente
    updateNextButton();
}

// Mostrar opciones de monto (solo para "Monto Libre")
function showAmountOptions(montos) {
    const amountSelection = document.getElementById('amountSelection');
    const amountOptions = document.getElementById('amountOptions');

    amountSelection.style.display = 'block';
    amountOptions.innerHTML = '';

    montos.forEach(monto => {
        const btn = document.createElement('button');
        btn.className = 'amount-btn';
        btn.textContent = `$${monto.toLocaleString('es-CL')}`;
        btn.onclick = () => selectAmount(monto);
        amountOptions.appendChild(btn);
    });
}

// Seleccionar Monto
function selectAmount(amount) {
    // Remover selecci√≥n anterior
    document.querySelectorAll('.amount-btn').forEach(btn => {
        btn.classList.remove('selected');
    });

    // Seleccionar nuevo monto
    event.target.classList.add('selected');
    wizardData.monto = amount;

    // Limpiar custom amount
    document.getElementById('customAmount').value = '';

    updateNextButton();
}

// Monto personalizado
document.getElementById('customAmount')?.addEventListener('input', function() {
    const amount = parseInt(this.value);
    if (amount >= 10000) {
        wizardData.monto = amount;

        // Deseleccionar botones de monto
        document.querySelectorAll('.amount-btn').forEach(btn => {
            btn.classList.remove('selected');
        });

        updateNextButton();
    }
});

// Seleccionar Tipo de Mensaje
function selectTipoMensaje(tipoId) {
    // Remover selecci√≥n anterior
    document.querySelectorAll('[data-tipo]').forEach(card => {
        card.classList.remove('selected');
    });

    // Seleccionar nuevo tipo
    const card = document.querySelector(`[data-tipo="${tipoId}"]`);
    card.classList.add('selected');

    wizardData.tipoMensaje = tipoId;

    updateNextButton();
}

// Actualizar bot√≥n siguiente
function updateNextButton() {
    const nextBtn = document.getElementById('nextBtn');
    const currentStep = wizardData.paso;

    let canProceed = false;

    if (currentStep === 1) {
        canProceed = wizardData.experiencia && wizardData.monto;
    } else if (currentStep === 2) {
        const nombre = document.getElementById('destinatarioNombre')?.value;
        const relacion = document.getElementById('destinatarioRelacion')?.value;
        const email = document.getElementById('destinatarioEmail')?.value;
        const telefono = document.getElementById('destinatarioTelefono')?.value;
        console.log('üîç Step 2 Validation:', { nombre, relacion, email, telefono });
        canProceed = nombre && relacion && email && telefono;
        console.log('‚úÖ Can proceed?', canProceed);
    } else if (currentStep === 3) {
        canProceed = wizardData.tipoMensaje;
    } else if (currentStep === 4) {
        canProceed = wizardData.mensajeSeleccionado !== null;
    } else if (currentStep === 7) {
        // Validar datos del comprador
        const telefono = document.getElementById('compradorTelefono')?.value;
        const nombre = document.getElementById('compradorNombre')?.value;
        const email = document.getElementById('compradorEmail')?.value;
        const region = document.getElementById('compradorRegion')?.value;
        const comuna = document.getElementById('compradorComuna')?.value;
        canProceed = telefono && nombre && email && region && comuna;
    } else {
        canProceed = true; // Otros pasos siempre pueden avanzar por ahora
    }

    nextBtn.disabled = !canProceed;
}

// Siguiente Paso
function nextStep() {
    const currentStep = wizardData.paso;

    // Guardar datos del paso actual
    if (currentStep === 2) {
        wizardData.destinatario = {
            nombre: document.getElementById('destinatarioNombre').value,
            relacion: document.getElementById('destinatarioRelacion').value,
            email: document.getElementById('destinatarioEmail').value,
            telefono: document.getElementById('destinatarioTelefono').value
        };
    } else if (currentStep === 3) {
        wizardData.detalleEspecial = document.getElementById('detalleEspecial').value;
    } else if (currentStep === 7) {
        // Guardar datos del comprador
        wizardData.comprador = {
            telefono: document.getElementById('compradorTelefono').value,
            nombre: document.getElementById('compradorNombre').value,
            email: document.getElementById('compradorEmail').value,
            region_id: document.getElementById('compradorRegion').value,
            comuna_id: document.getElementById('compradorComuna').value
        };
        console.log('‚úÖ Datos del comprador guardados:', wizardData.comprador);
    }

    // Avanzar paso
    if (currentStep < 8) {  // Cambio de 6 a 8
        wizardData.paso++;
        updateWizardUI();

        // Auto-generar mensajes al llegar a Step 4
        if (wizardData.paso === 4) {
            generarMensajesIA();
        }
    }
}

// Paso Anterior
function previousStep() {
    if (wizardData.paso > 1) {
        wizardData.paso--;
        updateWizardUI();
    }
}

// Actualizar UI del Wizard
function updateWizardUI() {
    const currentStep = wizardData.paso;

    // Ocultar todos los pasos
    document.querySelectorAll('.wizard-step').forEach(step => {
        step.classList.remove('active');
    });

    // Mostrar paso actual
    document.getElementById(`step${currentStep}`).classList.add('active');

    // Actualizar progress bar
    document.querySelectorAll('.progress-step').forEach((step, index) => {
        step.classList.remove('active', 'completed');
        if (index + 1 < currentStep) {
            step.classList.add('completed');
        } else if (index + 1 === currentStep) {
            step.classList.add('active');
        }
    });

    const progressPercentage = ((currentStep - 1) / 6) * 100;  // Cambio de 5 a 6 (7 pasos - 1)
    document.getElementById('progressFill').style.width = `${progressPercentage}%`;
    document.getElementById('currentStep').textContent = currentStep;

    // Mostrar/ocultar bot√≥n anterior
    document.getElementById('prevBtn').style.display = currentStep > 1 ? 'block' : 'none';

    // Actualizar estado del bot√≥n siguiente
    updateNextButton();
}

// Validar inputs en tiempo real (Step 2)
console.log('üìù Registrando event listeners para Step 2...');
const nombreInput = document.getElementById('destinatarioNombre');
const relacionInput = document.getElementById('destinatarioRelacion');
const emailInput = document.getElementById('destinatarioEmail');
const telefonoInput = document.getElementById('destinatarioTelefono');

console.log('Elementos encontrados:', {
    nombreInput: !!nombreInput,
    relacionInput: !!relacionInput,
    emailInput: !!emailInput,
    telefonoInput: !!telefonoInput
});

if (nombreInput) nombreInput.addEventListener('input', updateNextButton);
if (relacionInput) relacionInput.addEventListener('input', updateNextButton);
if (emailInput) emailInput.addEventListener('input', updateNextButton);
if (telefonoInput) telefonoInput.addEventListener('input', updateNextButton);

// ============================================
// STEP 4: GENERAR MENSAJES CON IA
// ============================================

// Generar mensajes personalizados con DeepSeek AI
async function generarMensajesIA() {
    console.log('ü§ñ Generando mensajes con IA...');

    // Mostrar loading, ocultar mensajes y errores
    document.getElementById('mensajesLoading').style.display = 'block';
    document.getElementById('mensajesContainer').style.display = 'none';
    document.getElementById('mensajesError').style.display = 'none';

    try {
        const response = await fetch('/ventas/api/giftcard/generar-mensajes/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                tipo_mensaje: wizardData.tipoMensaje,
                nombre: wizardData.destinatario.nombre,
                relacion: wizardData.destinatario.relacion,
                detalle: wizardData.detalleEspecial || '',
                cantidad: 3
            })
        });

        const data = await response.json();

        if (data.success) {
            console.log(`‚úÖ ${data.cantidad_generada} mensajes generados`);
            displayMensajes(data.mensajes);
        } else {
            throw new Error(data.error || 'Error al generar mensajes');
        }
    } catch (error) {
        console.error('‚ùå Error:', error);

        // Mostrar error
        document.getElementById('mensajesLoading').style.display = 'none';
        document.getElementById('mensajesError').style.display = 'block';
        document.getElementById('mensajesErrorText').textContent = error.message;
    }
}

// Mostrar mensajes generados como cards seleccionables
function displayMensajes(mensajes) {
    const container = document.getElementById('mensajesList');
    container.innerHTML = '';

    mensajes.forEach((mensaje, index) => {
        const col = document.createElement('div');
        col.className = 'col-12';

        const card = document.createElement('div');
        card.className = 'card mensaje-card';
        card.style.cursor = 'pointer';
        card.onclick = () => selectMensaje(index, mensaje);

        card.innerHTML = `
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <h6 class="card-subtitle text-muted mb-0">
                        <i class="fas fa-message me-2"></i>Opci√≥n ${index + 1}
                    </h6>
                    <i class="fas fa-check-circle text-success" style="display:none;" id="check-${index}"></i>
                </div>
                <p class="card-text mt-3" style="white-space: pre-wrap;">${mensaje}</p>
            </div>
        `;

        col.appendChild(card);
        container.appendChild(col);
    });

    // Ocultar loading, mostrar mensajes
    document.getElementById('mensajesLoading').style.display = 'none';
    document.getElementById('mensajesContainer').style.display = 'block';
}

// Seleccionar un mensaje
function selectMensaje(index, texto) {
    console.log(`‚úÖ Mensaje ${index + 1} seleccionado`);

    // Guardar en wizardData
    wizardData.mensajeSeleccionado = texto;

    // Actualizar UI - remover selecci√≥n previa
    document.querySelectorAll('.mensaje-card').forEach(card => {
        card.classList.remove('border-success');
        card.style.borderWidth = '1px';
    });

    document.querySelectorAll('[id^="check-"]').forEach(check => {
        check.style.display = 'none';
    });

    // Marcar card seleccionada
    const cards = document.querySelectorAll('.mensaje-card');
    cards[index].classList.add('border-success');
    cards[index].style.borderWidth = '2px';
    document.getElementById(`check-${index}`).style.display = 'block';

    // Mostrar mensaje seleccionado
    document.getElementById('mensajeSeleccionadoText').textContent = texto;
    document.getElementById('mensajeSeleccionadoDiv').style.display = 'block';

    // Habilitar bot√≥n siguiente
    updateNextButton();
}

// Regenerar mensaje (genera 1 mensaje adicional)
async function regenerarMensaje() {
    console.log('üîÑ Regenerando mensaje...');

    try {
        const response = await fetch('/ventas/api/giftcard/regenerar-mensaje/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                tipo_mensaje: wizardData.tipoMensaje,
                nombre: wizardData.destinatario.nombre,
                relacion: wizardData.destinatario.relacion,
                detalle: wizardData.detalleEspecial || ''
            })
        });

        const data = await response.json();

        if (data.success) {
            console.log('‚úÖ Nuevo mensaje generado');

            // Agregar nuevo mensaje al array existente
            const container = document.getElementById('mensajesList');
            const currentMessages = container.children.length;

            const col = document.createElement('div');
            col.className = 'col-12';

            const card = document.createElement('div');
            card.className = 'card mensaje-card';
            card.style.cursor = 'pointer';
            card.onclick = () => selectMensaje(currentMessages, data.mensaje);

            card.innerHTML = `
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="card-subtitle text-muted mb-0">
                            <i class="fas fa-message me-2"></i>Opci√≥n ${currentMessages + 1} <span class="badge bg-info">Nuevo</span>
                        </h6>
                        <i class="fas fa-check-circle text-success" style="display:none;" id="check-${currentMessages}"></i>
                    </div>
                    <p class="card-text mt-3" style="white-space: pre-wrap;">${data.mensaje}</p>
                </div>
            `;

            col.appendChild(card);
            container.appendChild(col);

            // Scroll al nuevo mensaje
            col.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        } else {
            throw new Error(data.error || 'Error al regenerar mensaje');
        }
    } catch (error) {
        console.error('‚ùå Error:', error);
        alert('Error al generar nuevo mensaje: ' + error.message);
    }
}

// Funci√≥n para actualizar el preview en Step 5
function actualizarPreviewStep5() {
    // Obtener el nombre de la experiencia seleccionada
    const expCard = document.querySelector(`.exp-card[data-exp-id="${wizardData.experiencia}"]`);
    const expNombre = expCard ? expCard.querySelector('h5').textContent.trim() : 'Experiencia Aremko';

    // Calcular fecha de validez (1 a√±o desde hoy)
    const hoy = new Date();
    const validezFecha = new Date(hoy.getFullYear() + 1, hoy.getMonth(), hoy.getDate());
    const validezStr = validezFecha.toLocaleDateString('es-CL', {
        day: '2-digit',
        month: 'long',
        year: 'numeric'
    });

    // Llenar preview
    document.getElementById('preview-destinatario').textContent = wizardData.destinatario.nombre;
    document.getElementById('preview-mensaje').textContent = wizardData.mensajeSeleccionado;
    document.getElementById('preview-experiencia').textContent = expNombre;
    document.getElementById('preview-precio').textContent = '$' + parseInt(wizardData.monto).toLocaleString('es-CL');
    document.getElementById('preview-validez').textContent = validezStr;
}

// Funci√≥n para actualizar el resumen en Step 6
function actualizarResumenStep6() {
    // Obtener el nombre de la experiencia seleccionada
    const expCard = document.querySelector(`.exp-card[data-exp-id="${wizardData.experiencia}"]`);
    const expNombre = expCard ? expCard.querySelector('h5').textContent.trim() : 'Experiencia Aremko';

    document.getElementById('resumen-experiencia').textContent = expNombre;
    document.getElementById('resumen-destinatario').textContent = wizardData.destinatario.nombre;
    document.getElementById('resumen-email').textContent = wizardData.destinatario.email;
    document.getElementById('resumen-mensaje').textContent = wizardData.mensajeSeleccionado;
    document.getElementById('resumen-precio').textContent = '$' + parseInt(wizardData.monto).toLocaleString('es-CL');
}

// Funci√≥n para actualizar el resumen en Step 8 (resumen final con comprador)
function actualizarResumenStep8() {
    // Obtener el nombre de la experiencia seleccionada
    const expCard = document.querySelector(`.exp-card[data-exp-id="${wizardData.experiencia}"]`);
    const expNombre = expCard ? expCard.querySelector('h5').textContent.trim() : 'Experiencia Aremko';

    document.getElementById('resumen-experiencia').textContent = expNombre;
    document.getElementById('resumen-destinatario').textContent = wizardData.destinatario.nombre;
    document.getElementById('resumen-email').textContent = wizardData.destinatario.email;
    document.getElementById('resumen-mensaje').textContent = wizardData.mensajeSeleccionado;
    document.getElementById('resumen-comprador').textContent = wizardData.comprador.nombre;
    document.getElementById('resumen-comprador-email').textContent = wizardData.comprador.email;
    document.getElementById('resumen-precio').textContent = '$' + parseInt(wizardData.monto).toLocaleString('es-CL');
}

// Event listener para el bot√≥n "Agregar al Carrito"
document.getElementById('btnAgregarAlCarrito').addEventListener('click', async function() {
    const btn = this;
    const loadingDiv = document.getElementById('loadingCarrito');

    try {
        // Mostrar loading
        btn.disabled = true;
        loadingDiv.classList.remove('d-none');

        // Obtener el nombre de la experiencia seleccionada
        console.log('üîç Buscando experiencia con ID:', wizardData.experiencia);
        const expCard = document.querySelector(`.exp-card[data-exp-id="${wizardData.experiencia}"]`);
        console.log('üìã Elemento encontrado:', expCard);
        const expNombre = expCard ? expCard.querySelector('h5').textContent.trim() : 'Experiencia Aremko';
        console.log('üè∑Ô∏è Nombre de experiencia extra√≠do:', expNombre);

        // Preparar datos para enviar
        const giftcardData = {
            experiencia_id: wizardData.experiencia,
            experiencia_nombre: expNombre,
            precio: wizardData.monto,
            destinatario_nombre: wizardData.destinatario.nombre,
            destinatario_email: wizardData.destinatario.email,
            destinatario_telefono: wizardData.destinatario.telefono || '',
            tipo_mensaje: wizardData.tipoMensaje,
            mensaje_seleccionado: wizardData.mensajeSeleccionado
        };

        console.log('üì§ Enviando GiftCard al carrito:', giftcardData);

        // Enviar al backend
        const response = await fetch('/ventas/api/giftcard/agregar-al-carrito/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(giftcardData)
        });

        console.log('üì° Response status:', response.status);

        // Verificar si la respuesta fue exitosa
        if (!response.ok) {
            const errorText = await response.text();
            console.error('‚ùå Error del servidor:', errorText);
            throw new Error(`Error del servidor (${response.status}): ${errorText}`);
        }

        const data = await response.json();
        console.log('üì• Response data:', data);

        if (data.success) {
            console.log('‚úÖ GiftCard agregada al carrito:', data);

            // Actualizar contador del carrito en navbar (si existe)
            const cartCount = document.getElementById('cartCount');
            if (cartCount) {
                cartCount.textContent = data.cart_count;
            }

            // Mostrar mensaje de √©xito
            alert(`üéâ ¬°GiftCard agregada al carrito!\n\nC√≥digo: ${data.codigo}\n\n¬øDeseas ir al carrito o seguir comprando?`);

            // Redirigir al carrito
            window.location.href = data.redirect_url;
        } else {
            throw new Error(data.error || 'Error al agregar al carrito');
        }

    } catch (error) {
        console.error('‚ùå Error completo:', error);
        alert('Error al agregar la GiftCard al carrito: ' + error.message);

        // Restaurar bot√≥n
        btn.disabled = false;
        loadingDiv.classList.add('d-none');
    }
});

// Modificar nextStep() para actualizar preview/resumen cuando llega a step 5, 6, o 8
const originalNextStep = nextStep;
nextStep = function() {
    const currentStep = wizardData.paso;

    // Llamar funci√≥n original
    originalNextStep();

    // Si llegamos a step 5, actualizar preview
    if (wizardData.paso === 5) {
        actualizarPreviewStep5();
    }

    // Si llegamos a step 6 (preview de GiftCard), actualizar preview
    if (wizardData.paso === 6) {
        actualizarPreviewStep5(); // Reutilizar la misma funci√≥n de preview
    }

    // Si llegamos a step 8 (resumen final), actualizar resumen completo
    if (wizardData.paso === 8) {
        actualizarResumenStep8();
    }
};

// ============================================
// STEP 7: AUTOCOMPLETAR DATOS DEL COMPRADOR
// ============================================

// Debounce timer para evitar m√∫ltiples requests
let buscarClienteTimer = null;

document.getElementById('compradorTelefono')?.addEventListener('input', function() {
    const telefono = this.value.trim();
    const buscandoDiv = document.getElementById('compradorBuscando');
    const encontradoDiv = document.getElementById('compradorEncontrado');

    // Limpiar timer anterior
    clearTimeout(buscarClienteTimer);

    // Ocultar mensajes
    buscandoDiv.classList.add('d-none');
    encontradoDiv.classList.add('d-none');

    // Si el tel√©fono tiene al menos 8 d√≠gitos, buscar
    const telefonoLimpio = telefono.replace(/[^\d]/g, '');
    if (telefonoLimpio.length >= 8) {
        // Mostrar loading
        buscandoDiv.classList.remove('d-none');

        // Buscar despu√©s de 500ms
        buscarClienteTimer = setTimeout(async () => {
            try {
                const response = await fetch('/ventas/api/giftcard/buscar-cliente/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ telefono: telefono })
                });

                const data = await response.json();

                buscandoDiv.classList.add('d-none');

                if (data.success && data.encontrado) {
                    // Cliente encontrado! Autocompletar campos
                    console.log('‚úÖ Cliente encontrado:', data.cliente);

                    document.getElementById('compradorNombre').value = data.cliente.nombre;
                    document.getElementById('compradorEmail').value = data.cliente.email;

                    // Autocompletar regi√≥n
                    if (data.cliente.region_id) {
                        document.getElementById('compradorRegion').value = data.cliente.region_id;
                        // Trigger change para cargar comunas
                        await cargarComunasComprador(data.cliente.region_id);

                        if (data.cliente.comuna_id) {
                            document.getElementById('compradorComuna').value = data.cliente.comuna_id;
                        }
                    }

                    // Mostrar mensaje de √©xito
                    encontradoDiv.classList.remove('d-none');

                    // Ocultar mensaje despu√©s de 3 segundos
                    setTimeout(() => {
                        encontradoDiv.classList.add('d-none');
                    }, 3000);

                    // Actualizar bot√≥n siguiente
                    updateNextButton();
                } else {
                    console.log('‚ÑπÔ∏è Cliente no encontrado, campos en blanco para nuevo cliente');
                }
            } catch (error) {
                console.error('‚ùå Error al buscar cliente:', error);
                buscandoDiv.classList.add('d-none');
            }
        }, 500);
    }
});

// Cargar regiones para el comprador
async function cargarRegionesComprador() {
    try {
        const response = await fetch('/api/regions/');
        const regiones = await response.json();

        const select = document.getElementById('compradorRegion');
        select.innerHTML = '<option value="">Seleccione una regi√≥n</option>';

        regiones.forEach(region => {
            const option = document.createElement('option');
            option.value = region.id;
            option.textContent = region.nombre;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Error al cargar regiones:', error);
    }
}

// Cargar comunas para el comprador
async function cargarComunasComprador(regionId) {
    try {
        const response = await fetch(`/api/comunas/${regionId}/`);
        const comunas = await response.json();

        const select = document.getElementById('compradorComuna');
        select.innerHTML = '<option value="">Seleccione una comuna</option>';
        select.disabled = false;

        comunas.forEach(comuna => {
            const option = document.createElement('option');
            option.value = comuna.id;
            option.textContent = comuna.nombre;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Error al cargar comunas:', error);
    }
}

// Event listener para cambio de regi√≥n
document.getElementById('compradorRegion')?.addEventListener('change', function() {
    const regionId = this.value;
    if (regionId) {
        cargarComunasComprador(regionId);
    } else {
        const comunaSelect = document.getElementById('compradorComuna');
        comunaSelect.innerHTML = '<option value="">Primero seleccione una regi√≥n</option>';
        comunaSelect.disabled = true;
    }
    updateNextButton();
});

// Event listener para validaci√≥n de campos del comprador
document.getElementById('compradorNombre')?.addEventListener('input', updateNextButton);
document.getElementById('compradorEmail')?.addEventListener('input', updateNextButton);
document.getElementById('compradorComuna')?.addEventListener('change', updateNextButton);

// Cargar regiones al inicializar
if (document.getElementById('compradorRegion')) {
    cargarRegionesComprador();
}

// Inicializar
updateNextButton();
</script>
{% endblock %}
