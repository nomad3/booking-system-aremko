{% extends "admin/base_site.html" %}
{% load static i18n %}

{% block extrastyle %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static 'css/modern.css' %}"> {# Ensure modern styles are loaded #}
    <style>
        .segment-card {
            border-left: 5px solid #0d6efd; /* Example color */
            margin-bottom: 1rem;
            color: #333; /* Set base dark color for text inside the card */
        }
        .segment-card .card-header {
            background-color: #f8f9fa;
            font-weight: bold;
            color: #333; /* Explicitly set dark color for header text */
        }
        .segment-count {
            font-size: 1.5rem;
            font-weight: bold;
             /* Color will be inherited from .segment-card */
        }
        .segment-card .text-muted {
            color: #555 !important; /* Override Bootstrap's text-muted color */
        }
    </style>
{% endblock %}


{% block breadcrumbs %}
<div class="breadcrumbs">
<a href="{% url 'admin:index' %}">{% translate 'Home' %}</a>
&rsaquo; <a href="{% url 'admin:app_list' app_label='ventas' %}">Ventas</a>
&rsaquo; Segmentación de Clientes
</div>
{% endblock %}

{% block content %}
<div class="modern-container mt-4">
    <div class="page-header mb-4">
        <h1>Segmentación de Clientes</h1>
        <p>Resumen de clientes categorizados por gasto total (incluye servicios históricos y actuales).</p>
        <p>Total Clientes Analizados: {{ total_clients }}</p>
    </div>

    <div class="row g-4">
        {% for key, segment in segments.items %}
        <div class="col-md-6 col-lg-6">
            <div class="card segment-card shadow-sm h-100">
                <div class="card-header">
                    {{ segment.label }}
                </div>
                <div class="card-body text-center">
                    <p class="segment-count">{{ segment.count }}</p>
                    <p class="text-muted">Cliente{% if segment.count != 1 %}s{% endif %}</p>
                    <a href="{% url 'ventas:client_list_by_segment' segment_name=key %}" class="btn btn-sm btn-outline-primary mt-2">Ver Clientes</a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Filtro Personalizado -->
    <div class="card mt-4">
        <div class="card-header" style="background-color: #28a745; color: white;">
            <strong>🎯 Filtro Personalizado de Clientes</strong>
        </div>
        <div class="card-body">
            <p class="mb-3">Define tu propio segmento personalizado por rango de gasto y comuna:</p>
            <form action="{% url 'ventas:client_list_custom_filter' %}" method="GET" class="row g-3">
                <div class="col-md-4">
                    <label for="gasto_min" class="form-label"><strong>Gasto Mínimo (CLP):</strong></label>
                    <input type="number" class="form-control" id="gasto_min" name="gasto_min"
                           min="0" step="1000" placeholder="Ej: 50000" value="0">
                    <small class="text-muted">Dejar en 0 para sin límite inferior</small>
                </div>
                <div class="col-md-4">
                    <label for="gasto_max" class="form-label"><strong>Gasto Máximo (CLP):</strong></label>
                    <input type="number" class="form-control" id="gasto_max" name="gasto_max"
                           min="0" step="1000" placeholder="Ej: 200000">
                    <small class="text-muted">Dejar vacío para sin límite superior</small>
                </div>
                <div class="col-md-4">
                    <label for="comuna" class="form-label"><strong>Comuna:</strong></label>
                    <select class="form-select" id="comuna" name="comuna">
                        <option value="todas" selected>Todas las comunas</option>
                        {% for c in comunas %}
                        <option value="{{ c.id }}">{{ c.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-12 text-center mt-3">
                    <button type="submit" class="btn btn-success btn-lg">
                        <i class="fas fa-filter"></i> Aplicar Filtro Personalizado
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="card mt-4">
         <div class="card-header">
             Definición de Segmentos
         </div>
         <div class="card-body">
             <p>Los clientes se segmentan <strong>únicamente por su gasto total</strong> (incluye servicios históricos y actuales):</p>
             <ul>
                  <li><strong>Bajo Gasto:</strong> Menos de ${{ spend_threshold_medium|floatformat:0 }}</li>
                  <li><strong>Gasto Medio:</strong> Entre ${{ spend_threshold_medium|floatformat:0 }} y ${{ spend_threshold_high|add:"-1"|floatformat:0 }}</li>
                  <li><strong>Alto Gasto:</strong> ${{ spend_threshold_high|floatformat:0 }} o más</li>
                  <li><strong>Sin Gasto Registrado:</strong> Clientes sin ventas/reservas asociadas</li>
             </ul>
             <p class="mb-0"><strong>Nota:</strong> Esta segmentación combina datos históricos (CSV importado) y servicios actuales del sistema para una visión completa de cada cliente.</p>
             <p class="mt-2">Utilice esta información para crear campañas de marketing dirigidas en la sección de Campañas.</p>
         </div>
    </div>

</div>
{% endblock %}
