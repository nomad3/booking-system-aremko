{% extends "ventas/base_public.html" %}
{% load static %}
{% load humanize %}
{% load ventas_extras %}

{% block title %}
{% if seo_content and seo_content.meta_title %}
    {{ seo_content.meta_title }}
{% else %}
    {{ categoria_actual.nombre }} en Puerto Varas | Aremko Spa - Relajación y Bienestar
{% endif %}
{% endblock %}

{% block meta_description %}
{% if seo_content and seo_content.meta_description %}
    <meta name="description" content="{{ seo_content.meta_description }}">
{% else %}
    <meta name="description" content="Descubre los mejores {{ categoria_actual.nombre|lower }} en Aremko Spa Puerto Varas. Experiencias únicas de relajación y bienestar. Reserva online y disfruta de promociones exclusivas.">
{% endif %}
{% endblock %}

{% block extra_head %}
<!-- Open Graph Tags -->
<meta property="og:title" content="{% if seo_content and seo_content.meta_title %}{{ seo_content.meta_title }}{% else %}{{ categoria_actual.nombre }} | Aremko Spa Puerto Varas{% endif %}">
<meta property="og:description" content="{% if seo_content and seo_content.meta_description %}{{ seo_content.meta_description }}{% else %}Experiencias únicas de {{ categoria_actual.nombre|lower }} en Puerto Varas{% endif %}">
<meta property="og:type" content="website">
<meta property="og:url" content="{{ canonical_url }}">
{% if category_hero_image %}
<meta property="og:image" content="{{ category_hero_image }}">
{% endif %}

<!-- Schema.org JSON-LD -->
{% if categoria_actual.id == 3 %}
<!-- Schema específico para Alojamientos/Cabañas -->
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "LodgingBusiness",
    "name": "Cabañas Aremko - Alojamiento de Lujo en Puerto Varas",
    "description": "{% if seo_content and seo_content.meta_description %}{{ seo_content.meta_description }}{% else %}Cabañas exclusivas con spa privado en Puerto Varas. Refugio de lujo con vista al Río Pescado, calefacción, WiFi y servicios premium de spa.{% endif %}",
    "url": "{{ canonical_url }}",
    {% if category_hero_image %}"image": "{{ category_hero_image }}",{% endif %}
    "telephone": "+56957902525",
    "email": "contacto@aremko.cl",
    "address": {
        "@type": "PostalAddress",
        "streetAddress": "Río Pescado",
        "addressLocality": "Puerto Varas",
        "addressRegion": "Los Lagos",
        "postalCode": "5550000",
        "addressCountry": "CL"
    },
    "geo": {
        "@type": "GeoCoordinates",
        "latitude": -41.3196,
        "longitude": -72.9818
    },
    "amenityFeature": [
        {"@type": "LocationFeatureSpecification", "name": "WiFi Gratis"},
        {"@type": "LocationFeatureSpecification", "name": "Calefacción"},
        {"@type": "LocationFeatureSpecification", "name": "Vista al Río"},
        {"@type": "LocationFeatureSpecification", "name": "Spa Privado"},
        {"@type": "LocationFeatureSpecification", "name": "Estacionamiento"},
        {"@type": "LocationFeatureSpecification", "name": "Desayuno incluido"}
    ],
    "starRating": {
        "@type": "Rating",
        "ratingValue": "5",
        "bestRating": "5"
    },
    "priceRange": "$150000-$200000 CLP",
    {% if servicios %}
    "hasOfferCatalog": {
        "@type": "OfferCatalog",
        "name": "Cabañas Disponibles",
        "itemListElement": [
            {% for servicio in servicios %}
            {
                "@type": "Offer",
                "itemOffered": {
                    "@type": "LodgingReservation",
                    "name": "{{ servicio.nombre }}",
                    "description": "Cabaña de lujo para 2 personas con todas las comodidades premium"
                },
                "price": "{{ servicio.precio_base }}",
                "priceCurrency": "CLP",
                "availability": "https://schema.org/InStock"
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ]
    }
    {% endif %}
}
</script>
{% else %}
<!-- Schema estándar para otras categorías -->
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "LocalBusiness",
    "name": "Aremko Spa - {{ categoria_actual.nombre }}",
    "description": "{% if seo_content and seo_content.meta_description %}{{ seo_content.meta_description }}{% else %}Servicios de {{ categoria_actual.nombre|lower }} en Puerto Varas{% endif %}",
    "url": "{{ canonical_url }}",
    {% if category_hero_image %}"image": "{{ category_hero_image }}",{% endif %}
    "address": {
        "@type": "PostalAddress",
        "addressLocality": "Puerto Varas",
        "addressRegion": "Los Lagos",
        "addressCountry": "CL"
    },
    "priceRange": "$$",
    {% if servicios %}
    "hasOfferCatalog": {
        "@type": "OfferCatalog",
        "name": "{{ categoria_actual.nombre }}",
        "itemListElement": [
            {% for servicio in servicios %}
            {
                "@type": "Offer",
                "itemOffered": {
                    "@type": "Service",
                    "name": "{{ servicio.nombre }}",
                    "description": "{{ servicio.nombre }} - Duración: {{ servicio.duracion|duration_in_hours }}"
                },
                "price": "{{ servicio.precio_base }}",
                "priceCurrency": "CLP"
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ]
    }
    {% endif %}
}
</script>
{% endif %}

{% if seo_content and seo_content.get_faqs %}
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "FAQPage",
    "mainEntity": [
        {% for faq in seo_content.get_faqs %}
        {
            "@type": "Question",
            "name": "{{ faq.pregunta }}",
            "acceptedAnswer": {
                "@type": "Answer",
                "text": "{{ faq.respuesta }}"
            }
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ]
}
</script>
{% endif %}

<!-- Google Ads: Evento de conversión para página de Masajes -->
{% if categoria_actual.id == 2 %}
<script>
    // Evento de page_view para rastrear visitas a la página de masajes
    gtag('event', 'page_view', {
        'send_to': 'AW-1767221019',
        'page_title': '{{ categoria_actual.nombre }}',
        'page_location': '{{ canonical_url }}'
    });
</script>
{% endif %}
{% endblock %}

{% block extra_style %}
<style>
/* Category header styles */
.category-header {
    position: relative;
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    padding: 120px 0;
    margin-bottom: 50px;
    text-align: center;
    background: linear-gradient(135deg, #8B4513 0%, #A0522D 100%);
}

.category-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1;
}

.category-header .container {
    position: relative;
    z-index: 2;
}

.category-header h1 {
    color: #ffffff;
    font-weight: 700;
    font-size: 3rem;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    margin: 0;
}

.category-subtitle {
    color: #ffffff;
    font-size: 1.2rem;
    margin-top: 15px;
    opacity: 0.95;
}

/* Main content section */
.content-section {
    padding: 60px 0;
    background-color: #f8f9fa;
}

.content-text {
    font-size: 1.1rem;
    line-height: 1.8;
    color: #333;
    margin-bottom: 30px;
}

/* Benefits section */
.benefits-section {
    padding: 40px 0;
}

.benefit-card {
    background: white;
    border-radius: 10px;
    padding: 30px;
    margin-bottom: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    transition: transform 0.3s ease;
}

.benefit-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 20px rgba(0,0,0,0.15);
}

.benefit-card h3 {
    color: var(--primary-color);
    margin-bottom: 15px;
}

/* Services section */
.service-card .card {
    transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
}

.service-card .card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
}

.service-card .price {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--primary-color);
}

.section-title {
    text-align: center;
    font-weight: 700;
    color: var(--dark-gray);
    position: relative;
    padding-bottom: 15px;
    margin-bottom: 40px;
}

.section-title::after {
    content: '';
    position: absolute;
    display: block;
    width: 60px;
    height: 3px;
    background: var(--primary-color);
    bottom: 0;
    left: calc(50% - 30px);
}

/* FAQ Section */
.faq-section {
    padding: 60px 0;
    background-color: #fff;
}

.faq-item {
    margin-bottom: 20px;
}

.faq-question {
    background: linear-gradient(135deg, #8B4513 0%, #A0522D 100%);
    color: white;
    padding: 15px 20px;
    border-radius: 5px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.3s ease;
}

.faq-question:hover {
    box-shadow: 0 3px 10px rgba(0,0,0,0.2);
}

.faq-question::after {
    content: '+';
    font-size: 1.5rem;
    transition: transform 0.3s ease;
}

.faq-item.active .faq-question::after {
    transform: rotate(45deg);
}

.faq-answer {
    padding: 20px;
    background: #f8f9fa;
    border-radius: 0 0 5px 5px;
    display: none;
}

.faq-item.active .faq-answer {
    display: block;
}

/* Smooth scroll behavior */
html {
    scroll-behavior: smooth;
}

/* Amenities icons for cabins */
.amenities {
    border-top: 1px solid #eee;
    padding-top: 8px;
    margin-top: 8px;
}

.amenities i {
    color: var(--primary-color);
}

/* Lead text style */
.lead {
    font-weight: 300;
    line-height: 1.6;
}

/* Botón Conoce más */
.btn-outline-primary:hover {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
}

/* CTA Section */
.cta-section {
    background: linear-gradient(135deg, #8B4513 0%, #A0522D 100%);
    color: white;
    padding: 60px 0;
    text-align: center;
    margin-top: 60px;
}

.cta-section h2 {
    margin-bottom: 20px;
}

.cta-section .btn {
    font-size: 1.1rem;
    padding: 12px 30px;
}

/* Anchor offset para navegación con header fijo */
#descripcion-completa {
    scroll-margin-top: 80px;
}

@media (max-width: 768px) {
    .category-header {
        padding: 80px 0;
    }

    .category-header h1 {
        font-size: 2rem;
    }

    .content-text {
        font-size: 1rem;
    }

    .lead {
        font-size: 1.1rem !important;
    }
}
</style>
{% endblock %}

{% block content %}

<!-- Category Header Hero -->
<section class="category-header" {% if category_hero_image %}style="background-image: url('{{ category_hero_image }}');"{% endif %}>
    <div class="container">
        <h1>{{ categoria_actual.nombre }}</h1>
        {% if seo_content and seo_content.subtitulo_principal %}
            <p class="category-subtitle">{{ seo_content.subtitulo_principal }}</p>
        {% else %}
            <p class="category-subtitle">Experiencias únicas de relajación en Puerto Varas</p>
        {% endif %}
    </div>
</section>

<!-- Introducción Breve para Alojamientos -->
{% if categoria_actual.id == 3 %}
<section class="content-section py-4">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-10 text-center">
                <p class="lead" style="font-size: 1.2rem; color: #333;">
                    Vive una experiencia única de alojamiento en nuestras exclusivas cabañas en Puerto Varas.
                    Refugio de lujo con vista al Río Pescado, combinando el confort moderno con la calidez de la arquitectura patagónica.
                </p>
                <a href="#descripcion-completa" class="btn btn-outline-primary mt-3" style="text-decoration: none;">
                    <i class="fas fa-chevron-down me-2"></i>Conoce más sobre nuestras cabañas
                </a>
            </div>
        </div>
    </div>
</section>
{% endif %}

<!-- Services Section (Movido arriba para mejor UX) -->
<section class="container mb-5" id="servicios-categoria">
    <h2 class="section-title mb-4">
        {% if categoria_actual.id == 3 %}
            Nuestras Cabañas Disponibles
        {% else %}
            Servicios Disponibles
        {% endif %}
    </h2>

    <div class="row">
        {% for servicio in servicios %}
            <div class="col-lg-4 col-md-6 mb-4 service-card">
                <div class="card h-100">
                    {% if servicio.imagen %}
                        <img src="{{ servicio.imagen.url }}" class="card-img-top"
                             alt="{% if categoria_actual.id == 3 %}{{ servicio.nombre }} - Cabaña de lujo en Puerto Varas con spa privado{% else %}{{ servicio.nombre }} en Aremko Spa Puerto Varas{% endif %}"
                             loading="lazy"
                             title="{{ servicio.nombre }}">
                    {% endif %}
                    <div class="card-body d-flex flex-column">
                        <h3 class="card-title h5">{{ servicio.nombre }}</h3>
                        {% if servicio.tipo_servicio == 'cabana' %}
                            <p class="price">${{ servicio.precio_base|floatformat:0|intcomma }} <small class="text-muted">(Precio por cabaña, máx 2 pers.)</small></p>
                            <div class="amenities mb-2">
                                <small class="text-muted">
                                    <i class="fas fa-wifi me-1"></i> WiFi •
                                    <i class="fas fa-temperature-high me-1"></i> Calefacción •
                                    <i class="fas fa-hot-tub me-1"></i> Spa
                                </small>
                            </div>
                        {% else %}
                            <p class="price">${{ servicio.precio_base|floatformat:0|intcomma }} <small class="text-muted">por persona</small></p>
                        {% endif %}
                        <p class="card-text"><small class="text-muted">Duración: {{ servicio.duracion|duration_in_hours }}</small></p>
                        <button class="btn btn-primary w-100 mt-auto js-open-booking-modal"
                                data-servicio-id="{{ servicio.id }}"
                                data-servicio-nombre="{{ servicio.nombre|escapejs }}"
                                data-servicio-precio="{{ servicio.precio_base }}"
                                data-servicio-tipo="{{ servicio.tipo_servicio }}">
                            <i class="fas fa-calendar-plus me-2"></i>Reservar Ahora
                        </button>
                    </div>
                </div>
            </div>
        {% empty %}
            <div class="col-12">
                <p class="text-center">No hay servicios disponibles en esta categoría en este momento.</p>
            </div>
        {% endfor %}
    </div>
</section>

<!-- Main Content Section (Movido después de los servicios) -->
<section class="content-section" id="descripcion-completa">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <h2 class="section-title mb-4">
                    {% if categoria_actual.id == 3 %}
                        Sobre Nuestras Cabañas
                    {% else %}
                        Acerca de {{ categoria_actual.nombre }}
                    {% endif %}
                </h2>
                {% if seo_content and seo_content.contenido_principal %}
                    <div class="content-text">
                        {{ seo_content.contenido_principal|linebreaks }}
                    </div>
                {% else %}
                    <!-- Default content when SEO content is not available -->
                    <div class="content-text">
                        {% if categoria_actual.id == 3 %}
                            <p>Imagina despertar con vista al Río Pescado, disfrutar de un desayuno sureño y terminar el día relajándote en tu tina caliente junto al Río Pescado en medio de un antiguo bosque nativo. Nuestras cabañas están completamente equipadas con todas las comodidades premium: cama de dos plazas, calefacción mediante aire acondicionado, Wi-Fi de alta velocidad con fibra óptica.</p>
                            <p>Perfectas para lunas de miel, aniversarios o simplemente para reconectar con tu pareja, nuestras cabañas ofrecen el escenario ideal para crear recuerdos inolvidables. Complementa tu estadía con nuestros servicios de masajes.</p>
                        {% else %}
                            <p>Descubre nuestros servicios de {{ categoria_actual.nombre|lower }} en Aremko Spa Puerto Varas. Ofrecemos experiencias únicas diseñadas para tu bienestar y relajación total. Nuestro equipo de profesionales está comprometido con brindarte momentos inolvidables en un ambiente de tranquilidad y armonía.</p>
                            <p>Cada servicio está cuidadosamente diseñado para proporcionarte los máximos beneficios, utilizando técnicas especializadas y productos de la más alta calidad. Ya sea que busques relajación profunda, alivio del estrés o simplemente un momento para ti, tenemos la experiencia perfecta para ti.</p>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</section>

<!-- Benefits Section -->
{% if seo_content and seo_content.get_beneficios %}
<section class="benefits-section">
    <div class="container">
        <h2 class="section-title mb-5">Beneficios de Nuestros {{ categoria_actual.nombre }}</h2>
        <div class="row">
            {% for beneficio in seo_content.get_beneficios %}
            <div class="col-md-4 mb-4">
                <div class="benefit-card">
                    <h3>{{ beneficio.titulo }}</h3>
                    <p>{{ beneficio.descripcion }}</p>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</section>
{% endif %}

<!-- FAQ Section -->
{% if seo_content and seo_content.get_faqs %}
<section class="faq-section">
    <div class="container">
        <h2 class="section-title mb-5">Preguntas Frecuentes</h2>
        <div class="row justify-content-center">
            <div class="col-lg-8">
                {% for faq in seo_content.get_faqs %}
                <div class="faq-item">
                    <div class="faq-question">
                        <span>{{ faq.pregunta }}</span>
                    </div>
                    <div class="faq-answer">
                        <p>{{ faq.respuesta }}</p>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</section>
{% else %}
<!-- Default FAQs when SEO content is not available -->
<section class="faq-section">
    <div class="container">
        <h2 class="section-title mb-5">Preguntas Frecuentes</h2>
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="faq-item">
                    <div class="faq-question">
                        <span>¿Cómo puedo hacer una reserva?</span>
                    </div>
                    <div class="faq-answer">
                        <p>Puedes hacer tu reserva directamente desde nuestra página web seleccionando el servicio deseado, eligiendo fecha y hora disponible, o contactándonos por WhatsApp.</p>
                    </div>
                </div>
                <div class="faq-item">
                    <div class="faq-question">
                        <span>¿Cuál es la política de cancelación?</span>
                    </div>
                    <div class="faq-answer">
                        <p>Puedes cancelar o reprogramar tu reserva con al menos 24 horas de anticipación sin costo alguno. Cancelaciones con menos de 24 horas están sujetas a penalización.</p>
                    </div>
                </div>
                <div class="faq-item">
                    <div class="faq-question">
                        <span>¿Qué debo llevar para mi sesión?</span>
                    </div>
                    <div class="faq-answer">
                        <p>Para tu comodidad, proporcionamos todo lo necesario: toallas, batas, sandalias y productos de higiene. Solo necesitas traer tu traje de baño si reservaste servicios de tina.</p>
                    </div>
                </div>
                <div class="faq-item">
                    <div class="faq-question">
                        <span>¿Ofrecen descuentos para grupos?</span>
                    </div>
                    <div class="faq-answer">
                        <p>Sí, ofrecemos tarifas especiales para grupos de 4 personas o más. Contáctanos directamente para recibir una cotización personalizada.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endif %}

<!-- CTA Section -->
<section class="cta-section">
    <div class="container">
        <h2>¿Listo para tu experiencia de relajación?</h2>
        <p class="mb-4">Reserva ahora y disfruta de un momento único en Aremko Spa</p>
        <a href="{% url 'ventas:homepage' %}#servicios" class="btn btn-light btn-lg">Ver Todos los Servicios</a>
    </div>
</section>

{% endblock %}

{% block modals %}
<!-- Booking Modal -->
<div class="modal fade" id="bookingModal" tabindex="-1" aria-labelledby="bookingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bookingModalLabel">Reservar Servicio</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="bookingForm" class="booking-form">
                    {% csrf_token %}
                    <input type="hidden" id="servicioId" name="servicio_id">

                    <div class="mb-3">
                        <label for="servicioNombre" class="form-label">Servicio</label>
                        <input type="text" class="form-control" id="servicioNombre" readonly>
                    </div>

                    <div class="mb-3">
                        <label for="fecha" class="form-label">Fecha</label>
                        <input type="text" class="form-control" id="fecha" name="fecha" placeholder="Selecciona una fecha" required>
                    </div>

                    <div class="mb-3">
                        <label for="hora" class="form-label">Hora</label>
                        <select class="form-select" id="hora" name="hora" required>
                            <option value="">Selecciona una hora</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="cantidadPersonas" class="form-label">Cantidad de Personas</label>
                        <select class="form-select" id="cantidadPersonas" name="cantidad_personas">
                            <option value="1">1 persona</option>
                            <option value="2">2 personas</option>
                            <option value="3">3 personas</option>
                            <option value="4">4 personas</option>
                            <option value="5">5 personas</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="precioTotal" class="form-label">Precio Total</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="text" class="form-control" id="precioTotal" readonly>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="addToCartBtn">Agregar al Carrito</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_script %}
<script>
    // Function to get CSRF token from cookies
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Helper function to format numbers as CLP
    function formatCLP(value) {
        const numberValue = Number(value);
        if (isNaN(numberValue)) {
            return '0';
        }
        return new Intl.NumberFormat('es-CL', {
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        }).format(numberValue);
    }

    // FAQ Accordion functionality
    document.querySelectorAll('.faq-question').forEach(question => {
        question.addEventListener('click', () => {
            const faqItem = question.parentElement;
            faqItem.classList.toggle('active');

            // Close other FAQs
            document.querySelectorAll('.faq-item').forEach(item => {
                if (item !== faqItem) {
                    item.classList.remove('active');
                }
            });
        });
    });

    // Global variables for the booking modal
    let currentServicioId = null;
    let currentServicioNombre = null;
    let currentServicioPrecio = 0;
    let currentServicioTipo = 'otro';

    // Function to load available hours
    function loadAvailableHours(servicioId, fecha) {
        const horaSelect = document.getElementById('hora');
        if (!horaSelect) return;
        horaSelect.innerHTML = '<option value="">Cargando horas...</option>';
        horaSelect.disabled = true;

        fetch(`{% url 'ventas:get_available_hours' %}?servicio_id=${servicioId}&fecha=${fecha}`)
            .then(response => response.ok ? response.json() : Promise.reject(`HTTP error! status: ${response.status}`))
            .then(data => {
                horaSelect.innerHTML = '<option value="">Selecciona una hora</option>';
                if (data.success && data.horas_disponibles.length > 0) {
                    data.horas_disponibles.forEach(hora => {
                        const option = document.createElement('option');
                        option.value = hora;
                        option.textContent = hora;
                        horaSelect.appendChild(option);
                    });
                    horaSelect.disabled = false;
                } else {
                    horaSelect.innerHTML = '<option value="">No hay horas disponibles</option>';
                }
            })
            .catch(error => {
                console.error('Error fetching available hours:', error);
                horaSelect.innerHTML = '<option value="">Error al cargar horas</option>';
            });
    }

    // Function to update total price
    function updatePrecioTotal() {
        const cantidadPersonasSelect = document.getElementById('cantidadPersonas');
        const precioTotalInput = document.getElementById('precioTotal');
        if (cantidadPersonasSelect && precioTotalInput) {
            const cantidadPersonas = parseInt(cantidadPersonasSelect.value);
            let precioTotal = 0;

            if (currentServicioTipo === 'cabana') {
                precioTotal = currentServicioPrecio;
            } else {
                precioTotal = currentServicioPrecio * cantidadPersonas;
            }
            precioTotalInput.value = formatCLP(precioTotal);
        }

        const horaSelect = document.getElementById('hora');
        if (horaSelect && horaSelect.value) {
            validateSelectedSlot();
        }
    }

    // Function to check availability of the selected slot
    async function validateSelectedSlot() {
        const servicioId = document.getElementById('servicioId').value;
        const fecha = document.getElementById('fecha').value;
        const hora = document.getElementById('hora').value;
        const addToCartBtn = document.getElementById('addToCartBtn');
        const horaSelect = document.getElementById('hora');

        const existingWarning = horaSelect.parentNode.querySelector('.text-danger');
        if (existingWarning) existingWarning.remove();

        if (!servicioId || !fecha || !hora) {
            addToCartBtn.disabled = true;
            return;
        }

        addToCartBtn.disabled = true;

        try {
            const response = await fetch(`{% url 'ventas:check_slot_availability' %}?servicio_id=${servicioId}&fecha=${fecha}&hora=${hora}`);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();

            if (data.available) {
                addToCartBtn.disabled = false;
            } else {
                addToCartBtn.disabled = true;
                const warningMsg = document.createElement('small');
                warningMsg.className = 'text-danger d-block mt-1';
                warningMsg.textContent = 'Hora no disponible.';
                horaSelect.parentNode.appendChild(warningMsg);
            }
        } catch (error) {
            console.error('Error checking slot availability:', error);
            const warningMsg = document.createElement('small');
            warningMsg.className = 'text-danger d-block mt-1';
            warningMsg.textContent = 'Error al verificar disponibilidad.';
            horaSelect.parentNode.appendChild(warningMsg);
            addToCartBtn.disabled = true;
        }
    }

    // Function to add to cart
    function addToCart() {
        const servicioId = document.getElementById('servicioId').value;
        const fecha = document.getElementById('fecha').value;
        const hora = document.getElementById('hora').value;
        const cantidadPersonas = document.getElementById('cantidadPersonas').value;

        if (!fecha || !hora) {
            alert('Por favor selecciona una fecha y hora');
            return;
        }

        const formData = new FormData();
        formData.append('servicio_id', servicioId);
        formData.append('fecha', fecha);
        formData.append('hora', hora);
        formData.append('cantidad_personas', cantidadPersonas);

        fetch('{% url "ventas:add_to_cart" %}', {
            method: 'POST',
            body: formData,
            headers: { 'X-CSRFToken': getCookie('csrftoken') }
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => { throw new Error(`Server responded with ${response.status}: ${text || 'No error info'}`); });
            }
            if (response.redirected) {
                window.location.href = response.url;
            } else {
                window.location.href = "{% url 'ventas:checkout' %}";
            }
        })
        .catch(error => {
            console.error('Error adding to cart:', error);
            alert(`Error al agregar al carrito: ${error.message}.`);
        });
    }

    // Initialize listeners
    document.addEventListener('DOMContentLoaded', function() {
        // Listener for booking modal buttons
        document.querySelectorAll('.js-open-booking-modal').forEach(button => {
            button.addEventListener('click', function() {
                currentServicioId = this.dataset.servicioId;
                currentServicioNombre = this.dataset.servicioNombre;
                currentServicioPrecio = parseFloat(this.dataset.servicioPrecio);
                currentServicioTipo = this.dataset.servicioTipo || 'otro';

                document.getElementById('servicioId').value = currentServicioId;
                document.getElementById('servicioNombre').value = currentServicioNombre;
                document.getElementById('fecha').value = '';
                document.getElementById('hora').innerHTML = '<option value="">Selecciona una hora</option>';
                document.getElementById('hora').disabled = true;

                const cantidadPersonasSelect = document.getElementById('cantidadPersonas');
                const cantidadPersonasLabel = document.querySelector('label[for="cantidadPersonas"]');
                if (currentServicioTipo === 'cabana') {
                    cantidadPersonasSelect.value = '2';
                    cantidadPersonasSelect.disabled = true;
                    if (cantidadPersonasLabel) cantidadPersonasLabel.style.display = 'none';
                    cantidadPersonasSelect.style.display = 'none';
                    document.getElementById('precioTotal').value = formatCLP(currentServicioPrecio);
                } else {
                    cantidadPersonasSelect.value = '1';
                    cantidadPersonasSelect.disabled = false;
                    if (cantidadPersonasLabel) cantidadPersonasLabel.style.display = 'block';
                    cantidadPersonasSelect.style.display = 'block';
                    document.getElementById('precioTotal').value = formatCLP(currentServicioPrecio);
                }

                const bookingModalEl = document.getElementById('bookingModal');
                if (bookingModalEl) {
                    const bookingModal = new bootstrap.Modal(bookingModalEl);
                    bookingModal.show();
                }
            });
        });

        // Flatpickr for date picker
        const fechaInput = document.getElementById('fecha');
        if (fechaInput) {
            flatpickr(fechaInput, {
                minDate: "today",
                dateFormat: "Y-m-d",
                locale: "es",
                onChange: function(selectedDates, dateStr) {
                    if (currentServicioId) {
                        loadAvailableHours(currentServicioId, dateStr);
                    }
                }
            });
        }

        // Listener for quantity change
        const cantidadPersonasSelect = document.getElementById('cantidadPersonas');
        if (cantidadPersonasSelect) {
            cantidadPersonasSelect.addEventListener('change', updatePrecioTotal);
        }

        // Listener for time selection change
        const horaSelect = document.getElementById('hora');
        if (horaSelect) {
            horaSelect.addEventListener('change', validateSelectedSlot);
        }

        // Listener for "Add to Cart" button in modal
        const addToCartBtn = document.getElementById('addToCartBtn');
        if (addToCartBtn) {
            addToCartBtn.addEventListener('click', addToCart);
        }
    });
</script>
{% endblock %}