{% extends "ventas/base_public.html" %}
{% load static %}
{% load humanize %}
{% load ventas_extras %}

{% block title %}{{ categoria_actual.nombre }} - Servicios | Aremko Spa Puerto Varas{% endblock %}

{% block meta_description %}
<meta name="description" content="Explora nuestros servicios de {{ categoria_actual.nombre }} en Aremko Spa Puerto Varas. Reserva tu experiencia de relajación hoy.">
<meta name="robots" content="index,follow,max-snippet:-1,max-image-preview:large,max-video-preview:-1">
<meta name="keywords" content="{{ categoria_actual.nombre }} Puerto Varas, {{ categoria_actual.nombre }} spa Puerto Varas, masajes Puerto Varas, tinajas Puerto Varas, reservar {{ categoria_actual.nombre }} Puerto Varas">
{% endblock %}

{% block meta_og %}
<meta property="og:title" content="{{ categoria_actual.nombre }} - Aremko Spa">
<meta property="og:description" content="Servicios de {{ categoria_actual.nombre }} en Puerto Varas. Reserva online.">
<meta property="og:type" content="website">
<meta property="og:url" content="{{ canonical_url }}">
{% if category_hero_image %}<meta property="og:image" content="{{ category_hero_image }}">{% endif %}
{% if category_hero_image %}<meta property="og:image:alt" content="{{ categoria_actual.nombre }} - Aremko Spa">{% endif %}
<link rel="alternate" hreflang="es-cl" href="{{ canonical_url }}">
<link rel="alternate" hreflang="x-default" href="{{ canonical_url }}">
{% endblock %}

{% block meta_twitter %}
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="{{ categoria_actual.nombre }} - Aremko Spa Puerto Varas">
<meta name="twitter:description" content="Reserva servicios de {{ categoria_actual.nombre }} en Puerto Varas: masajes, tinajas y más.">
{% if category_hero_image %}<meta name="twitter:image" content="{{ category_hero_image }}">{% endif %}
{% endblock %}

{% block structured_data %}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  "name": "{{ categoria_actual.nombre }} - Aremko Spa",
  "url": "{{ canonical_url }}",
  "breadcrumb": {
    "@type": "BreadcrumbList",
    "itemListElement": [
      {"@type": "ListItem", "position": 1, "name": "Inicio", "item": "{% url 'homepage' %}"},
      {"@type": "ListItem", "position": 2, "name": "{{ categoria_actual.nombre }}", "item": "{{ canonical_url }}"}
    ]
  },
  "mainEntity": {
    "@type": "ItemList",
    "itemListElement": [
      {% for servicio in servicios %}
      {"@type": "ListItem", "position": {{ forloop.counter }}, "url": "{{ canonical_url }}#servicio-{{ servicio.id }}", "name": "{{ servicio.nombre }}"}{% if not forloop.last %},{% endif %}
      {% endfor %}
    ]
  }
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@graph": [
    {% for servicio in servicios|slice:":10" %}
    {
      "@type": "Service",
      "name": "{{ servicio.nombre }}",
      "areaServed": "Puerto Varas, Chile",
      "provider": {"@type": "LocalBusiness", "name": "Aremko Spa"},
      {% if servicio.imagen %}"image": "{{ servicio.imagen.url }}",{% endif %}
      {% if servicio.descripcion_web %}"description": "{{ servicio.descripcion_web|striptags|truncatechars:160 }}",{% endif %}
      "offers": {
        "@type": "Offer",
        "price": "{{ servicio.precio_base }}",
        "priceCurrency": "CLP",
        "availability": "https://schema.org/InStock"
      }
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
  ]
}
</script>
{% endblock %}

{% block extra_style %}
<style>
/* Styles specific to category detail page */
.category-hero {
    background-size: cover;
    background-position: center;
    color: white;
    text-align: center;
    padding: 80px 20px;
    margin-bottom: 40px;
}
.category-hero h1 { font-weight: 800; }
.category-hero p { max-width: 700px; margin: 10px auto 0; }

.section-title {
    text-align: center;
    font-weight: 700;
    color: var(--dark-gray);
    position: relative;
    padding-bottom: 15px;
    margin-bottom: 30px;
}
.section-title::after {
    content: '';
    position: absolute;
    display: block;
    width: 60px;
    height: 3px;
    background: var(--primary-color);
    bottom: 0;
    left: calc(50% - 30px);
}
</style>
{% endblock %}

{% block content %}

<!-- Category Hero -->
<section class="category-hero" style="background-image: linear-gradient(rgba(0,0,0,.45), rgba(0,0,0,.45)), {% if category_hero_image %}url('{{ category_hero_image }}'){% else %}url('https://images.unsplash.com/photo-1501785888041-af3ef285b470?auto=format&fit=crop&w=1740&q=80'){% endif %};">
    <div class="container">
        <h1>{{ categoria_actual.nombre }}</h1>
        <p>Descubre nuestras opciones de {{ categoria_actual.nombre|lower }} y arma tu momento perfecto.</p>
        <a href="{% url 'homepage' %}#servicios" class="btn btn-light mt-3">Ver todas las experiencias</a>
    </div>
</section>

<!-- Services in Category -->
<section class="container mb-5" id="servicios-categoria">
    <h2 class="section-title">Servicios Disponibles</h2>
    <div class="row">
        {% for servicio in servicios %}
            <div id="servicio-{{ servicio.id }}" class="col-12 col-md-12"></div>
            {% include "ventas/components/service_card.html" with servicio=servicio %}
        {% empty %}
        <div class="col-12"><p class="text-center">No hay servicios disponibles en esta categoría en este momento.</p></div>
        {% endfor %}
    </div>
</section>

<!-- Simple Gallery from service images -->
<section class="container mb-5">
    <h2 class="section-title">Galería</h2>
    <div class="row">
        {% for servicio in servicios|slice:":6" %}
        {% if servicio.imagen %}
        <div class="col-6 col-md-4 mb-3">
            <img src="{{ servicio.imagen.url }}" alt="{{ servicio.nombre }}" class="img-fluid rounded" loading="lazy">
        </div>
        {% endif %}
        {% endfor %}
    </div>
</section>

{% endblock %}

{% block modals %}
<!-- Booking Modal (Copied from homepage for consistency) -->
<div class="modal fade" id="bookingModal" tabindex="-1" aria-labelledby="bookingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bookingModalLabel">Reservar Servicio</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="bookingForm" class="booking-form">
                    <input type="hidden" id="servicioId" name="servicio_id">
                    <div class="mb-3">
                        <label for="servicioNombre" class="form-label">Servicio</label>
                        <input type="text" class="form-control" id="servicioNombre" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="fecha" class="form-label">Fecha</label>
                        <input type="text" class="form-control" id="fecha" name="fecha" placeholder="Selecciona una fecha" required>
                    </div>
                    <div class="mb-3">
                        <label for="hora" class="form-label">Hora</label>
                        <select class="form-select" id="hora" name="hora" required>
                            <option value="">Selecciona una hora</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="cantidadPersonas" class="form-label">Cantidad de Personas</label>
                        <select class="form-select" id="cantidadPersonas" name="cantidad_personas"></select>
                    </div>
                    <div class="mb-3">
                        <label for="precioTotal" class="form-label">Precio Total</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="text" class="form-control" id="precioTotal" readonly>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="addToCartBtn">Agregar al Carrito</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_script %}
<script>
    function formatCLP(value) {
      const numberValue = Number(value);
      if (isNaN(numberValue)) { return '0'; }
      return new Intl.NumberFormat('es-CL', { minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(numberValue);
    }

    let currentServicioId = null;
    let currentServicioNombre = null;
    let currentServicioPrecio = 0;
    let currentServicioTipo = 'otro';
    let currentServicioMin = 1;
    let currentServicioMax = 1;

    function loadAvailableHours(servicioId, fecha) {
        const horaSelect = document.getElementById('hora');
        if (!horaSelect) return;
        horaSelect.innerHTML = '<option value="">Cargando horas...</option>';
        horaSelect.disabled = true;
        fetch(`{% url 'ventas:get_available_hours' %}?servicio_id=${servicioId}&fecha=${fecha}`)
            .then(response => response.ok ? response.json() : Promise.reject(response.status))
            .then(data => {
                horaSelect.innerHTML = '<option value="">Selecciona una hora</option>';
                if (data.success && data.horas_disponibles.length > 0) {
                    data.horas_disponibles.forEach(hora => { const option = document.createElement('option'); option.value = hora; option.textContent = hora; horaSelect.appendChild(option); });
                    horaSelect.disabled = false;
                } else {
                    horaSelect.innerHTML = '<option value="">No hay horas disponibles</option>';
                }
            })
            .catch(() => { horaSelect.innerHTML = '<option value="">Error al cargar horas</option>'; });
    }

    function isCantidadValid() {
        const s = document.getElementById('cantidadPersonas');
        if (!s || s.disabled) return true;
        const v = parseInt(s.value);
        return v >= currentServicioMin && v <= currentServicioMax;
    }

    function validateCantidadPersonas() {
        const s = document.getElementById('cantidadPersonas');
        const btn = document.getElementById('addToCartBtn');
        const parentDiv = s.parentNode; let errorMsg = parentDiv.querySelector('.cantidad-error-msg');
        if (!isCantidadValid()) {
            if (!errorMsg) { errorMsg = document.createElement('small'); errorMsg.className = 'text-danger d-block mt-1 cantidad-error-msg'; parentDiv.appendChild(errorMsg); }
            errorMsg.textContent = currentServicioMin === currentServicioMax ? `Cantidad debe ser ${currentServicioMin}.` : `Cantidad debe estar entre ${currentServicioMin} y ${currentServicioMax}.`;
            errorMsg.style.display = 'block'; btn.disabled = true;
        } else {
            if (errorMsg) errorMsg.style.display = 'none';
            const horaSelect = document.getElementById('hora');
            if (!horaSelect || !horaSelect.value) { btn.disabled = true; } else { validateSelectedSlot(); }
        }
    }

    async function validateSelectedSlot() {
        const servicioId = document.getElementById('servicioId').value;
        const fecha = document.getElementById('fecha').value;
        const hora = document.getElementById('hora').value;
        const btn = document.getElementById('addToCartBtn');
        const horaSelect = document.getElementById('hora');
        const existingWarning = horaSelect.parentNode.querySelector('.text-danger'); if (existingWarning) existingWarning.remove();
        if (!isCantidadValid()) { btn.disabled = true; return; }
        if (!servicioId || !fecha || !hora) { btn.disabled = true; return; }
        btn.disabled = true;
        try {
            const response = await fetch(`{% url 'ventas:check_slot_availability' %}?servicio_id=${servicioId}&fecha=${fecha}&hora=${hora}`);
            if (!response.ok) throw new Error(response.status);
            const data = await response.json();
            if (data.available && isCantidadValid()) { btn.disabled = false; }
            else { btn.disabled = true; const warningMsg = document.createElement('small'); warningMsg.className = 'text-danger d-block mt-1'; warningMsg.textContent = 'Hora no disponible.'; horaSelect.parentNode.appendChild(warningMsg); }
        } catch (e) {
            const warningMsg = document.createElement('small'); warningMsg.className = 'text-danger d-block mt-1'; warningMsg.textContent = 'Error al verificar disponibilidad.'; horaSelect.parentNode.appendChild(warningMsg); btn.disabled = true;
        }
    }

    function updatePrecioTotal() {
        const s = document.getElementById('cantidadPersonas');
        const precioTotalInput = document.getElementById('precioTotal');
        if (s && precioTotalInput) {
            const n = parseInt(s.value); let total = 0;
            total = currentServicioTipo === 'cabana' ? currentServicioPrecio : currentServicioPrecio * n;
            precioTotalInput.value = formatCLP(total);
        }
        validateCantidadPersonas();
        const horaSelect = document.getElementById('hora');
        if (horaSelect && horaSelect.value) validateSelectedSlot(); else { const btn = document.getElementById('addToCartBtn'); if (!isCantidadValid()) btn.disabled = true; }
    }

    function addToCart() {
        const servicioId = document.getElementById('servicioId').value;
        const fecha = document.getElementById('fecha').value;
        const hora = document.getElementById('hora').value;
        const cantidadPersonas = document.getElementById('cantidadPersonas').value;
        if (!fecha) { alert('Por favor selecciona una fecha'); return; }
        if (!hora) { alert('Por favor selecciona una hora'); return; }
        const formData = new FormData();
        formData.append('servicio_id', servicioId);
        formData.append('fecha', fecha);
        formData.append('hora', hora);
        formData.append('cantidad_personas', cantidadPersonas);
        fetch('{% url "ventas:add_to_cart" %}', { method: 'POST', body: formData, headers: { 'X-CSRFToken': getCookie('csrftoken') } })
        .then(response => { if (!response.ok) return response.text().then(text => { throw new Error(`Server responded with ${response.status}: ${text || 'No info'}`); }); if (response.redirected) { window.location.href = response.url; } else { window.location.href = "{% url 'ventas:checkout' %}"; } })
        .catch(error => { alert(`Error al agregar al carrito: ${error.message}. Por favor intenta de nuevo.`); });
    }

    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.js-open-booking-modal').forEach(button => {
            button.addEventListener('click', function() {
                const servicioId = this.dataset.servicioId;
                const servicioNombre = this.dataset.servicioNombre;
                const servicioPrecio = parseFloat(this.dataset.servicioPrecio);
                const servicioTipo = this.dataset.servicioTipo || 'otro';
                const servicioMin = parseInt(this.dataset.servicioMin) || 1;
                const servicioMax = parseInt(this.dataset.servicioMax) || 1;
                currentServicioId = servicioId; currentServicioNombre = servicioNombre; currentServicioPrecio = servicioPrecio; currentServicioTipo = servicioTipo; currentServicioMin = servicioMin; currentServicioMax = servicioMax;
                document.getElementById('servicioId').value = servicioId;
                document.getElementById('servicioNombre').value = servicioNombre;
                document.getElementById('fecha').value = '';
                document.getElementById('hora').innerHTML = '<option value="">Selecciona una hora</option>';
                document.getElementById('hora').disabled = true;
                document.getElementById('addToCartBtn').disabled = true;
                const cantidadPersonasSelect = document.getElementById('cantidadPersonas');
                const cantidadPersonasLabel = document.querySelector('label[for="cantidadPersonas"]');
                const cantidadErrorMsg = cantidadPersonasSelect.parentNode.querySelector('.cantidad-error-msg');
                if (cantidadErrorMsg) cantidadErrorMsg.style.display = 'none';
                cantidadPersonasSelect.innerHTML = '';
                if (servicioTipo !== 'cabana') {
                    for (let i = 1; i <= currentServicioMax; i++) {
                        if (i >= currentServicioMin && i <= currentServicioMax) {
                            const option = document.createElement('option'); option.value = i; option.textContent = `${i} persona${i > 1 ? 's' : ''}`; cantidadPersonasSelect.appendChild(option);
                        }
                    }
                    cantidadPersonasSelect.value = currentServicioMin <= currentServicioMax ? currentServicioMin : (cantidadPersonasSelect.options.length > 0 ? cantidadPersonasSelect.options[0].value : '1');
                    cantidadPersonasSelect.disabled = false;
                    if (cantidadPersonasLabel) cantidadPersonasLabel.style.display = 'block';
                    cantidadPersonasSelect.style.display = 'block';
                } else {
                    const option = document.createElement('option'); option.value = currentServicioMax; option.textContent = `${currentServicioMax} persona${currentServicioMax > 1 ? 's' : ''}`; cantidadPersonasSelect.appendChild(option);
                    cantidadPersonasSelect.value = currentServicioMax; cantidadPersonasSelect.disabled = true; if (cantidadPersonasLabel) cantidadPersonasLabel.style.display = 'none'; cantidadPersonasSelect.style.display = 'none';
                }
                updatePrecioTotal();
                const bookingModalEl = document.getElementById('bookingModal'); if (bookingModalEl) { const bookingModal = new bootstrap.Modal(bookingModalEl); bookingModal.show(); }
            });
        });

        const fechaInput = document.getElementById('fecha');
        if (fechaInput) { flatpickr(fechaInput, { minDate: "today", dateFormat: "Y-m-d", locale: "es", onChange: function(selectedDates, dateStr) { if (currentServicioId) { loadAvailableHours(currentServicioId, dateStr); } } }); }

        const cantidadPersonasSelect = document.getElementById('cantidadPersonas'); if (cantidadPersonasSelect) { cantidadPersonasSelect.addEventListener('change', updatePrecioTotal); }
        const horaSelect = document.getElementById('hora'); if (horaSelect) { horaSelect.addEventListener('change', validateSelectedSlot); }
        const addToCartBtn = document.getElementById('addToCartBtn'); if (addToCartBtn) { addToCartBtn.addEventListener('click', addToCart); }
    });
</script>
{% endblock %}
