{% load humanize %}
{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Operativo - Aremko</title>

<style>
    .stats-container {
        padding: 20px;
        background: #f5f5f5;
    }

    .stats-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 10px;
        margin-bottom: 30px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .stats-header h1 {
        margin: 0 0 10px 0;
        font-size: 2.5rem;
        font-weight: 700;
    }

    .stats-header p {
        margin: 0;
        font-size: 1.1rem;
        opacity: 0.9;
    }

    /* Filtros */
    .filter-card {
        background: white;
        padding: 25px;
        border-radius: 10px;
        margin-bottom: 30px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .filter-card h3 {
        margin-top: 0;
        color: #333;
        font-size: 1.3rem;
        margin-bottom: 20px;
    }

    .filter-row {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        align-items: end;
    }

    .filter-group {
        flex: 1;
        min-width: 150px;
    }

    .filter-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #555;
        font-size: 0.9rem;
    }

    .filter-group select,
    .filter-group input {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 1rem;
    }

    .btn-filter {
        padding: 10px 25px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
    }

    .btn-filter:hover {
        background: #5568d3;
        transform: translateY(-2px);
    }

    .btn-export {
        padding: 10px 25px;
        background: #10b981;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
        text-decoration: none;
        display: inline-block;
    }

    .btn-export:hover {
        background: #059669;
    }

    /* Resumen Cards */
    .summary-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .summary-card {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        border-left: 4px solid #667eea;
    }

    .summary-card h4 {
        margin: 0 0 10px 0;
        color: #666;
        font-size: 0.9rem;
        text-transform: uppercase;
        font-weight: 600;
    }

    .summary-card .value {
        font-size: 2rem;
        font-weight: 700;
        color: #333;
    }

    .summary-card .subtitle {
        font-size: 0.85rem;
        color: #999;
        margin-top: 5px;
    }

    /* Chart Cards */
    .chart-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
        gap: 25px;
        margin-bottom: 30px;
    }

    .chart-card {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .chart-card.full-width {
        grid-column: 1 / -1;
    }

    .chart-card h3 {
        margin: 0 0 20px 0;
        color: #333;
        font-size: 1.2rem;
        padding-bottom: 15px;
        border-bottom: 2px solid #f0f0f0;
    }

    .chart-container {
        position: relative;
        height: 400px;
    }

    .chart-container.small {
        height: 300px;
    }

    /* Tables */
    .data-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
    }

    .data-table th {
        background: #f8f9fa;
        padding: 12px;
        text-align: left;
        font-weight: 600;
        color: #555;
        border-bottom: 2px solid #e9ecef;
    }

    .data-table td {
        padding: 12px;
        border-bottom: 1px solid #f0f0f0;
    }

    .data-table tr:hover {
        background: #f8f9fa;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .chart-grid {
            grid-template-columns: 1fr;
        }

        .filter-row {
            flex-direction: column;
        }

        .filter-group {
            width: 100%;
        }
    }
</style>
</head>
<body>

<!-- CONTENT -->
<div class="stats-container">
    <!-- Header -->
    <div class="stats-header">
        <h1>‚öôÔ∏è Dashboard Operativo</h1>
        <p>{{ periodo_texto }} ‚Ä¢ An√°lisis de servicios por fecha de prestaci√≥n</p>
    </div>

    <!-- Navegador de Dashboards -->
    <div class="filter-card" style="margin-bottom: 20px;">
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <a href="{% url 'ventas:analytics_dashboard_ventas' %}?year={{ year }}{% if month %}&month={{ month }}{% endif %}"
               class="btn-filter" style="text-decoration: none; background: #6b7280;">
                üí∞ Dashboard de Ventas
            </a>
            <a href="#"
               class="btn-filter" style="text-decoration: none; background: #667eea; cursor: default;">
                ‚öôÔ∏è Dashboard Operativo (Actual)
            </a>
        </div>
        <p style="margin-top: 10px; color: #666; font-size: 0.9rem;">
            <strong>Nota:</strong> Este dashboard muestra TODOS los servicios agendados seg√∫n su <strong>fecha de agendamiento</strong> (cuando se prestan),
            independientemente del estado de pago. Incluye reservas confirmadas, pendientes, en check-in y check-out.
            Los productos no se incluyen porque no tienen fecha de consumo.
        </p>
    </div>

    <!-- Filtros -->
    <div class="filter-card">
        <h3>üîç Filtros</h3>
        <form method="GET" action="{% url 'ventas:analytics_dashboard_operativo' %}">
            <div class="filter-row">
                <div class="filter-group">
                    <label for="year">A√±o</label>
                    <select name="year" id="year">
                        {% for y in years_disponibles %}
                        <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="filter-group">
                    <label for="month">Mes (opcional)</label>
                    <select name="month" id="month">
                        <option value="">Todos los meses</option>
                        {% for mes in meses %}
                        <option value="{{ mes.numero }}" {% if mes.numero == month %}selected{% endif %}>
                            {{ mes.nombre }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="filter-group">
                    <label for="start_date">Fecha inicio (opcional)</label>
                    <input type="date" name="start_date" id="start_date" value="{{ start_date|default:'' }}">
                </div>

                <div class="filter-group">
                    <label for="end_date">Fecha fin (opcional)</label>
                    <input type="date" name="end_date" id="end_date" value="{{ end_date|default:'' }}">
                </div>

                <div class="filter-group">
                    <button type="submit" class="btn-filter">Aplicar Filtros</button>
                </div>

                <div class="filter-group">
                    <a href="{% url 'ventas:analytics_export_csv' %}?year={{ year }}{% if month %}&month={{ month }}{% endif %}"
                       class="btn-export">
                        üì• Exportar CSV
                    </a>
                </div>
            </div>
        </form>
    </div>

    <!-- Resumen General -->
    <div class="summary-cards">
        <div class="summary-card">
            <h4>üí∞ Ingresos Totales</h4>
            <div class="value">${{ resumen.total_ingresos|floatformat:0|intcomma }}</div>
            <div class="subtitle">{{ periodo_texto }}</div>
        </div>

        <div class="summary-card">
            <h4>üìã Total Reservas</h4>
            <div class="value">{{ resumen.total_reservas|intcomma }}</div>
            <div class="subtitle">Reservas pagadas</div>
        </div>

        <div class="summary-card">
            <h4>üéØ Ticket Promedio</h4>
            <div class="value">${{ resumen.ticket_promedio|floatformat:0|intcomma }}</div>
            <div class="subtitle">Promedio por reserva</div>
        </div>
    </div>

    <!-- Gr√°ficos -->
    <div class="chart-grid">
        <!-- Ventas por Familia -->
        <div class="chart-card">
            <h3>üè∑Ô∏è Ventas por Familia de Servicios</h3>
            <div class="chart-container small">
                <canvas id="chartFamilia"></canvas>
            </div>
        </div>

        <!-- Ventas por Forma de Pago -->
        <div class="chart-card">
            <h3>üí≥ Ventas por Forma de Pago</h3>
            <div class="chart-container small">
                <canvas id="chartFormaPago"></canvas>
            </div>
        </div>

        <!-- Ventas por D√≠a de Semana -->
        <div class="chart-card full-width">
            <h3>üìÖ Ventas por D√≠a de la Semana</h3>
            <div class="chart-container small">
                <canvas id="chartDiaSemana"></canvas>
            </div>
        </div>

        {% if ventas_por_mes %}
        <!-- Ventas por Mes (solo si se ve el a√±o completo) -->
        <div class="chart-card full-width">
            <h3>üìà Evoluci√≥n Mensual {{ year }}</h3>
            <div class="chart-container">
                <canvas id="chartMensual"></canvas>
            </div>
        </div>
        {% endif %}

        <!-- Top Servicios -->
        <div class="chart-card full-width">
            <h3>üîù Top 15 Servicios</h3>
            <div class="chart-container">
                <canvas id="chartServicios"></canvas>
            </div>
        </div>

        {% if ventas_por_producto %}
        <!-- Top Productos -->
        <div class="chart-card full-width">
            <h3>üõí Top 15 Productos</h3>
            <div class="chart-container">
                <canvas id="chartProductos"></canvas>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Tablas Detalladas -->
    <div class="chart-card">
        <h3>üìä Detalle de Servicios</h3>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Servicio</th>
                    <th>Categor√≠a</th>
                    <th>Cantidad</th>
                    <th>Total Ventas</th>
                </tr>
            </thead>
            <tbody>
                {% for item in ventas_por_servicio %}
                <tr>
                    <td>{{ item.servicio__nombre }}</td>
                    <td>{{ item.servicio__categoria__nombre|default:"Sin categor√≠a" }}</td>
                    <td>{{ item.cantidad }}</td>
                    <td>${{ item.total_ventas|floatformat:0|intcomma }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    // Datos desde Django
    const chartData = {{ chart_data_json|safe }};

    // Configuraci√≥n com√∫n de colores
    const colors = {
        primary: ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe'],
        gradient: ['#667eea', '#764ba2', '#f5576c', '#fa709a', '#fee140'],
        success: '#10b981',
        info: '#3b82f6',
        warning: '#f59e0b',
        danger: '#ef4444'
    };

    // Chart 1: Ventas por Familia
    if (chartData.ventas_familia.length > 0) {
        new Chart(document.getElementById('chartFamilia'), {
            type: 'doughnut',
            data: {
                labels: chartData.ventas_familia.map(item => item.familia || 'Sin categor√≠a'),
                datasets: [{
                    data: chartData.ventas_familia.map(item => item.total),
                    backgroundColor: colors.gradient,
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = new Intl.NumberFormat('es-CL', {
                                    style: 'currency',
                                    currency: 'CLP',
                                    minimumFractionDigits: 0
                                }).format(context.parsed);
                                return `${label}: ${value}`;
                            }
                        }
                    }
                }
            }
        });
    }

    // Chart 2: Forma de Pago
    if (chartData.ventas_forma_pago.length > 0) {
        new Chart(document.getElementById('chartFormaPago'), {
            type: 'pie',
            data: {
                labels: chartData.ventas_forma_pago.map(item => item.metodo),
                datasets: [{
                    data: chartData.ventas_forma_pago.map(item => item.total_pagos),
                    backgroundColor: colors.primary,
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = new Intl.NumberFormat('es-CL', {
                                    style: 'currency',
                                    currency: 'CLP',
                                    minimumFractionDigits: 0
                                }).format(context.parsed);
                                return `${label}: ${value}`;
                            }
                        }
                    }
                }
            }
        });
    }

    // Chart 3: D√≠a de Semana
    if (chartData.ventas_dia_semana.length > 0) {
        new Chart(document.getElementById('chartDiaSemana'), {
            type: 'bar',
            data: {
                labels: chartData.ventas_dia_semana.map(item => item.dia),
                datasets: [{
                    label: 'Ventas Totales',
                    data: chartData.ventas_dia_semana.map(item => item.total_ventas),
                    backgroundColor: '#667eea',
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return new Intl.NumberFormat('es-CL', {
                                    style: 'currency',
                                    currency: 'CLP',
                                    minimumFractionDigits: 0
                                }).format(context.parsed.y);
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '$' + (value / 1000).toFixed(0) + 'K';
                            }
                        }
                    }
                }
            }
        });
    }

    // Chart 4: Mensual (solo si hay datos)
    if (chartData.ventas_mes && chartData.ventas_mes.length > 0) {
        new Chart(document.getElementById('chartMensual'), {
            type: 'line',
            data: {
                labels: chartData.ventas_mes.map(item => item.mes),
                datasets: [{
                    label: 'Ventas Mensuales',
                    data: chartData.ventas_mes.map(item => item.total_ventas),
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    fill: true,
                    tension: 0.4,
                    borderWidth: 3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return new Intl.NumberFormat('es-CL', {
                                    style: 'currency',
                                    currency: 'CLP',
                                    minimumFractionDigits: 0
                                }).format(context.parsed.y);
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '$' + (value / 1000000).toFixed(1) + 'M';
                            }
                        }
                    }
                }
            }
        });
    }

    // Chart 5: Top Servicios
    if (chartData.ventas_servicio.length > 0) {
        new Chart(document.getElementById('chartServicios'), {
            type: 'bar',
            data: {
                labels: chartData.ventas_servicio.map(item => item.servicio),
                datasets: [{
                    label: 'Ventas Totales',
                    data: chartData.ventas_servicio.map(item => item.total),
                    backgroundColor: '#764ba2',
                    borderRadius: 6
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return new Intl.NumberFormat('es-CL', {
                                    style: 'currency',
                                    currency: 'CLP',
                                    minimumFractionDigits: 0
                                }).format(context.parsed.x);
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '$' + (value / 1000).toFixed(0) + 'K';
                            }
                        }
                    }
                }
            }
        });
    }

    // Chart 6: Top Productos
    if (chartData.ventas_producto.length > 0) {
        new Chart(document.getElementById('chartProductos'), {
            type: 'bar',
            data: {
                labels: chartData.ventas_producto.map(item => item.producto),
                datasets: [{
                    label: 'Ventas Totales',
                    data: chartData.ventas_producto.map(item => item.total),
                    backgroundColor: '#f5576c',
                    borderRadius: 6
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return new Intl.NumberFormat('es-CL', {
                                    style: 'currency',
                                    currency: 'CLP',
                                    minimumFractionDigits: 0
                                }).format(context.parsed.x);
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '$' + (value / 1000).toFixed(0) + 'K';
                            }
                        }
                    }
                }
            }
        });
    }
</script>

</body>
</html>
