{% extends "ventas/base_public.html" %}
{% load static %}

{% block title %}Aremko - Reserva de Servicios{% endblock %}

{% block extra_style %}
<style>
/* Homepage specific styles */
.hero-section {
    background-image: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url('https://images.unsplash.com/photo-1540555700478-4be289fbecef?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1740&q=80');
    background-size: cover;
    background-position: center;
    color: white;
    padding: 100px 0;
    margin-bottom: 50px;
}

.hero-content {
    max-width: 600px;
    margin: 0 auto;
    text-align: center;
}

.hero-content h1 {
    font-size: 3rem;
    font-weight: 700;
    margin-bottom: 20px;
}

.hero-content p {
    font-size: 1.2rem;
    margin-bottom: 30px;
}

.features-section {
    padding: 80px 0;
    background-color: white;
}

.feature-box {
    text-align: center;
    padding: 30px 20px;
}

.feature-icon {
    font-size: 3rem;
    color: var(--primary-color);
    margin-bottom: 20px;
}

.feature-title {
    font-weight: 700;
    margin-bottom: 15px;
}

.testimonials-section {
    padding: 80px 0;
    background-color: #f8f9fa;
}

.testimonial-card {
    padding: 30px;
    border-radius: 12px;
    background-color: white;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    margin-bottom: 30px;
}

.testimonial-text {
    font-style: italic;
    margin-bottom: 20px;
}

.testimonial-author {
    font-weight: 700;
}

/* Responsive adjustments for hero */
@media (max-width: 768px) {
    .hero-content h1 {
        font-size: 2.5rem;
    }
}
</style>
{% endblock %}

{% block content %}

<!-- Hero Section -->
<section class="hero-section">
    <div class="container">
            <div class="hero-content">
                <h1>Reserva tus servicios en Aremko</h1>
                <p>Descubre y reserva los mejores servicios para tu bienestar y comodidad.</p>
                <a href="#servicios" class="btn btn-primary btn-lg">
                    <i class="fas fa-calendar-check me-2"></i>Reservar Ahora
                </a>
            </div>
        </div>
    </section>

<!-- Services Section -->
<section class="container mb-5" id="servicios">
    <h2 class="section-title mb-4">Nuestros Servicios</h2>
    
        <!-- Category Filter -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-center flex-wrap">
                    <button class="btn btn-outline-secondary m-1 category-filter active" data-category="all">
                        Todos
                    </button>
                    {% for categoria in categorias %}
                        <button class="btn btn-outline-secondary m-1 category-filter" data-category="{{ categoria.id }}">
                            {{ categoria.nombre }}
                        </button>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <div class="row">
            {% for servicio in servicios %}
                <div class="col-lg-4 col-md-6 service-card" data-category="{{ servicio.categoria.id }}">
                    <div class="card h-100">
                        <img src="https://source.unsplash.com/random/300x200/?{{ servicio.nombre|urlencode }}" class="card-img-top" alt="{{ servicio.nombre }}">
                        <div class="card-body">
                            <h5 class="card-title">{{ servicio.nombre }}</h5>
                            <p class="card-text">{{ servicio.categoria.nombre }}</p>
                            <p class="price">${{ servicio.precio_base }} <small class="text-muted">por persona</small></p>
                            <p class="card-text"><small class="text-muted">Duración: {{ servicio.duracion }} minutos</small></p>
                            <button class="btn btn-primary w-100" onclick="openBookingModal({{ servicio.id }}, '{{ servicio.nombre }}', {{ servicio.precio_base }})">
                                <i class="fas fa-calendar-plus me-2"></i>Reservar
                            </button>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    </section>

<!-- Features Section -->
<section class="features-section" id="caracteristicas">
    <div class="container">
        <h2 class="section-title mb-5">¿Por qué elegirnos?</h2>
        <div class="row">
                <div class="col-lg-3 col-md-6">
                    <div class="feature-box">
                        <div class="feature-icon">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                        <h4 class="feature-title">Reserva Fácil</h4>
                        <p>Reserva tus servicios en minutos con nuestro sistema intuitivo.</p>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="feature-box">
                        <div class="feature-icon">
                            <i class="fas fa-star"></i>
                        </div>
                        <h4 class="feature-title">Calidad Garantizada</h4>
                        <p>Todos nuestros servicios cumplen con los más altos estándares de calidad.</p>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="feature-box">
                        <div class="feature-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <h4 class="feature-title">Ahorra Tiempo</h4>
                        <p>Olvídate de las llamadas y las esperas. Reserva cuando quieras.</p>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="feature-box">
                        <div class="feature-icon">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <h4 class="feature-title">Seguridad</h4>
                        <p>Tu información personal está segura con nosotros.</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

<!-- Testimonials Section -->
<section class="testimonials-section" id="testimonios">
    <div class="container">
        <h2 class="section-title mb-5">Lo que dicen nuestros clientes</h2>
        <div class="row">
                <div class="col-lg-4 col-md-6">
                    <div class="testimonial-card">
                        <div class="testimonial-text">
                            "Excelente servicio. La reserva fue muy fácil y el servicio superó mis expectativas. Definitivamente volveré a reservar."
                        </div>
                        <div class="testimonial-author">- María González</div>
                    </div>
                </div>
                <div class="col-lg-4 col-md-6">
                    <div class="testimonial-card">
                        <div class="testimonial-text">
                            "Me encantó la facilidad para reservar. El personal fue muy amable y profesional. Recomiendo ampliamente sus servicios."
                        </div>
                        <div class="testimonial-author">- Juan Pérez</div>
                    </div>
                </div>
                <div class="col-lg-4 col-md-6">
                    <div class="testimonial-card">
                        <div class="testimonial-text">
                            "La mejor experiencia que he tenido. El sistema de reservas es muy intuitivo y el servicio fue de primera calidad."
                        </div>
                        <div class="testimonial-author">- Ana Rodríguez</div>
                    </div>
                </div>
            </div>
        </div>
    </section>

        </div>
    </section>
{% endblock %}

{% block modals %}
<!-- Booking Modal (Specific to homepage, keep it here) -->
    <div class="modal fade" id="bookingModal" tabindex="-1" aria-labelledby="bookingModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="bookingModalLabel">Reservar Servicio</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="bookingForm" class="booking-form">
                        <input type="hidden" id="servicioId" name="servicio_id">
                        
                        <div class="mb-3">
                            <label for="servicioNombre" class="form-label">Servicio</label>
                            <input type="text" class="form-control" id="servicioNombre" readonly>
                        </div>
                        
                        <div class="mb-3">
                            <label for="fecha" class="form-label">Fecha</label>
                            <input type="text" class="form-control" id="fecha" name="fecha" placeholder="Selecciona una fecha" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="hora" class="form-label">Hora</label>
                            <select class="form-select" id="hora" name="hora" required>
                                <option value="">Selecciona una hora</option>
                                <!-- Las horas disponibles se cargarán dinámicamente -->
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="cantidadPersonas" class="form-label">Cantidad de Personas</label>
                            <select class="form-select" id="cantidadPersonas" name="cantidad_personas">
                                <option value="1">1 persona</option>
                                <option value="2">2 personas</option>
                                <option value="3">3 personas</option>
                                <option value="4">4 personas</option>
                                <option value="5">5 personas</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="precioTotal" class="form-label">Precio Total</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="text" class="form-control" id="precioTotal" readonly>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="addToCartBtn">Agregar al Carrito</button>
                </div>
            </div>
        </div>
    </div>
{# Checkout and Success modals are now in base_public.html #}
{% endblock %}

{% block extra_script %}
<script>
    // Make openBookingModal globally accessible
    window.openBookingModal = function(servicioId, servicioNombre, servicioPrecio) {
        console.log("Opening booking modal for:", servicioId, servicioNombre, servicioPrecio);
        currentServicioId = servicioId;
        currentServicioNombre = servicioNombre;
        currentServicioPrecio = servicioPrecio;

        document.getElementById('servicioId').value = servicioId;
        document.getElementById('servicioNombre').value = servicioNombre;
        document.getElementById('fecha').value = '';
        document.getElementById('hora').innerHTML = '<option value="">Selecciona una hora</option>';
        document.getElementById('cantidadPersonas').value = '1';
        document.getElementById('precioTotal').value = servicioPrecio;

        const bookingModalEl = document.getElementById('bookingModal');
        if (bookingModalEl) {
            const bookingModal = new bootstrap.Modal(bookingModalEl);
            bookingModal.show();
        } else {
            console.error("Booking modal element not found");
        }
    }

    // Variables globales específicas de la homepage
    let currentServicioId = null;
    let currentServicioNombre = null;
    let currentServicioPrecio = 0;

    // Función para cargar horas disponibles (específica de homepage)
    function loadAvailableHours(servicioId, fecha) {
        console.log("Loading available hours for:", servicioId, fecha);
        const horaSelect = document.getElementById('hora');
        if (!horaSelect) {
            console.error("Hora select element not found");
            return;
        }
        horaSelect.innerHTML = '<option value="">Cargando horas disponibles...</option>';
        horaSelect.disabled = true; // Disable while loading

        fetch(`{% url 'get_available_hours' %}?servicio_id=${servicioId}&fecha=${fecha}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log("Available hours response:", data);
                horaSelect.innerHTML = '<option value="">Selecciona una hora</option>';
                if (data.success && data.horas_disponibles.length > 0) {
                    data.horas_disponibles.forEach(hora => {
                        const option = document.createElement('option');
                        option.value = hora;
                        option.textContent = hora;
                        horaSelect.appendChild(option);
                    });
                    horaSelect.disabled = false; // Enable after loading
                } else {
                    horaSelect.innerHTML = '<option value="">No hay horas disponibles</option>';
                    console.warn('No available hours found or error:', data.error);
                }
            })
            .catch(error => {
                console.error('Error fetching available hours:', error);
                horaSelect.innerHTML = '<option value="">Error al cargar horas</option>';
                // Keep disabled on error
            });
    }

    // Función para actualizar el precio total (específica de homepage)
    function updatePrecioTotal() {
        const cantidadPersonasSelect = document.getElementById('cantidadPersonas');
        const precioTotalInput = document.getElementById('precioTotal');
        if (cantidadPersonasSelect && precioTotalInput) {
            const cantidadPersonas = parseInt(cantidadPersonasSelect.value);
            const precioTotal = currentServicioPrecio * cantidadPersonas;
            precioTotalInput.value = precioTotal;
            console.log("Updated total price:", precioTotal);
        }
    }

    // Función para agregar al carrito (específica de homepage)
    function addToCart() {
        console.log("Attempting to add to cart...");
        const servicioId = document.getElementById('servicioId').value;
        const fecha = document.getElementById('fecha').value;
        const hora = document.getElementById('hora').value;
        const cantidadPersonas = document.getElementById('cantidadPersonas').value;

        if (!fecha) {
            alert('Por favor selecciona una fecha');
            return;
        }
        if (!hora) {
            alert('Por favor selecciona una hora');
            return;
        }

        const formData = new FormData();
        formData.append('servicio_id', servicioId);
        formData.append('fecha', fecha);
        formData.append('hora', hora);
        formData.append('cantidad_personas', cantidadPersonas);

        console.log("Adding to cart with data:", { servicioId, fecha, hora, cantidadPersonas });

        fetch('{% url "add_to_cart" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCookie('csrftoken') // Assumes getCookie is global (from base)
            }
        })
        .then(response => {
            console.log("Add to cart response status:", response.status);
            if (!response.ok) {
                 // If response is not ok, try to read error message if available
                 return response.text().then(text => {
                     throw new Error(`Server responded with ${response.status}: ${text || 'No additional error info'}`);
                 });
            }
             // Check if the response is a redirect (status 3xx) or success (status 2xx)
             // Django redirects often return 302, fetch might follow it automatically
             // If fetch followed redirect, response.url will be the new URL
            if (response.redirected) {
                 console.log("Redirected after add to cart, going to:", response.url);
                 window.location.href = response.url; // Go to the redirected page (likely checkout)
            } else {
                 // If not redirected, assume success and manually redirect (or update UI)
                 console.log("Add to cart successful, redirecting to checkout...");
                 window.location.href = "{% url 'checkout' %}";
            }
        })
        .catch(error => {
            console.error('Error adding to cart:', error);
            alert(`Error al agregar al carrito: ${error.message}. Por favor intenta de nuevo.`);
        });
    }

    // Inicializar listeners específicos de la homepage
    document.addEventListener('DOMContentLoaded', function() {
        console.log("Homepage DOMContentLoaded");

        // Flatpickr for date picker
        const fechaInput = document.getElementById('fecha');
        if (fechaInput) {
            flatpickr(fechaInput, {
                minDate: "today",
                dateFormat: "Y-m-d",
                locale: "es",
                onChange: function(selectedDates, dateStr) {
                    if (currentServicioId) {
                        loadAvailableHours(currentServicioId, dateStr);
                    }
                }
            });
            console.log("Flatpickr initialized for #fecha");
        } else {
            console.error("Fecha input element not found");
        }

        // Listener for quantity change
        const cantidadPersonasSelect = document.getElementById('cantidadPersonas');
        if (cantidadPersonasSelect) {
            cantidadPersonasSelect.addEventListener('change', updatePrecioTotal);
            console.log("Event listener added for #cantidadPersonas change");
        } else {
             console.error("CantidadPersonas select element not found");
        }

        // Listener for "Add to Cart" button in modal
        const addToCartBtn = document.getElementById('addToCartBtn');
        if (addToCartBtn) {
            addToCartBtn.addEventListener('click', addToCart);
            console.log("Event listener added for #addToCartBtn click");
        } else {
             console.error("Add to cart button element not found");
        }

        // Listener for category filters
        document.querySelectorAll('.category-filter').forEach(button => {
            button.addEventListener('click', function() {
                const category = this.getAttribute('data-category');
                console.log("Category filter clicked:", category);

                document.querySelectorAll('.category-filter').forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');

                document.querySelectorAll('.service-card').forEach(card => {
                    if (category === 'all' || card.getAttribute('data-category') === category) {
                        card.style.display = 'block';
                    } else {
                        card.style.display = 'none';
                    }
                });
            });
        });
        console.log("Event listeners added for category filters");

    });
</script>
{% endblock %}
