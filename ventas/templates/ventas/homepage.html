{% extends "ventas/base_public.html" %}
{% load static %}
{% load humanize %}
{% load ventas_extras %}

{% block title %}Aremko Spa Puerto Varas: Masajes, Tinajas y Alojamiento{% endblock %}

{% block meta_description %}
<meta name="description" content="Descubre Aremko, tu spa en Puerto Varas. Ofrecemos masajes relajantes, tinajas calientes privadas y alojamiento confortable en la Región de Los Lagos. ¡Reserva tu escapada!">
<meta name="robots" content="index,follow,max-snippet:-1,max-image-preview:large,max-video-preview:-1">
<meta name="keywords" content="spa Puerto Varas, masajes Puerto Varas, tinajas calientes Puerto Varas, spa parejas Puerto Varas, cabañas Puerto Varas, spa Chile, reservar spa Puerto Varas, masaje relajante, masaje descontracturante, hot tub Puerto Varas, alojamiento con tinajas">
{% endblock %}

{% block meta_og %}
<meta property="og:title" content="Aremko Spa Puerto Varas: Masajes, Tinajas y Alojamiento">
<meta property="og:description" content="Vive la experiencia Aremko: masajes, tinajas calientes y alojamiento en Puerto Varas. Reserva online.">
<meta property="og:type" content="website">
<meta property="og:url" content="{{ canonical_url }}">
<meta property="og:site_name" content="Aremko Spa">
<meta property="og:locale" content="es_CL">
{% if hero_image_url %}<meta property="og:image" content="{{ hero_image_url }}">{% endif %}
{% if hero_image_url %}<meta property="og:image:alt" content="Aremko Spa en Puerto Varas">{% endif %}
<link rel="alternate" hreflang="es-cl" href="{{ canonical_url }}">
<link rel="alternate" hreflang="x-default" href="{{ canonical_url }}">
{% endblock %}

{% block meta_twitter %}
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Aremko Spa Puerto Varas: Masajes, Tinajas y Alojamiento">
<meta name="twitter:description" content="Vive la experiencia Aremko: masajes, tinajas calientes y alojamiento en Puerto Varas. Reserva online.">
{% if hero_image_url %}<meta name="twitter:image" content="{{ hero_image_url }}">{% endif %}
{% endblock %}

{% block structured_data %}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "HealthAndBeautyBusiness",
  "name": "Aremko Spa",
  "url": "{{ canonical_url }}",
  "image": "{{ hero_image_url|default:'' }}",
  "telephone": "+56 9 790 2525",
  "address": {
    "@type": "PostalAddress",
    "streetAddress": "Rio Pescado Km 4",
    "addressLocality": "Puerto Varas",
    "addressCountry": "CL"
  }
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebSite",
  "url": "{{ canonical_url }}",
  "potentialAction": {
    "@type": "SearchAction",
    "target": "https://www.google.com/search?q=site:{{ request.get_host }}+{search_term_string}",
    "query-input": "required name=search_term_string"
  }
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {"@type": "ListItem", "position": 1, "name": "Inicio", "item": "{{ canonical_url }}"}
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": [
    {
      "@type": "Question",
      "name": "¿Cómo reservo un masaje o tinaja en Aremko?",
      "acceptedAnswer": {"@type": "Answer","text": "Selecciona tu servicio, elige fecha y hora en el calendario y confirma tu reserva en línea."}
    },
    {
      "@type": "Question",
      "name": "¿Los precios son por persona o por servicio?",
      "acceptedAnswer": {"@type": "Answer","text": "Los masajes son por persona; algunas experiencias como cabañas tienen precio por servicio."}
    },
    {
      "@type": "Question",
      "name": "¿Puedo reservar para parejas?",
      "acceptedAnswer": {"@type": "Answer","text": "Sí, contamos con experiencias para parejas. Elige la opción correspondiente en la reserva."}
    }
  ]
}
</script>
{% endblock %}

{% block extra_style %}
<style>
/* Homepage specific styles */
/* Category Card Styles */
.category-card { display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; margin: 5px; border: 1px solid #ddd; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; background-color: #f8f9fa; color: var(--dark-gray); width: 150px; height: 150px; text-decoration: none; }
.category-card:hover { transform: translateY(-5px); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); background-color: #e9ecef; }
.category-card.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); }
.category-card.active .category-icon { color: white; }
.category-icon { font-size: 2.5rem; margin-bottom: 15px; color: var(--primary-color); transition: color 0.3s ease; }
.category-name { font-weight: 600; font-size: 1rem; }
.hero-section { background-size: cover; background-position: center; color: white; display: flex; align-items: center; justify-content: center; text-align: center; min-height: 100vh; padding: 60px 20px; margin-bottom: 50px; }
.hero-content { max-width: 600px; margin: 0 auto; text-align: center; }
.hero-content h1 { font-size: 3rem; font-weight: 700; margin-bottom: 20px; }
.hero-content p { font-size: 1.2rem; margin-bottom: 30px; }
.features-section { padding: 80px 0; background-color: white; }
.feature-box { text-align: center; padding: 30px 20px; }
.feature-icon { font-size: 3rem; color: var(--primary-color); margin-bottom: 20px; }
.feature-title { font-weight: 700; margin-bottom: 15px; }
.testimonials-section { padding: 80px 0; background-color: #f8f9fa; }
.testimonial-card { padding: 30px; border-radius: 12px; background-color: white; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); margin-bottom: 30px; }
.testimonial-text { font-style: italic; margin-bottom: 20px; }
.testimonial-author { font-weight: 700; }
.service-card .card-img-top { width: 100%; aspect-ratio: 1 / 1; height: auto !important; object-fit: cover; object-position: center; }
@media (max-width: 768px) { .hero-content h1 { font-size: 2.5rem; } }
.gallery-section { background-color: #f8f9fa; }
.gallery-section .row > div img { transition: transform 0.3s ease; width: 100%; object-fit: cover; object-position: center; display: block; }
.gallery-section .row > div:first-child img { height: 350px; }
.gallery-section .row > div:nth-child(2) img { height: 250px; }
.gallery-section .row > div:last-child img { height: 350px; }
.gallery-section .row > div img:hover { transform: scale(1.05); }
.section-title { text-align: center; font-weight: 700; color: var(--dark-gray); position: relative; padding-bottom: 15px; margin-bottom: 40px; }
.section-title::after { content: ''; position: absolute; display: block; width: 60px; height: 3px; background: var(--primary-color); bottom: 0; left: calc(50% - 30px); }
.service-description-truncated { display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; margin-bottom: 0.25rem; white-space: normal; }
.ver-mas-link { cursor: pointer; display: inline-block; }
</style>
{% endblock %}

{% block content %}

{% include "ventas/sections/hero.html" %}

<section class="container mb-5" id="servicios">
    <h2 class="section-title mb-4">Nuestras Experiencias</h2>
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-center flex-wrap">
                {% for categoria in categorias %}
                    {% include "ventas/components/category_card.html" with categoria=categoria %}
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="row service-list">
        {% for servicio in servicios %}
            {% include "ventas/components/service_card.html" with servicio=servicio %}
        {% endfor %}
    </div>
</section>

{% include "ventas/sections/philosophy.html" %}
{% include "ventas/sections/features.html" %}
{% include "ventas/sections/gallery.html" %}
{% include "ventas/sections/testimonials.html" %}
{% include "ventas/sections/cta.html" %}

{% endblock %}

{% block modals %}
<!-- Booking Modal (Specific to homepage, keep it here) -->
<div class="modal fade" id="bookingModal" tabindex="-1" aria-labelledby="bookingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bookingModalLabel">Reservar Servicio</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="bookingForm" class="booking-form">
                    <input type="hidden" id="servicioId" name="servicio_id">
                    <div class="mb-3">
                        <label for="servicioNombre" class="form-label">Servicio</label>
                        <input type="text" class="form-control" id="servicioNombre" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="fecha" class="form-label">Fecha</label>
                        <input type="text" class="form-control" id="fecha" name="fecha" placeholder="Selecciona una fecha" required>
                    </div>
                    <div class="mb-3">
                        <label for="hora" class="form-label">Hora</label>
                        <select class="form-select" id="hora" name="hora" required>
                            <option value="">Selecciona una hora</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="cantidadPersonas" class="form-label">Cantidad de Personas</label>
                        <select class="form-select" id="cantidadPersonas" name="cantidad_personas"></select>
                    </div>
                    <div class="mb-3">
                        <label for="precioTotal" class="form-label">Precio Total</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="text" class="form-control" id="precioTotal" readonly>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="addToCartBtn">Agregar al Carrito</button>
            </div>
        </div>
    </div>
</div>

<!-- Service Description Modal -->
<div class="modal fade" id="serviceDescriptionModal" tabindex="-1" aria-labelledby="serviceDescriptionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="serviceDescriptionModalLabel">Descripción del Servicio</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="serviceDescriptionModalBody"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_script %}
<script>
    function formatCLP(value) {
      const numberValue = Number(value);
      if (isNaN(numberValue)) { return '0'; }
      return new Intl.NumberFormat('es-CL', { minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(numberValue);
    }

    let currentServicioId = null;
    let currentServicioNombre = null;
    let currentServicioPrecio = 0;
    let currentServicioTipo = 'otro';
    let currentServicioMin = 1;
    let currentServicioMax = 1;

    function loadAvailableHours(servicioId, fecha) {
        const horaSelect = document.getElementById('hora');
        if (!horaSelect) return;
        horaSelect.innerHTML = '<option value="">Cargando horas disponibles...</option>';
        horaSelect.disabled = true;
        fetch(`{% url 'ventas:get_available_hours' %}?servicio_id=${servicioId}&fecha=${fecha}`)
            .then(r => { if (!r.ok) throw new Error(r.status); return r.json(); })
            .then(data => {
                horaSelect.innerHTML = '<option value="">Selecciona una hora</option>';
                if (data.success && data.horas_disponibles.length > 0) {
                    data.horas_disponibles.forEach(hora => {
                        const option = document.createElement('option');
                        option.value = hora; option.textContent = hora; horaSelect.appendChild(option);
                    });
                    horaSelect.disabled = false;
                } else {
                    horaSelect.innerHTML = '<option value="">No hay horas disponibles</option>';
                }
            })
            .catch(() => { horaSelect.innerHTML = '<option value=\"\">Error al cargar horas</option>'; });
    }

    function isCantidadValid() {
        const s = document.getElementById('cantidadPersonas');
        if (!s || s.disabled) return true;
        const v = parseInt(s.value);
        return v >= currentServicioMin && v <= currentServicioMax;
    }

    function validateCantidadPersonas() {
        const s = document.getElementById('cantidadPersonas');
        const btn = document.getElementById('addToCartBtn');
        const parentDiv = s.parentNode; let errorMsg = parentDiv.querySelector('.cantidad-error-msg');
        if (!isCantidadValid()) {
            if (!errorMsg) { errorMsg = document.createElement('small'); errorMsg.className = 'text-danger d-block mt-1 cantidad-error-msg'; parentDiv.appendChild(errorMsg); }
            errorMsg.textContent = currentServicioMin === currentServicioMax ? `Cantidad debe ser ${currentServicioMin}.` : `Cantidad debe estar entre ${currentServicioMin} y ${currentServicioMax}.`;
            errorMsg.style.display = 'block'; btn.disabled = true;
        } else {
            if (errorMsg) errorMsg.style.display = 'none';
            const horaSelect = document.getElementById('hora');
            if (!horaSelect || !horaSelect.value) { btn.disabled = true; } else { validateSelectedSlot(); }
        }
    }

    async function validateSelectedSlot() {
        const servicioId = document.getElementById('servicioId').value;
        const fecha = document.getElementById('fecha').value;
        const hora = document.getElementById('hora').value;
        const btn = document.getElementById('addToCartBtn');
        const horaSelect = document.getElementById('hora');
        const existingWarning = horaSelect.parentNode.querySelector('.text-danger'); if (existingWarning) existingWarning.remove();
        if (!isCantidadValid()) { btn.disabled = true; return; }
        if (!servicioId || !fecha || !hora) { btn.disabled = true; return; }
        btn.disabled = true;
        try {
            const response = await fetch(`{% url 'ventas:check_slot_availability' %}?servicio_id=${servicioId}&fecha=${fecha}&hora=${hora}`);
            if (!response.ok) throw new Error(response.status);
            const data = await response.json();
            if (data.available && isCantidadValid()) { btn.disabled = false; }
            else { btn.disabled = true; const warningMsg = document.createElement('small'); warningMsg.className = 'text-danger d-block mt-1'; warningMsg.textContent = 'Hora no disponible.'; horaSelect.parentNode.appendChild(warningMsg); }
        } catch (e) {
            const warningMsg = document.createElement('small'); warningMsg.className = 'text-danger d-block mt-1'; warningMsg.textContent = 'Error al verificar disponibilidad.'; horaSelect.parentNode.appendChild(warningMsg); btn.disabled = true;
        }
    }

    function updatePrecioTotal() {
        const s = document.getElementById('cantidadPersonas');
        const precioTotalInput = document.getElementById('precioTotal');
        if (s && precioTotalInput) {
            const n = parseInt(s.value); let total = 0;
            total = currentServicioTipo === 'cabana' ? currentServicioPrecio : currentServicioPrecio * n;
            precioTotalInput.value = formatCLP(total);
        }
        validateCantidadPersonas();
        const horaSelect = document.getElementById('hora');
        if (horaSelect && horaSelect.value) validateSelectedSlot(); else { const btn = document.getElementById('addToCartBtn'); if (!isCantidadValid()) btn.disabled = true; }
    }

    function addToCart() {
        const servicioId = document.getElementById('servicioId').value;
        const fecha = document.getElementById('fecha').value;
        const hora = document.getElementById('hora').value;
        const cantidadPersonas = document.getElementById('cantidadPersonas').value;
        if (!fecha) { alert('Por favor selecciona una fecha'); return; }
        if (!hora) { alert('Por favor selecciona una hora'); return; }
        const formData = new FormData();
        formData.append('servicio_id', servicioId);
        formData.append('fecha', fecha);
        formData.append('hora', hora);
        formData.append('cantidad_personas', cantidadPersonas);
        fetch('{% url "ventas:add_to_cart" %}', { method: 'POST', body: formData, headers: { 'X-CSRFToken': getCookie('csrftoken') } })
        .then(response => { if (!response.ok) return response.text().then(text => { throw new Error(`Server responded with ${response.status}: ${text || 'No info'}`); }); if (response.redirected) { window.location.href = response.url; } else { window.location.href = "{% url 'ventas:checkout' %}"; } })
        .catch(error => { alert(`Error al agregar al carrito: ${error.message}. Por favor intenta de nuevo.`); });
    }

    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.js-open-booking-modal').forEach(button => {
            button.addEventListener('click', function() {
                const servicioId = this.dataset.servicioId;
                const servicioNombre = this.dataset.servicioNombre;
                const servicioPrecio = parseFloat(this.dataset.servicioPrecio);
                const servicioTipo = this.dataset.servicioTipo || 'otro';
                const servicioMin = parseInt(this.dataset.servicioMin) || 1;
                const servicioMax = parseInt(this.dataset.servicioMax) || 1;
                currentServicioId = servicioId; currentServicioNombre = servicioNombre; currentServicioPrecio = servicioPrecio; currentServicioTipo = servicioTipo; currentServicioMin = servicioMin; currentServicioMax = servicioMax;
                document.getElementById('servicioId').value = servicioId;
                document.getElementById('servicioNombre').value = servicioNombre;
                document.getElementById('fecha').value = '';
                document.getElementById('hora').innerHTML = '<option value="">Selecciona una hora</option>';
                document.getElementById('hora').disabled = true;
                document.getElementById('addToCartBtn').disabled = true;
                const cantidadPersonasSelect = document.getElementById('cantidadPersonas');
                const cantidadPersonasLabel = document.querySelector('label[for="cantidadPersonas"]');
                const cantidadErrorMsg = cantidadPersonasSelect.parentNode.querySelector('.cantidad-error-msg');
                if (cantidadErrorMsg) cantidadErrorMsg.style.display = 'none';
                cantidadPersonasSelect.innerHTML = '';
                if (servicioTipo !== 'cabana') {
                    for (let i = 1; i <= currentServicioMax; i++) {
                        if (i >= currentServicioMin && i <= currentServicioMax) {
                            const option = document.createElement('option'); option.value = i; option.textContent = `${i} persona${i > 1 ? 's' : ''}`; cantidadPersonasSelect.appendChild(option);
                        }
                    }
                    cantidadPersonasSelect.value = currentServicioMin <= currentServicioMax ? currentServicioMin : (cantidadPersonasSelect.options.length > 0 ? cantidadPersonasSelect.options[0].value : '1');
                    cantidadPersonasSelect.disabled = false;
                    if (cantidadPersonasLabel) cantidadPersonasLabel.style.display = 'block';
                    cantidadPersonasSelect.style.display = 'block';
                } else {
                    const option = document.createElement('option'); option.value = currentServicioMax; option.textContent = `${currentServicioMax} persona${currentServicioMax > 1 ? 's' : ''}`; cantidadPersonasSelect.appendChild(option);
                    cantidadPersonasSelect.value = currentServicioMax; cantidadPersonasSelect.disabled = true; if (cantidadPersonasLabel) cantidadPersonasLabel.style.display = 'none'; cantidadPersonasSelect.style.display = 'none';
                }
                updatePrecioTotal();
                const bookingModalEl = document.getElementById('bookingModal'); if (bookingModalEl) { const bookingModal = new bootstrap.Modal(bookingModalEl); bookingModal.show(); }
            });
        });

        const fechaInput = document.getElementById('fecha');
        if (fechaInput) { flatpickr(fechaInput, { minDate: "today", dateFormat: "Y-m-d", locale: "es", onChange: function(selectedDates, dateStr) { if (currentServicioId) { loadAvailableHours(currentServicioId, dateStr); } } }); }

        const cantidadPersonasSelect = document.getElementById('cantidadPersonas'); if (cantidadPersonasSelect) { cantidadPersonasSelect.addEventListener('change', updatePrecioTotal); }
        const horaSelect = document.getElementById('hora'); if (horaSelect) { horaSelect.addEventListener('change', validateSelectedSlot); }
        const addToCartBtn = document.getElementById('addToCartBtn'); if (addToCartBtn) { addToCartBtn.addEventListener('click', addToCart); }

        function filterServices(targetCategory) {
            document.querySelectorAll('.service-card').forEach(card => {
                const cardCategory = card.getAttribute('data-category');
                card.style.display = (targetCategory === 'all' || cardCategory === targetCategory) ? 'block' : 'none';
            });
        }

        document.querySelectorAll('.category-filter').forEach(cardElement => {
            cardElement.addEventListener('click', function() {
                const categoryId = this.getAttribute('data-category');
                document.querySelectorAll('.category-filter').forEach(card => card.classList.remove('active'));
                this.classList.add('active');
                filterServices(categoryId);
            });
        });

        let defaultCategoryId = null;
        const categoryCards = document.querySelectorAll('.category-filter');
        categoryCards.forEach(card => { const categoryName = card.getAttribute('data-category-name'); if (categoryName && categoryName.toLowerCase().includes('tinas')) { defaultCategoryId = card.getAttribute('data-category'); card.classList.add('active'); } });
        if (defaultCategoryId) { filterServices(defaultCategoryId); } else { filterServices('all'); }

        const serviceDescriptionModalEl = document.getElementById('serviceDescriptionModal');
        if (serviceDescriptionModalEl) {
            serviceDescriptionModalEl.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget; const description = button.getAttribute('data-description'); const title = button.getAttribute('data-title');
                const modalTitle = serviceDescriptionModalEl.querySelector('.modal-title'); const modalBody = serviceDescriptionModalEl.querySelector('.modal-body');
                modalTitle.textContent = title || 'Descripción del Servicio'; modalBody.innerHTML = description || 'No hay descripción disponible.';
            });
        }
    });
</script>
{% endblock %}
