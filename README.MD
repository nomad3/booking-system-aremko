# üèîÔ∏è Aremko Booking System

[![Version](https://img.shields.io/badge/version-1.0-blue.svg)](https://github.com/nomad3/booking-system-aremko)
[![Python](https://img.shields.io/badge/python-3.11+-brightgreen.svg)](https://www.python.org/)
[![Django](https://img.shields.io/badge/django-4.2+-green.svg)](https://www.djangoproject.com/)
[![License](https://img.shields.io/badge/license-Proprietary-red.svg)](LICENSE)

Sistema integral de reservas y gesti√≥n para **Aremko Spa Puerto Varas**, un spa boutique que combina servicios de masajes, tinas calientes (tinajas) y alojamiento en caba√±as con vistas espectaculares al lago y volcanes de la regi√≥n de Los Lagos, Chile.

## Tabla de Contenidos
- [Introducci√≥n](#introducci√≥n)
- [Caracter√≠sticas Principales](#caracter√≠sticas-principales)
  - [Sistema de Reservas](#sistema-de-reservas)
  - [Funcionalidades CRM](#funcionalidades-crm)
  - [Comunicaciones Inteligentes (SMS + Email)](#comunicaciones-inteligentes-sms--email)
  - [Reportes y Exportaciones](#reportes-y-exportaciones)
- [Tecnolog√≠as Utilizadas](#tecnolog√≠as-utilizadas)
- [Prerequisitos](#prerequisitos)
- [Instalaci√≥n Local](#instalaci√≥n-local)
- [Configuraci√≥n de Variables de Entorno](#configuraci√≥n-de-variables-de-entorno)
- [Despliegue (Ej: Render.com)](#despliegue-ej-rendercom)
- [Gesti√≥n de Archivos Est√°ticos](#gesti√≥n-de-archivos-est√°ticos)
- [Creaci√≥n de Superusuario](#creaci√≥n-de-superusuario)
- [Migraciones de Base de Datos](#migraciones-de-base-de-datos)
- [Uso](#uso)
- [Integraciones](#integraciones)
- [API y Automatizaci√≥n](#api-y-automatizaci√≥n)
- [Comandos de Gesti√≥n](#comandos-de-gesti√≥n)
- [Buenas Pr√°cticas](#buenas-pr√°cticas)
- [Recursos Adicionales](#recursos-adicionales)
 - [M√≥dulo IA](#m√≥dulo-ia)
- [Variables de Entorno Clave](#variables-de-entorno-clave)

---

## Introducci√≥n

**Aremko Booking & CRM System** es una aplicaci√≥n web robusta desarrollada con Django, dise√±ada para gestionar eficientemente reservas de servicios y productos, y potenciar la relaci√≥n con los clientes a trav√©s de un m√≥dulo CRM integrado. La aplicaci√≥n est√° preparada para despliegue en plataformas como Render.com utilizando Docker, asegurando escalabilidad y f√°cil mantenimiento.

---

## Caracter√≠sticas Principales

### Sistema de Reservas
- **Gesti√≥n de Servicios y Productos:** Creaci√≥n, edici√≥n y eliminaci√≥n de servicios y productos ofrecidos.
- **Categorizaci√≥n:** Organizaci√≥n de servicios y productos en categor√≠as.
- **Gesti√≥n de Proveedores:** Administraci√≥n de proveedores asociados a servicios.
- **Gesti√≥n de Horarios:** Configuraci√≥n de horarios disponibles para servicios.
- **Capacidad y Duraci√≥n:** Definici√≥n de capacidad m√≠nima/m√°xima y duraci√≥n de los servicios.
- **Reservas Online:** Interfaz p√∫blica para que los clientes realicen reservas.
- **Carrito de Compras:** Funcionalidad de carrito para m√∫ltiples reservas.
- **Checkout y Pagos:** Integraci√≥n con pasarelas de pago (ej: Flow).
- **Gesti√≥n de Ventas:** Seguimiento de ventas y reservas.
- **Gesti√≥n de Caja:** Reportes de caja diaria.
- **Gift Cards:** Emisi√≥n y gesti√≥n de tarjetas de regalo.
- **Precios Din√°micos:** (Si aplica, describir brevemente)

### Funcionalidades CRM
- **Gesti√≥n de Clientes:** Base de datos centralizada de clientes con informaci√≥n detallada (contacto, historial, etc.).
- **Segmentaci√≥n de Clientes:** Creaci√≥n de segmentos de clientes basados en diversos criterios (gasto, visitas, etc.).
- **Gesti√≥n de Campa√±as:**
    - Creaci√≥n y administraci√≥n de campa√±as de marketing y remarketing.
    - Definici√≥n de objetivos (ej: gasto m√≠nimo, visitas m√≠nimas).
    - Plantillas de comunicaci√≥n (Email, SMS - si aplica).
    - Notas de automatizaci√≥n y seguimiento.
- **Gesti√≥n de Interacciones:** Registro de interacciones con clientes asociadas a campa√±as.
- **Modelo de Ventas (Leads, Deals):**
    - Gesti√≥n de Leads (Prospectos).
    - Gesti√≥n de Deals (Oportunidades de Venta).
    - Gesti√≥n de Companies (Empresas).
    - Gesti√≥n de Contacts (Contactos asociados a Empresas/Deals).
- **Gesti√≥n de Actividades:** Seguimiento de actividades relacionadas con contactos, leads o deals (llamadas, reuniones, tareas).
- **Integraciones:** (Mencionar si existen, ej: ManyChat, Google Calendar, N8N para automatizaciones).
- **Reportes CRM:** (Mencionar si existen reportes espec√≠ficos de CRM).

### Comunicaciones Inteligentes (SMS + Email)
- **Confirmaciones de reserva (dual):** Env√≠o autom√°tico de SMS y Email al crear la reserva, con plantilla y datos del servicio/fecha/hora.
- **Recordatorios de cita (24h antes):** Env√≠o autom√°tico (Email + SMS opcional) evitando duplicados.
- **Pago 100% confirmado:** Notificaci√≥n dual cuando la reserva queda pagada al 100%.
- **Encuesta de satisfacci√≥n (D+1):** Email y SMS opcional con link a encuesta y referencia TripAdvisor.
- **Reactivaci√≥n 90 d√≠as:** Email y SMS con Gift Card de CLP $10.000 y control de frecuencia trimestral.
- **Cumplea√±os:** SMS de saludo 1 vez/a√±o por cliente.
- **Newsletter segmentado:** Env√≠o de emails personalizados por segmento (ej. VIP mensual).
- **Anti‚ÄëSpam y preferencias:** L√≠mites por cliente (diario/mensual/semana), horarios preferidos y opt‚Äëout granular por tipo de mensaje.
- **Logs y auditor√≠a:** `CommunicationLog` con estados, costos y trazabilidad por reserva/campa√±a.
- **Plantillas SMS:** `SMSTemplate` con variables din√°micas y activaci√≥n por tipo.

### Reportes y Exportaciones
- **Servicios vendidos:** Filtros por fecha/categor√≠a/venta y exportaci√≥n a Excel.
- **Productos vendidos:** Totales por proveedor/producto y exportaci√≥n a Excel.
- **Caja diaria:** Totales por m√©todo de pago y usuario; vista especial para recepcionistas.
- **Auditor√≠a de movimientos:** Historial filtrable de `MovimientoCliente` con paginaci√≥n.
- **Segmentaci√≥n de clientes:** Tablero por segmentos (nuevo, regular, VIP; bajo/medio/alto gasto) y lista por segmento.

---

## Tecnolog√≠as Utilizadas

- **Backend:** Django 4.2
- **Base de Datos:** PostgreSQL
- **Servidor de Aplicaciones:** Gunicorn
- **Manejo de Archivos Est√°ticos:** WhiteNoise
- **Contenerizaci√≥n:** Docker
- **Frontend:** HTML, CSS, JavaScript (posiblemente con alg√∫n framework como Bootstrap si se usa)
- **APIs/Integraciones:** (Listar las relevantes: Flow, Google Calendar API, ManyChat API, etc.)

---

## Prerequisitos

- [Python 3.9+](https://www.python.org/downloads/)
- [Docker](https://www.docker.com/get-started) & [Docker Compose](https://docs.docker.com/compose/install/)
- [Git](https://git-scm.com/downloads)
- [Cuenta de GitHub](https://github.com/) (para despliegue desde repositorio)
- [Cliente PostgreSQL](https://www.postgresql.org/download/) (para gesti√≥n local)

---

## Instalaci√≥n Local

1.  **Clonar Repositorio:**
    ```bash
    git clone <URL_DEL_REPOSITORIO>
    cd booking-system-aremko # o el nombre del directorio
    ```
2.  **Configurar Variables de Entorno (Local):**
    Crea un archivo `.env` en la ra√≠z del proyecto. Puedes basarte en `README.local.md` o definir las necesarias:
    ```env
    DEBUG=True
    SECRET_KEY='django-insecure-...' # Cambiar por una clave segura
    DATABASE_URL=postgres://user:password@localhost:5432/aremko_db # Ajustar a tu config local
    DJANGO_SUPERUSER_USERNAME=admin
    DJANGO_SUPERUSER_EMAIL=admin@example.com
    DJANGO_SUPERUSER_PASSWORD=password # Cambiar por una contrase√±a segura
    ALLOWED_HOSTS=localhost,127.0.0.1
    # A√±adir otras variables necesarias (APIs, etc.)
    ```
3.  **(Opci√≥n A) Usando Docker Compose (Recomendado):**
    Aseg√∫rate de tener `docker-compose.yml` configurado.
    ```bash
    docker-compose up --build
    ```
    Esto levantar√° la aplicaci√≥n, la base de datos y otros servicios definidos. Las migraciones y la creaci√≥n del superusuario suelen manejarse en el `entrypoint.sh`.

4.  **(Opci√≥n B) Instalaci√≥n Manual:**
    a.  **Crear y Activar Entorno Virtual:**
        ```bash
        python -m venv venv
        source venv/bin/activate  # Linux/macOS
        # venv\Scripts\activate    # Windows
        ```
    b.  **Instalar Dependencias:**
        ```bash
        pip install -r requirements.txt
        ```
    c.  **Configurar Base de Datos Local:**
        Aseg√∫rate de tener PostgreSQL corriendo y crea la base de datos especificada en `DATABASE_URL`.
    d.  **Aplicar Migraciones:**
        ```bash
        python manage.py migrate
        ```
    e.  **Crear Superusuario (si no se usa entrypoint):**
        ```bash
        python manage.py createsuperuser
        ```
    f.  **Recolectar Est√°ticos:**
        ```bash
        python manage.py collectstatic --noinput
        ```
    g.  **Iniciar Servidor:**
        ```bash
        python manage.py runserver
        ```
        Accede a `http://localhost:8000/` o `http://localhost:8000/admin/`.

---

## Configuraci√≥n de Variables de Entorno

Es crucial configurar correctamente las variables de entorno tanto para desarrollo local como para producci√≥n. Las variables clave incluyen:

- `DEBUG`: `True` para desarrollo, `False` para producci√≥n.
- `SECRET_KEY`: Clave secreta √∫nica y segura para Django.
- `DATABASE_URL`: URL de conexi√≥n a la base de datos PostgreSQL.
- `ALLOWED_HOSTS`: Lista de dominios permitidos para servir la aplicaci√≥n.
- `DJANGO_SUPERUSER_USERNAME`, `DJANGO_SUPERUSER_EMAIL`, `DJANGO_SUPERUSER_PASSWORD`: Credenciales para la creaci√≥n autom√°tica del superusuario (usado en `entrypoint.sh`).
- **Claves de APIs:** Para servicios externos como Flow, Google Calendar, ManyChat, etc.
- **Otras configuraciones:** Cualquier otra variable espec√≠fica de la aplicaci√≥n.

*Gestiona estas variables de forma segura, especialmente en producci√≥n (ej: usando secretos de la plataforma de despliegue).*

---

## Despliegue (Ej: Render.com)

1.  **Preparar Repositorio:** Aseg√∫rate de que `Dockerfile`, `docker-compose.yml` (si aplica), `entrypoint.sh`, y `requirements.txt` est√©n actualizados y en el repositorio.
2.  **Crear Servicio en Render:**
    - Conecta tu repositorio GitHub/GitLab.
    - Elige "Web Service".
    - Configura el entorno como "Docker".
    - Render detectar√° el `Dockerfile`.
3.  **Configurar Variables de Entorno:** A√±ade todas las variables necesarias en la secci√≥n "Environment" de Render, asegur√°ndote de que `DEBUG=False` y usando la `DATABASE_URL` proporcionada por Render (o tu base de datos externa).
4.  **Configurar Comando de Build/Start:** Render usar√° los comandos del `Dockerfile` (`CMD` o `ENTRYPOINT`). Aseg√∫rate que `entrypoint.sh` ejecute las migraciones, recolecci√≥n de est√°ticos y Gunicorn.
5.  **Desplegar:** Inicia el despliegue. Render construir√° la imagen Docker y lanzar√° el servicio. Monitorea los logs.

---

## Gesti√≥n de Archivos Est√°ticos

Se utiliza **WhiteNoise** para servir archivos est√°ticos eficientemente en producci√≥n.

- **Configuraci√≥n (`settings.py`):**
  ```python
  MIDDLEWARE = [
      'django.middleware.security.SecurityMiddleware',
      'whitenoise.middleware.WhiteNoiseMiddleware', # Debe ir despu√©s de SecurityMiddleware
      # ... otros middleware ...
  ]
  STATIC_URL = '/static/'
  STATIC_ROOT = BASE_DIR / 'staticfiles' # Usando pathlib
  STATICFILES_STORAGE = 'whitenoise.storage.CompressedManifestStaticFilesStorage'
  ```
- **Recolecci√≥n:** El comando `python manage.py collectstatic --noinput` (generalmente en `entrypoint.sh`) recolecta todos los archivos est√°ticos en el directorio `STATIC_ROOT`.

---

## Creaci√≥n de Superusuario

La creaci√≥n del superusuario se automatiza en `entrypoint.sh` usando las variables de entorno `DJANGO_SUPERUSER_USERNAME`, `DJANGO_SUPERUSER_EMAIL`, y `DJANGO_SUPERUSER_PASSWORD`. Esto es √∫til para entornos donde no hay acceso directo a la shell (como planes gratuitos de PaaS).

```bash
# Parte relevante en entrypoint.sh
echo "Creando superusuario si no existe..."
python manage.py shell <<EOF
# ... (c√≥digo para crear superusuario basado en variables de entorno) ...
EOF
```
*Aseg√∫rate de que este script maneje el caso donde el usuario ya existe.*

---

## Migraciones de Base de Datos

Las migraciones de Django son esenciales para mantener la estructura de la base de datos sincronizada con los modelos.

1.  **Crear Migraciones:** Cuando cambies los modelos (`models.py`):
    ```bash
    python manage.py makemigrations <nombre_app> # ej: ventas
    ```
2.  **Aplicar Migraciones (Local):**
    ```bash
    python manage.py migrate
    ```
3.  **Commit y Push:** A√±ade los archivos de migraci√≥n generados al control de versiones (`git add`, `git commit`, `git push`).
4.  **Aplicar en Producci√≥n:** El script `entrypoint.sh` debe incluir `python manage.py migrate` para aplicar las migraciones autom√°ticamente durante el despliegue.

---

## Uso

- **Panel de Administraci√≥n:** `https://<tu_dominio>/admin/` (Gestiona productos, servicios, clientes, campa√±as, etc.)
- **Interfaz P√∫blica:** `https://<tu_dominio>/` (Portal para clientes, reservas)
- **Reportes:**
  - `https://<tu_dominio>/servicios-vendidos/`
  - `https://<tu_dominio>/productos-vendidos/`
  - `https://<tu_dominio>/caja-diaria/` y `.../caja-diaria-recepcionistas/`
  - `https://<tu_dominio>/auditoria-movimientos/`
  - `https://<tu_dominio>/reportes/segmentacion-clientes/` y `.../<segment_name>/`
- **API Endpoints (DRF base):** `https://<tu_dominio>/` + router (ver secci√≥n API y Automatizaci√≥n)

---

## Integraciones

- **Flow.cl (Pagos):** Creaci√≥n de √≥rdenes, webhook de confirmaci√≥n y p√°gina de retorno. Al confirmar pago (status=2) se crea `Pago` y se actualiza `VentaReserva`.
- **Redvoiss (SMS):** Env√≠o individual y masivo, mensajes con respuesta, consulta de estado de lote y respuestas. Limpieza/validaci√≥n de tel√©fonos chilenos.
- **Google Calendar:** Creaci√≥n de eventos en calendario a partir de reservas.
- **ManyChat:** Punto de integraci√≥n preparado para notificaciones de reserva.
- **n8n/Automatizaci√≥n:** Endpoints para obtener targets de campa√±a y registrar actividades/interacciones externas.

---

## API y Automatizaci√≥n

- **Router DRF:**
  - `api/proveedores`, `api/categorias`, `api/productos`, `api/ventasreservas`, `api/pagos`, `api/clientes`, `api/servicios`, `api/categorias-servicio`, `api/reservaproductos`, `api/reservaservicios`.
- **B√∫squeda/Utilidades:**
  - `api/get-client-details/?telefono=<numero>`
- **Pagos Flow:**
  - `api/flow/create/` (POST) ‚Äî inicia pago.
  - `payment/confirmation/` (POST webhook) ‚Äî confirma pago.
  - `payment/return/` (GET) ‚Äî retorno usuario.
- **Remarketing/Automaci√≥n (proteger con `X-API-KEY`):**
  - `api/campaigns/<id>/details/` (GET)
  - `api/campaigns/<id>/targets/` (GET)
  - `api/activities/log/` (POST)
  - `api/interactions/log/` (POST)

---

## Comandos de Gesti√≥n

- `python manage.py create_default_sms_templates` ‚Äî Crea plantillas base de SMS.
- `python manage.py send_communication_triggers` ‚Äî Ejecuta tareas programadas (recordatorios, encuestas, cumplea√±os, reactivaci√≥n, newsletter VIP).
- `python manage.py normalize_and_merge_clients` ‚Äî Normaliza/mergea clientes desde fuentes externas.
- `python manage.py test_redvoiss` ‚Äî Pruebas de conectividad/flujo con Redvoiss.

---

## Buenas Pr√°cticas

- **Seguridad:** `DEBUG=False` en producci√≥n, `ALLOWED_HOSTS` restrictivo, gesti√≥n segura de `SECRET_KEY` y claves API.
- **Archivos Media:** Para archivos subidos por usuarios (ej: im√°genes de servicios), considera usar almacenamiento externo como AWS S3, Google Cloud Storage, etc., configurando `DEFAULT_FILE_STORAGE`.
- **Monitorizaci√≥n:** Integra herramientas como Sentry para seguimiento de errores.
- **Logs:** Revisa los logs de la aplicaci√≥n y del servidor regularmente.
- **Backups:** Asegura backups regulares de la base de datos.
- **Pruebas:** Implementa pruebas unitarias e de integraci√≥n.

---

## Recursos Adicionales

- [Documentaci√≥n de Django](https://docs.djangoproject.com/en/4.2/)
- [Documentaci√≥n de Docker](https://docs.docker.com/)
- [Documentaci√≥n de Render.com](https://render.com/docs)
- [WhiteNoise Documentation](http://whitenoise.evans.io/en/stable/)
- [Gunicorn Documentation](https://docs.gunicorn.org/en/stable/)

now you can create the helm chart with the provided instructions.

---

## M√≥dulo IA

Consulta el dise√±o funcional y t√©cnico del M√≥dulo IA (Fase 1: Chat IA de negocio, Recomendaciones por cliente y Copiloto de campa√±as) en el documento dedicado:

- `docs/modulo_ia.md`

Este m√≥dulo est√° planificado para a√±adir capacidades de an√°lisis, personalizaci√≥n y apoyo a marketing, con foco en seguridad (solo lectura para consultas) y control de costos.

---

## Variables de Entorno Clave

- **SMS/Email (Anti‚ÄëSpam y Preferencias):**
  - `COMMUNICATION_SMS_ENABLED=true`
  - `SMS_DAILY_LIMIT_PER_CLIENT=2`, `SMS_MONTHLY_LIMIT_PER_CLIENT=8`
  - `EMAIL_WEEKLY_LIMIT_PER_CLIENT=1`, `EMAIL_MONTHLY_LIMIT_PER_CLIENT=4`
  - `SURVEY_PUBLIC_BASE_URL`, `TRIPADVISOR_URL`
- **Redvoiss:**
  - `REDVOISS_API_URL`, `REDVOISS_USERNAME`, `REDVOISS_PASSWORD`
- **Flow:**
  - `FLOW_API_KEY`, `FLOW_SECRET_KEY`, `FLOW_CREATE_API_URL`, `FLOW_STATUS_API_URL`, `FLOW_CONFIRMATION_URL`, `FLOW_RETURN_URL`
- **Automatizaci√≥n:**
  - `AUTOMATION_API_KEY` (protege endpoints n8n)
- **IA (si aplica):** ver secci√≥n `M√≥dulo IA` para `DEEPSEEK_API_KEY` y l√≠mites de costo.
