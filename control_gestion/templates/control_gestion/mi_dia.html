{% extends "control_gestion/base_control.html" %}

{% block title %}Mi D√≠a{% endblock %}

{% block extra_head %}
<style>
    .task-card {
        background: white;
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 8px;
        border-left: 4px solid #3498db;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .task-card.priority-high {
        border-left-color: #e74c3c;
        background: #fff5f5;
    }
    
    .task-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 15px;
    }
    
    .task-title {
        font-size: 18px;
        font-weight: 600;
        color: #2c3e50;
        flex: 1;
    }
    
    .task-meta {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-bottom: 15px;
    }
    
    .badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
    }
    
    .badge-swimlane {
        background: #3498db;
        color: white;
    }
    
    .badge-state {
        background: #95a5a6;
        color: white;
    }
    
    .badge-state.in-progress {
        background: #f39c12;
    }
    
    .badge-state.blocked {
        background: #e74c3c;
    }
    
    .badge-priority {
        background: #e74c3c;
        color: white;
    }
    
    .task-description {
        color: #7f8c8d;
        margin-bottom: 15px;
        white-space: pre-wrap;
    }
    
    .task-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }
    
    .btn-action {
        padding: 8px 16px;
        border-radius: 6px;
        text-decoration: none;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
    }
    
    .btn-action:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .btn-primary {
        background: #3498db;
        color: white;
    }
    
    .btn-primary:hover {
        background: #2980b9;
    }
    
    .btn-success {
        background: #27ae60;
        color: white;
    }
    
    .btn-success:hover {
        background: #229954;
    }
    
    .btn-warning {
        background: #f39c12;
        color: white;
    }
    
    .btn-warning:hover {
        background: #e67e22;
    }
    
    .btn-secondary {
        background: #95a5a6;
        color: white;
    }
    
    .btn-secondary:hover {
        background: #7f8c8d;
    }
    
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        background: white;
        border-radius: 8px;
    }
    
    .empty-state h2 {
        color: #27ae60;
        font-size: 32px;
        margin-bottom: 10px;
    }
    
    .stats {
        background: #ecf0f1;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 30px;
    }
    
    .btn-cambiar-estado {
        cursor: pointer;
    }
    
    .btn-cambiar-estado:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
    
    .loading {
        opacity: 0.6;
        pointer-events: none;
    }
    
    .toast {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        z-index: 1000;
        animation: slideIn 0.3s ease;
    }
    
    .toast.success {
        background: #27ae60;
    }
    
    .toast.error {
        background: #e74c3c;
    }
    
    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
</style>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Manejar clicks en botones de cambiar estado
    document.querySelectorAll('.btn-cambiar-estado').forEach(btn => {
        btn.addEventListener('click', function() {
            const taskId = this.dataset.taskId;
            const nuevoEstado = this.dataset.nuevoEstado;
            const estadoActual = this.dataset.estadoActual;
            
            // Confirmaci√≥n seg√∫n el estado
            let mensaje = '';
            if (nuevoEstado === 'IN_PROGRESS') {
                mensaje = '¬øMarcar esta tarea como EN CURSO?';
            } else if (nuevoEstado === 'DONE') {
                mensaje = '¬øMarcar esta tarea como COMPLETADA?';
            } else if (nuevoEstado === 'BLOCKED') {
                mensaje = '¬øBloquear esta tarea?';
            }
            
            if (!confirm(mensaje)) {
                return;
            }
            
            // Deshabilitar bot√≥n y mostrar loading
            this.disabled = true;
            this.textContent = '‚è≥ Procesando...';
            
            // Obtener CSRF token
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            
            const csrftoken = getCookie('csrftoken');
            
            // Llamar a la API
            fetch(`/control_gestion/tarea/${taskId}/cambiar-estado/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({
                    nuevo_estado: nuevoEstado
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.ok) {
                    // Mostrar mensaje de √©xito
                    mostrarToast(data.mensaje, 'success');
                    
                    // Recargar p√°gina despu√©s de 1 segundo
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    mostrarToast('Error: ' + data.error, 'error');
                    this.disabled = false;
                    // Restaurar texto original
                    if (nuevoEstado === 'IN_PROGRESS') {
                        this.textContent = estadoActual === 'BLOCKED' ? '‚ñ∂Ô∏è Reanudar' : '‚ñ∂Ô∏è Iniciar';
                    } else if (nuevoEstado === 'DONE') {
                        this.textContent = '‚úÖ Completar';
                    } else if (nuevoEstado === 'BLOCKED') {
                        this.textContent = 'üö´ Bloquear';
                    }
                }
            })
            .catch(error => {
                mostrarToast('Error de conexi√≥n', 'error');
                this.disabled = false;
                if (nuevoEstado === 'IN_PROGRESS') {
                    this.textContent = estadoActual === 'BLOCKED' ? '‚ñ∂Ô∏è Reanudar' : '‚ñ∂Ô∏è Iniciar';
                } else if (nuevoEstado === 'DONE') {
                    this.textContent = '‚úÖ Completar';
                } else if (nuevoEstado === 'BLOCKED') {
                    this.textContent = 'üö´ Bloquear';
                }
            });
        });
    });
    
    function mostrarToast(mensaje, tipo) {
        // Remover toast anterior si existe
        const toastAnterior = document.querySelector('.toast');
        if (toastAnterior) {
            toastAnterior.remove();
        }
        
        // Crear nuevo toast
        const toast = document.createElement('div');
        toast.className = `toast ${tipo}`;
        toast.textContent = mensaje;
        document.body.appendChild(toast);
        
        // Remover despu√©s de 3 segundos
        setTimeout(() => {
            toast.remove();
        }, 3000);
    }
});
</script>
{% endblock %}

{% block content %}
<h2 style="margin-bottom: 20px;">üìÖ Mis Tareas del D√≠a</h2>

<div class="stats">
    <strong>Total de tareas pendientes:</strong> {{ total_pending }}
    <span style="margin-left: 20px; color: #7f8c8d;">Mostrando top 3</span>
</div>

{% if tasks %}
    {% for task in tasks %}
    <div class="task-card {% if task.priority == 'ALTA' %}priority-high{% endif %}">
        <div class="task-header">
            <div class="task-title">{{ task.title }}</div>
        </div>
        
        <div class="task-meta">
            <span class="badge badge-swimlane">{{ task.get_swimlane_display }}</span>
            <span class="badge badge-state {% if task.state == 'IN_PROGRESS' %}in-progress{% elif task.state == 'BLOCKED' %}blocked{% endif %}">
                {{ task.get_state_display }}
            </span>
            {% if task.priority == 'ALTA' %}
            <span class="badge badge-priority">üî• ALTA PRIORIDAD</span>
            {% endif %}
            {% if task.promise_due_at %}
            <span class="badge" style="background: #9b59b6; color: white;">
                üìÖ Promesa: {{ task.promise_due_at|date:"d/m H:i" }}
            </span>
            {% endif %}
            {% if task.reservation_id %}
            <span class="badge" style="background: #16a085; color: white;">
                üé´ Reserva #{{ task.reservation_id }}
            </span>
            {% endif %}
        </div>
        
        <div class="task-description">
            {{ task.description|truncatewords:50 }}
        </div>
        
        <div class="task-actions">
            <a href="/admin/control_gestion/task/{{ task.id }}/change/" class="btn-action btn-primary">üìù Ver Detalles</a>
            
            {% if task.state == 'BACKLOG' %}
            <button 
                class="btn-action btn-warning btn-cambiar-estado" 
                data-task-id="{{ task.id }}"
                data-nuevo-estado="IN_PROGRESS"
                data-estado-actual="BACKLOG">
                ‚ñ∂Ô∏è Iniciar
            </button>
            {% elif task.state == 'IN_PROGRESS' %}
            <button 
                class="btn-action btn-success btn-cambiar-estado" 
                data-task-id="{{ task.id }}"
                data-nuevo-estado="DONE"
                data-estado-actual="IN_PROGRESS">
                ‚úÖ Completar
            </button>
            <button 
                class="btn-action btn-cambiar-estado" 
                style="background: #e74c3c; color: white;"
                data-task-id="{{ task.id }}"
                data-nuevo-estado="BLOCKED"
                data-estado-actual="IN_PROGRESS">
                üö´ Bloquear
            </button>
            {% elif task.state == 'BLOCKED' %}
            <button 
                class="btn-action btn-warning btn-cambiar-estado" 
                data-task-id="{{ task.id }}"
                data-nuevo-estado="IN_PROGRESS"
                data-estado-actual="BLOCKED">
                ‚ñ∂Ô∏è Reanudar
            </button>
            {% endif %}
            
            <a href="/admin/control_gestion/task/?owner__id__exact={{ user.id }}" class="btn-action btn-secondary">üìã Ver Todas</a>
        </div>
    </div>
    {% endfor %}
    
    <div style="text-align: center; margin-top: 30px;">
        <a href="/admin/control_gestion/task/?owner__id__exact={{ user.id }}" class="btn">Ver Todas Mis Tareas ({{ total_pending}})</a>
    </div>
{% else %}
    <div class="empty-state">
        <h2>‚úÖ</h2>
        <h3>¬°Sin tareas pendientes!</h3>
        <p style="color: #7f8c8d; margin-top: 10px;">Buen trabajo. Disfruta tu d√≠a üéâ</p>
    </div>
{% endif %}
{% endblock %}

